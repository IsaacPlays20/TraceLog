<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeoJournal v18.0 | GPS Record</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --sidebar: 320px; 
            --primary: #2563eb; 
            --accent: #10b981;
            --danger: #ef4444;
            --bg: #f8fafc; 
            --card: rgba(255, 255, 255, 0.9); 
            --text: #0f172a; 
            --border: #e2e8f0;
            --transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dark-theme { 
            --bg: #0f172a; 
            --card: rgba(30, 41, 59, 0.9); 
            --text: #f1f5f9; 
            --border: #334155; 
        }

        body, html { 
            margin: 0; padding: 0; height: 100%; 
            font-family: 'Inter', sans-serif; overflow: hidden; 
            background: var(--bg); color: var(--text); 
            touch-action: none;
        }

        #app { display: flex; height: 100vh; position: relative; width: 100vw; }

        #sidebar { 
            position: absolute; left: 0; top: 0; width: var(--sidebar); 
            background: var(--card); backdrop-filter: blur(10px);
            border-right: 1px solid var(--border); display: flex; 
            flex-direction: column; z-index: 2000; height: 100vh; 
            box-sizing: border-box; transition: transform var(--transition), opacity var(--transition), height var(--transition), top var(--transition);
            box-shadow: 10px 0 30px rgba(0,0,0,0.05);
        }

        body.mobile-mode #sidebar {
            width: 100vw;
            height: 100vh;
            max-height: calc(100% - 6vh); 
            top: calc(100vh - 110px); 
            left: 0;
            border-right: none;
            border-top: 1px solid var(--border);
            border-radius: 25px 25px 0 0;
            transform: none !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            padding-bottom: env(safe-area-inset-bottom);
            touch-action: pan-y;
        }

        body.mobile-mode #sidebar.open { top: 6vh; }
        body.mobile-mode #sidebar.half { top: 50vh; }
        body.mobile-mode #sidebar.hidden-sheet { top: 100vh !important; }
        body.mobile-mode #expandBtn { display: none !important; }

        .drag-handle {
            width: 60px; height: 7px; background: var(--border);
            border-radius: 10px; margin: 15px auto 10px auto;
            flex-shrink: 0; cursor: pointer;
            transition: background 0.2s;
            display: none;
        }
        .drag-handle:hover { background: #cbd5e1; }
        body.mobile-mode .drag-handle { display: block; }

        #sidebar.minimized { transform: translateX(-100%); opacity: 0; pointer-events: none; }
        .sidebar-header { padding: 20px 20px 0 20px; flex-shrink: 0; position: relative; }
        body.mobile-mode .sidebar-header { padding-top: 0; }
        .logo-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; gap: 8px; }

        .icon-btn, .tab-btn, .filter-btn, .btn, .zoom-btn, .layer-item-btn, .elev-toggle-btn {
            background: var(--border); border: none; min-width: 34px; height: 34px; 
            border-radius: 10px; cursor: pointer; display: flex; align-items: center; 
            justify-content: center; color: var(--text); font-size: 14px; transition: 0.2s;
            flex-shrink: 0; font-family: 'Inter', sans-serif; font-weight: 700;
            padding: 0 10px; text-transform: uppercase;
        }

        .icon-btn:hover, .tab-btn:hover, .filter-btn:hover, .btn:hover, .zoom-btn:hover, .layer-item-btn:hover, .elev-toggle-btn:hover { 
            background: var(--primary); color: white; transform: scale(1.05); 
        }

        .tab-btn.active, .btn-main.active-mode, .layer-item-btn.active {
            background: var(--primary); color: white; opacity: 1;
        }

        .icon-btn, .zoom-btn { width: 34px; height: 34px; padding: 0; font-size: 18px; border-radius: 10px; }
        #backBtn { display: none; font-size: 20px; }

        #expandBtn {
            position: absolute; top: 20px; left: 20px; z-index: 1900; 
            display: none; background: var(--card); border: 1px solid var(--border);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); backdrop-filter: blur(10px);
        }

        #mainSearch {
            width:100%; padding:12px; border-radius:8px; border:1px solid var(--border); 
            background:var(--bg); color:var(--text); box-sizing:border-box; margin-bottom:15px;
        }

        .tab-nav { display: flex; gap: 8px; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .tab-btn { flex: 1; font-size: 10px; opacity: 0.6; }

        .sidebar-scroll-area { 
            flex: 1; overflow-y: auto; padding: 0 20px; margin: 0; 
            display: flex; flex-direction: column; 
            -webkit-overflow-scrolling: touch;
        }
        .sidebar-scroll-area::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        .scroll-spacer { height: 450px; flex-shrink: 0; pointer-events: none; }

        #map { width: 100vw; height: 100vh; z-index: 1; }

        .pin-wrapper { width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; }
        .pin-shape {
            width: 20px; height: 20px; border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg); border: 2px solid white;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.2), 0 4px 8px rgba(0,0,0,0.3); z-index: 500;
        }

        /* PIN TYPE GRID & BUTTONS */
        .pin-type-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 10px 0; }
        .type-btn {
            aspect-ratio: 1/1; border-radius: 12px; border: none; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: 0.2s; color: white; padding: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .type-btn:hover { transform: scale(1.05); filter: brightness(1.1); }
        .type-btn.active { outline: 3px solid var(--text); outline-offset: 2px; transform: scale(1.05); }
        .type-btn span { font-size: 8px; font-weight: 900; text-transform: uppercase; margin-top: 2px; }

        .settings-container { display: flex; flex-direction: column; gap: 8px; padding-top: 10px; }
        .settings-row-refined { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 16px; background: rgba(0,0,0,0.03); border-radius: 12px; border: 1px solid var(--border);
            gap: 10px;
        }
        .settings-header {
            width: 100%; height: 40px; border: none; background: transparent;
            color: var(--text); font-weight: 800; font-size: 12px; 
            cursor: pointer; display: flex; align-items: center; justify-content: space-between; 
            padding: 0 5px; transition: 0.2s; text-transform: uppercase;
            border-bottom: 1px solid var(--border); margin-bottom: 10px; margin-top: 5px;
        }
        .settings-header:hover { opacity: 0.7; }
        .settings-content { display: flex; flex-direction: column; gap: 8px; margin-bottom: 5px; }
        .settings-label { font-size: 13px; font-weight: 600; opacity: 0.9; }

        .switch { position: relative; display: inline-block; width: 42px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; position: absolute; appearance: none; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #cbd5e1; transition: .3s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }

        .detail-header-container { position: relative; border-radius: 12px; overflow: hidden; margin-bottom: 12px; height: 180px; background: #ddd; flex-shrink: 0; }
        #detPhoto { width: 100%; height: 100%; object-fit: cover; display: block; }

        #detRating, .floating-action-btn { 
            position: absolute; background: rgba(15, 23, 42, 0.7); 
            backdrop-filter: blur(8px); padding: 6px 12px; border-radius: 8px;
            color: #fbbf24; font-size: 1rem; display: flex; gap: 3px; z-index: 10; border: 1px solid rgba(255,255,255,0.1);
            transition: 0.2s;
        }

        #detRating { top: 10px; right: 10px; }
        .floating-action-btn { top: 10px; left: 10px; color: white; width: 34px; height: 34px; padding: 0; align-items: center; justify-content: center; cursor: pointer; background: rgba(15, 23, 42, 0.7); border-radius: 10px; }
        #floatEditBtn:hover, #floatEditBtn.is-editing { background: var(--primary); } 
        .floating-action-btn.btn-delete-float { left: 52px; }
        .floating-action-btn.btn-delete-float:hover { background: var(--danger); }
        .btn-save-action { background: var(--border); color: var(--text); }
        .btn-save-action:hover { background: var(--accent) !important; color: white !important; }
        .floating-action-btn.btn-upload-float { left: 94px; }
        .floating-action-btn.btn-upload-float:hover { background: var(--accent); }

        .image-scrim { 
            position: absolute; bottom: 0; left: 0; right: 0; min-height: 40%; 
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%); 
            display: flex; align-items: flex-end; padding: 10px 15px; pointer-events: none;
        }

        #editTitle { 
            font-size: 1.4rem; font-weight: 900; color: white; background: transparent; 
            border: none; width: 100%; padding: 0; margin: 0; line-height: 1.1;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5); resize: none; overflow: hidden; pointer-events: none;
        }
        #editTitle.active { color: var(--text); background: var(--bg); border: 1px solid var(--border); padding: 5px; border-radius: 6px; text-shadow: none; pointer-events: auto; }

        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 5px 0 10px 0; }
        .stat-card { background: rgba(0,0,0,0.04); padding: 12px; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 4px; }
        .stat-card-dual { grid-column: span 2; background: rgba(0,0,0,0.04); padding: 12px; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px; }
        .dual-row { display: flex; justify-content: space-between; align-items: center; }
        .dual-divider { height: 1px; background: var(--border); width: 100%; opacity: 0.5; }
        .stat-label { font-size: 9px; font-weight: 800; text-transform: uppercase; opacity: 0.5; letter-spacing: 0.5px; }
        .stat-value { font-size: 13px; font-weight: 700; color: var(--text); }
        .stat-sub-label { font-size: 10px; font-weight: 600; opacity: 0.7; }
        .stat-sub-value { font-size: 12px; font-weight: 800; color: var(--text); }

        /* REWORKED FILTER STYLES */
        .filter-container { margin-bottom: 15px; display: flex; flex-direction: column; gap: 6px; }
        
        .filter-section { 
            display: flex; flex-direction: column; 
            background: var(--card); border: 1px solid var(--border); 
            border-radius: 16px; overflow: hidden;
        }

        .toggle-btn-main { 
            width: 100%; height: 40px; border: none; background: transparent;
            color: var(--text); font-weight: 800; font-size: 12px; 
            cursor: pointer; display: flex; align-items: center; justify-content: space-between; 
            padding: 0 18px; transition: 0.2s; text-transform: uppercase;
        }
        .toggle-btn-main:hover { background: rgba(0,0,0,0.02); }
        .toggle-btn-main.active { background: var(--card); color: var(--text); box-shadow: none; border-bottom: 1px solid var(--border); border-radius: 0; }

        .filter-grid-reveal { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; 
            padding: 12px; background: rgba(0,0,0,0.02);
            animation: slideDown 0.2s ease-out;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .sub-toggle-btn {
            width: 100%; height: 65px; border-radius: 12px; border: 1px solid var(--border);
            background: var(--card); color: var(--text); font-size: 9px; font-weight: 800;
            cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px;
            transition: 0.2s; text-transform: uppercase; box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .dark-theme .sub-toggle-btn { background: #1e293b; }
        .sub-toggle-btn:hover { transform: translateY(-2px); border-color: var(--primary); }
        .sub-toggle-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); }
        .sub-toggle-btn .filter-icon { font-size: 24px; line-height: 1; margin-bottom: 2px; }

        .gps-indicator-wrapper { position: relative; width: 14px; height: 14px; display: flex; align-items: center; justify-content: center; }
        .gps-indicator { width: 16px !important; height: 16px !important; background: #2563eb; border: 3px solid white; border-radius: 50% !important; z-index: 2; flex-shrink: 0; aspect-ratio: 1/1; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
        .gps-pulse { position: absolute; width: 45px !important; height: 45px !important; background: rgba(37, 99, 235, 0.6); border: 2px solid rgba(37, 99, 235, 0.8); border-radius: 50% !important; animation: pulse 1.8s ease-out infinite; z-index: 1; flex-shrink: 0; aspect-ratio: 1/1; }
        @keyframes pulse { 0% { transform: scale(0.4); opacity: 1; } 100% { transform: scale(3.5); opacity: 0; } }

        .loc-icon-inner { width: 16px; height: 16px; background: #2563eb; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); }

        .highlight-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 12px; margin-bottom: 8px; cursor: pointer; border: 1px solid var(--border); transition: 0.2s; }
        .highlight-item:hover { background: var(--border); transform: translateY(-2px); }
        .highlight-thumb { width: 48px; height: 48px; border-radius: 8px; object-fit: cover; background: #ddd; flex-shrink: 0; }
        .type-label { font-size: 9px; font-weight: 800; text-transform: uppercase; padding: 2px 5px; color: white; border-radius: 3px; display: inline-block; margin-bottom: 3px; }

        .list-divider { height: 1px; background: var(--border); margin: 15px 0; width: 100%; opacity: 0.5; }
        .filter-btn { height: 40px !important; }

        #detail-view { display: none; flex-direction: column; gap: 8px; }
        .edit-input { width: 100%; background: transparent; border: 1px solid transparent; border-radius: 6px; padding: 2px 5px; color: var(--text); font-family: inherit; box-sizing: border-box; }
        #editDesc { font-size: 1.05rem; line-height: 1.5; opacity: 0.9; pointer-events: none; }
        #editDesc.active { pointer-events: auto; }
        .info-card { background: rgba(0,0,0,0.02); padding: 10px; border-radius: 10px; border: 1px solid var(--border); }

        #explore-panel, #add-panel, #settings-panel, #detail-view { padding-bottom: 20px; }

        .zoom-controls { position: absolute; top: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 8px; transition: top 0.3s ease; }
        .btn { width: 100%; height: 42px; margin-bottom: 10px; font-size: 12px; }

        #elevation-dock { 
            position: absolute; bottom: -450px; left: calc(var(--sidebar) + 20px); 
            right: 20px; height: 260px; background: var(--card); backdrop-filter: blur(10px);
            border-radius: 12px; border: 1px solid var(--border); z-index: 5000; 
            padding: 15px; transition: bottom var(--transition), left var(--transition); 
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column;
        }
        #elevation-dock.active { bottom: 20px; }
        body.mobile-mode #elevation-dock.active { bottom: 120px; left: 10px; right: 10px; height: 220px; }

        #elevContainer { flex: 1; min-height: 0; width: 100%; position: relative; }
        .walk-marker-icon { font-size: 16px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 50 !important; }
        .start-icon { background: #10b981; color: white; }
        .end-icon { background: #ef4444; color: white; }

        #modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); display: none; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(4px); }

        .modal { background: var(--card); padding: 25px; border-radius: 20px; width: 340px; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2); border: 1px solid var(--border); }
        .modal h3 { margin: 0 0 15px 0; font-size: 1.25rem; font-weight: 900; letter-spacing: -0.5px; text-align: center; }
        .modal-inputs { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
        .modal-input { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 12px; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; box-sizing: border-box; font-size: 14px; font-weight: 500; transition: border-color 0.2s; }
        .modal-input:focus { border-color: var(--primary); outline: none; }
        .modal-btns { display: flex; flex-direction: column; gap: 10px; }

        #layer-popup {
            position: absolute; right: 75px; top: 160px; background: var(--card); backdrop-filter: blur(20px);
            border: 1px solid var(--border); padding: 10px; border-radius: 15px; display: none;
            flex-direction: column; gap: 6px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); 
            z-index: 7000 !important;
            transition: top 0.3s;
        }

        .node-handle, .mid-handle { cursor: pointer; z-index: 99999 !important; }
        .node-handle-visible { background: white !important; border: 3px solid var(--primary) !important; border-radius: 50%; box-shadow: 0 0 10px rgba(0,0,0,0.4); opacity: 1 !important; }
        .mid-handle-visible { background: white !important; border: 3px solid var(--accent) !important; border-radius: 50%; box-shadow: 0 0 8px rgba(0,0,0,0.3); opacity: 0.9 !important; }
        .node-handle-hidden { opacity: 0 !important; pointer-events: none; }

        .mode-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 10px; }
        .mode-btn {
            background: rgba(0,0,0,0.03); border: 1px solid var(--border);
            padding: 10px 0; border-radius: 10px; cursor: pointer;
            transition: 0.2s; display: flex; flex-direction: column; align-items: center;
            color: var(--text); height: 52px; justify-content: center;
        }
        .mode-btn span { font-size: 18px; margin-bottom: 1px; line-height: 1; }
        .mode-btn b { font-size: 9px; font-weight: 800; text-transform: uppercase; color: inherit; line-height: 1; }
        
        /* Fixed specific colors for activity mode buttons */
        .mode-btn[data-mode="walk"].active { background: #10b981; color: white !important; }
        .mode-btn[data-mode="hike"].active { background: #d97706; color: white !important; }
        .mode-btn[data-mode="run"].active { background: #ef4444; color: white !important; }
        .mode-btn[data-mode="cycle"].active { background: #3b82f6; color: white !important; }
        .mode-btn.active b { color: white !important; }

        .elev-toggle-btn { 
            grid-column: span 2; width: 100%; height: 44px; margin-top: 5px; 
            text-transform: uppercase; font-size: 12px; gap: 8px;
        }

        /* RECORDING UI POPOUT */
        #recording-popout { 
            display: none; position: fixed; 
            top: 20px; left: calc(var(--sidebar) + 20px); right: 20px;
            background: var(--primary); color: white; padding: 15px; 
            border-radius: 20px; z-index: 9000; flex-direction: column; gap: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: transform 0.3s, top 0.3s;
        }
        body.mobile-mode #recording-popout { left: 10px; right: 10px; top: 10px; }
        
        .hud-stats { display: flex; justify-content: space-between; font-size: 13px; font-weight: 900; text-transform: uppercase; }
        .hud-btns { display: flex; gap: 8px; }
        .hud-btn { 
            flex: 1; background: rgba(255,255,255,0.2); border: none; 
            color: white; padding: 10px; border-radius: 10px; 
            font-weight: 800; cursor: pointer; font-size: 11px;
        }
        .hud-btn.stop { background: var(--danger); }
        .hud-btn.elev-toggle { background: rgba(0,0,0,0.2); }
        
        .elev-minmax { display: flex; justify-content: space-between; font-size: 10px; opacity: 0.9; font-weight: 800; }
        .pulse-red { width: 8px; height: 8px; background: #ff4444; border-radius: 50%; display: inline-block; margin-right: 5px; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }

        .is-flying #map { transition: none !important; }
        .is-flying .zoom-controls { display: none !important; }
        
        #flyoverControls {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            display: none; flex-direction: column; gap: 8px;
            z-index: 9999; width: 300px;
            background: var(--card); backdrop-filter: blur(10px);
            padding: 15px; border-radius: 20px; border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .fly-control-row { display: flex; gap: 10px; align-items: center; }
        .fly-slider-group { flex: 1; display: flex; flex-direction: column; gap: 4px; align-items: center; }
        .fly-slider-group span { font-size: 9px; font-weight: 800; opacity: 0.7; letter-spacing: 0.5px; text-align: center; }
        
        .fly-adjust-group { display: flex; align-items: center; gap: 4px; background: rgba(0,0,0,0.05); padding: 3px; border-radius: 10px; border: 1px solid var(--border); width: 100%; box-sizing: border-box; }
        .fly-adjust-btn { width: 28px; height: 28px; border-radius: 7px; border: none; background: var(--card); color: var(--text); font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: 0.1s; flex-shrink: 0; }
        .fly-adjust-btn:active { transform: scale(0.95); background: var(--border); }
        .fly-val-display { font-size: 11px; font-weight: 800; flex: 1; text-align: center; font-variant-numeric: tabular-nums; }
        
        .fly-btn {
            flex: 1; height: 36px; border-radius: 10px; border: none;
            font-weight: 800; font-size: 11px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: 0.2s; background: var(--border); color: var(--text); text-transform: uppercase;
        }
        .fly-btn:hover { background: var(--primary); color: white; }
        .fly-btn.danger { background: var(--danger); color: white; }
        .fly-btn.danger:hover { background: #dc2626; }
        
        /* Fix map flickering during transform */
        .leaflet-pane, .leaflet-tile, .leaflet-marker-icon, .leaflet-marker-shadow, .leaflet-tile-container, .leaflet-pane > svg, .leaflet-pane > canvas, .leaflet-zoom-box, .leaflet-image-layer, .leaflet-layer {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            transform: translate3d(0,0,0);
            will-change: transform;
        }
        .leaflet-tile {
            outline: 1px solid transparent;
        }

        #auth-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.3); backdrop-filter: blur(2px); z-index: 10000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        
        body.auth-active #sidebar, 
        body.auth-active #expandBtn, 
        body.auth-active .zoom-controls, 
        body.auth-active #recording-popout, 
        body.auth-active #flyoverControls, 
        body.auth-active #elevation-dock,
        body.auth-active #layer-popup { display: none !important; }
        body.auth-active .gps-indicator-wrapper { display: none !important; }

        .custom-pin-marker .pin-shape { transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .custom-pin-marker:hover .pin-shape { transform: rotate(-45deg) scale(1.3); }
        .custom-pin-marker:hover { z-index: 10000 !important; }

        .speed-input-group { display: flex; flex-direction: column; gap: 2px; }

        .comments-section { margin-top: 15px; border-top: 1px solid var(--border); padding-top: 15px; }
        .comment-item { background: rgba(0,0,0,0.02); border-radius: 8px; padding: 10px; margin-bottom: 8px; border: 1px solid var(--border); }
        .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .comment-user { font-size: 12px; font-weight: 700; }
        .comment-date { font-size: 10px; opacity: 0.6; }
        .comment-text { font-size: 13px; margin: 0; line-height: 1.4; }
        .comment-stars { color: #fbbf24; font-size: 11px; letter-spacing: 1px; }
        .new-comment-box { margin-top: 15px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
        .star-input { display: flex; gap: 5px; font-size: 24px; color: #cbd5e1; cursor: pointer; margin-bottom: 10px; }
        .star-input span.active { color: #fbbf24; }
        .comment-actions { display: flex; gap: 10px; margin-top: 5px; justify-content: flex-end; }
        .comment-action-btn { background: none; border: none; font-size: 11px; cursor: pointer; opacity: 0.6; padding: 0; color: var(--text); }
        .comment-action-btn:hover { opacity: 1; text-decoration: underline; }
    </style>
</head>
<body class="light-theme auth-active">

    <div id="app">
        <button id="expandBtn" class="icon-btn" onclick="toggleSidebar()">‚ò∞</button>
        
        <div id="auth-overlay">
            <div class="modal" style="width: 300px; padding: 30px;">
                <h2 style="text-align:center; margin-top:0;">GeoJournal</h2>
                <p style="text-align:center; font-size:12px; opacity:0.7; margin-bottom:20px;">Sign in to view and create maps</p>
                <input type="email" id="authEmail" class="modal-input" placeholder="Email Address" style="margin-bottom:10px;">
                <input type="password" id="authPass" class="modal-input" placeholder="Password" style="margin-bottom:10px;">
                <button class="btn btn-save-action" id="btnLogin" style="margin-bottom:10px;">Log In</button>
                
                <button class="btn" id="btnGoogle" style="margin-bottom:15px; background:white; color:#444; border:1px solid #ccc; display:flex; align-items:center; justify-content:center; gap:10px;">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="width:18px;height:18px;">
                    Sign in with Google
                </button>
                <div style="display:flex; gap:10px; width:100%;">
                    <button class="btn" id="btnSignup" style="flex:1; height:34px; font-size:11px; background:transparent; border:1px solid var(--border);">Sign Up</button>
                    <button class="btn" id="btnForgot" style="flex:1; height:34px; font-size:11px; background:transparent; border:1px solid var(--border);">Forgot Password?</button>
                </div>
                <p id="authMessage" style="color:var(--danger); text-align:center; font-size:12px; margin:0;"></p>
            </div>
        </div>

        <div id="dn-overlay" style="position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); display: none; align-items: center; justify-content: center; z-index: 10001; backdrop-filter: blur(5px);">
            <div class="modal">
                <h3>Welcome!</h3>
                <p style="text-align:center; opacity:0.7; font-size:13px; margin-bottom:15px;">Choose a unique display name for your GeoJournal.</p>
                <input type="text" id="newDisplayName" class="modal-input" placeholder="Display Name" style="margin-bottom:10px;">
                <p id="dnError" style="color:var(--danger); font-size:12px; text-align:center; margin:0 0 10px 0; min-height:15px;"></p>
                <button class="btn btn-save-action" id="saveDNBtn">Get Started</button>
            </div>
        </div>

        <div id="flyoverControls">
            <div class="fly-stats-row" style="display:flex; justify-content:space-between; width:100%; margin-bottom:10px; font-size:11px; font-weight:800; color:var(--text); background:rgba(0,0,0,0.05); padding:8px; border-radius:10px; box-sizing: border-box;">
                <span id="flyStatDist">0.00 km</span>
                <span id="flyStatElev">-- m</span>
                <span id="flyStatTime">00:00</span>
            </div>
            <div class="fly-control-row">
                <div class="fly-slider-group">
                    <span>SPEED</span>
                    <div class="fly-adjust-group">
                        <button class="fly-adjust-btn" onclick="adjustFlySpeed(-0.5)">‚àí</button>
                        <span id="flySpeedDisplay" class="fly-val-display">1.0x</span>
                        <button class="fly-adjust-btn" onclick="adjustFlySpeed(0.5)">+</button>
                    </div>
                </div>
                <div class="fly-slider-group">
                    <span>ZOOM</span>
                    <div class="fly-adjust-group">
                        <button class="fly-adjust-btn" onclick="adjustFlyZoom(-0.5)">‚àí</button>
                        <span id="flyZoomDisplay" class="fly-val-display">17.0</span>
                        <button class="fly-adjust-btn" onclick="adjustFlyZoom(0.5)">+</button>
                    </div>
                </div>
            </div>
            <div class="fly-control-row">
                <button class="fly-btn" onclick="toggleGraph()">üìà GRAPH</button>
                <button class="fly-btn danger" onclick="stopFlyover()">‚èπ EXIT</button>
            </div>
        </div>

        <div id="recording-popout">
            <div class="hud-stats">
                <span><div class="pulse-red"></div><span id="hudTimer">00:00</span></span>
                <span id="hudDist">0.00 km</span>
            </div>
            <div class="elev-minmax">
                <span id="hudMinHeight">MIN: --m</span>
                <span id="hudMaxHeight">MAX: --m</span>
            </div>
            <div class="hud-btns">
                <button class="hud-btn elev-toggle" onclick="toggleGraph()">‚õ∞Ô∏è GRAPH</button>
                <button class="hud-btn" id="hudPausePlay">‚è∏ PAUSE</button>
                <button class="hud-btn stop" id="hudStop">‚èπ END</button>
            </div>
        </div>

        <aside id="sidebar">
            <div class="drag-handle" id="mobileDragHandle"></div>
            <div class="sidebar-header" id="mobileHeader">
                <div class="logo-row">
                    <h2 style="margin: 0; font-weight: 900; letter-spacing: -0.5px;">GeoJournal</h2>
                    <div style="display: flex; gap: 8px;">
                        <button id="backBtn" class="icon-btn" onclick="goBack()">‚ùÆ</button>
                        <button id="minimizeBtn" class="icon-btn" onclick="toggleSidebar()">‚úï</button>
                    </div>
                </div>
                <input type="text" id="mainSearch" placeholder="üîç Search City, Pins, Activities...">
                
                <div class="tab-nav" id="mainTabs">
                    <button class="tab-btn active" id="exploreTab" onclick="switchTab('explore')">EXPLORE</button>
                    <button class="tab-btn" id="addTab" onclick="switchTab('add')">ADD</button>
                    <button class="tab-btn" id="settingsTab" onclick="switchTab('settings')">SETTINGS</button>
                </div>
            </div>

            <div class="sidebar-scroll-area" id="mainScrollArea">
                <div id="explore-panel">
                    <div class="filter-container">
                        <span class="settings-label" style="margin-left:2px; font-size:10px; opacity:0.6; text-transform:uppercase; letter-spacing:0.5px;">Sort By:</span>
                        <div class="filter-row" style="display:flex; gap:6px;">
                            <button class="filter-btn active" onclick="setSort('rating', this)" style="flex:1">‚≠ê RATING</button>
                            <button class="filter-btn" onclick="setSort('dist', this)" style="flex:1">üìç DISTANCE</button>
                        </div>
                        <button class="filter-btn" onclick="toggleMineFilter(this)" style="width:100%; font-weight:800; justify-content:center;">üë§ YOUR JOURNAL</button>

                        <div class="filter-section">
                            <button class="toggle-btn-main" onclick="toggleFilterSection('pinGridReveal', this)" style="width:100%; justify-content: space-between; padding: 0 15px;"><span>üìç Pins</span> <span class="chevron" style="opacity:0.5; font-size:10px; transition:0.3s;">‚ñº</span></button>
                            <div class="filter-grid-reveal" id="pinGridReveal" style="display:none;"></div>
                        </div>

                        <div class="filter-section">
                            <button class="toggle-btn-main" onclick="toggleFilterSection('activityGridReveal', this)" style="width:100%; justify-content: space-between; padding: 0 15px;"><span>üèÉ Activities</span> <span class="chevron" style="opacity:0.5; font-size:10px; transition:0.3s;">‚ñº</span></button>
                            <div class="filter-grid-reveal" id="activityGridReveal" style="display:none;">
                                <button class="sub-toggle-btn active" data-type="walk" onclick="toggleSubFilter(this, 'activity')"><span class="filter-icon">üö∂</span>Walk</button>
                                <button class="sub-toggle-btn active" data-type="hike" onclick="toggleSubFilter(this, 'activity')"><span class="filter-icon">ü•æ</span>Hike</button>
                                <button class="sub-toggle-btn active" data-type="run" onclick="toggleSubFilter(this, 'activity')"><span class="filter-icon">‚ö°</span>Run</button>
                                <button class="sub-toggle-btn active" data-type="cycle" onclick="toggleSubFilter(this, 'activity')"><span class="filter-icon">üö≤</span>Cycle</button>
                            </div>
                        </div>
                    </div>
                    <div class="list-divider"></div>
                    
                    <div id="highlights-list"></div>
                    <div class="scroll-spacer"></div>
                </div>

                <div id="add-panel" style="display:none;">
                    <button id="pinModeBtn" class="btn btn-main">üìç Drop a Pin</button>
                    <button id="walkModeBtn" class="btn btn-main">üèÉ Draw Activity</button>
                    <button id="recordModeBtn" class="btn btn-main" style="background: var(--primary); color: white;">üõ∞Ô∏è Record an Activity</button>

                    <div id="walk-options" style="display:none; margin: 10px 0; padding: 12px; background: rgba(0,0,0,0.03); border-radius: 12px; border: 1px solid var(--border);">
                        <div class="mode-selector" id="addModeSelector">
                            <button class="mode-btn active" data-mode="walk"><span>üö∂</span><b>Walk</b></button>
                            <button class="mode-btn" data-mode="hike"><span>ü•æ</span><b>Hike</b></button>
                            <button class="mode-btn" data-mode="run"><span>‚ö°</span><b>Run</b></button>
                            <button class="mode-btn" data-mode="cycle"><span>üö≤</span><b>Cycle</b></button>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="settings-label" style="text-transform:none; font-size:12px;">Snap to Footpaths/Roads</span>
                            <label class="switch"><input type="checkbox" id="snapToggle"><span class="slider"></span></label>
                        </div>
                        <div style="display:flex; gap:8px; margin-top:10px;">
                            <button class="btn" id="undoAddBtn" style="flex:1; height:32px; background:rgba(0,0,0,0.05); color:var(--text); font-size:11px; margin:0;">‚Ü© Undo</button>
                            <button class="btn" id="cancelAddBtn" style="flex:1; height:32px; background:var(--danger); color:white; font-size:11px; margin:0;">‚úñ Cancel Plot</button>
                        </div>
                    </div>

                    <div id="route-stats" style="display:none; background:rgba(0,0,0,0.05); padding:15px; border-radius:12px; margin-top: 5px;">
                        <p id="liveDist" style="margin:0; font-weight:800; font-size: 1.2rem; color: var(--primary);">0.00 km</p>
                        <button class="btn" id="drawGraphBtn" onclick="toggleGraph()" style="margin-top:8px; background:rgba(0,0,0,0.05); border:1px solid var(--border); font-size:11px;">üìà Show Height Graph</button>
                        <button class="btn btn-save-action" id="finishWalkBtn" style="margin-top:8px; width: 100%;">üíæ Save Activity</button>
                    </div>
                    <div class="scroll-spacer"></div>
                </div>

                <div id="settings-panel" style="display:none;">
                    <div class="settings-container">
                        <button class="settings-header" onclick="toggleSettingsSection('genSettings', this)">
                            <span>General</span> <span class="chevron">‚ñº</span>
                        </button>
                        <div id="genSettings" class="settings-content">
                            <div class="settings-row-refined" id="profileRow" style="display:none; flex-direction:column; align-items:flex-start; gap:4px;">
                                <span class="settings-label">Logged in as</span>
                                <span id="userEmailDisplay" style="font-size:12px; opacity:0.7; word-break:break-all;"></span>
                                <div style="width:100%; margin-top:8px; padding-top:8px; border-top:1px solid var(--border);">
                                    <span class="settings-label" style="font-size:11px;">Display Name</span>
                                    <div style="display:flex; gap:5px; margin-top:4px;">
                                        <input type="text" id="settingsDisplayName" class="modal-input" style="padding:6px; font-size:12px;" placeholder="Loading..."><button class="btn" id="updateDNBtn" style="width:auto; padding:0 10px; height:30px;">Save</button>
                                    </div>
                                </div>
                            </div>
                            <div class="settings-row-refined">
                                <span class="settings-label">Map Style</span>
                                <select id="settingsMapSelect" onchange="setMapLayer(this.value)" style="padding:4px; border-radius:6px; border:1px solid var(--border); background:var(--bg); color:var(--text); font-size:11px; max-width: 120px;">
                                    <option value="voyager">Voyager</option>
                                    <option value="dark">Dark</option>
                                    <option value="sat">Satellite</option>
                                    <option value="topo">Topography</option>
                                    <option value="transit">Transport</option>
                                </select>
                            </div>
                            <div class="settings-row-refined">
                                <span class="settings-label">App Dark Mode</span>
                                <label class="switch"><input type="checkbox" id="themeToggle"><span class="slider"></span></label>
                            </div>
                            <div class="settings-row-refined">
                                <span class="settings-label">Interface Mode</span>
                                <button class="btn" id="deviceToggleSettings" onclick="toggleDeviceMode()" style="width:auto; height:28px; font-size:11px; padding:0 10px; background:var(--bg); border:1px solid var(--border);">Switch Mode</button>
                            </div>
                        </div>

                        <button class="settings-header" onclick="toggleSettingsSection('prefSettings', this)">
                            <span>Preferences</span> <span class="chevron" style="transform:rotate(-90deg)">‚ñº</span>
                        </button>
                        <div id="prefSettings" class="settings-content" style="display:none;">
                            <div class="settings-row-refined">
                                <span class="settings-label">Units</span>
                                <select id="unitSelect" onchange="changeUnits(this.value)" style="padding:4px; border-radius:6px; border:1px solid var(--border); background:var(--bg); color:var(--text); font-size:11px; max-width: 120px;">
                                    <option value="metric">Metric (km, m)</option>
                                    <option value="imperial">Imperial (mi, ft)</option>
                                </select>
                            </div>
                            <div class="settings-row-refined" style="flex-direction:column; align-items:flex-start; gap:10px;">
                                <span class="settings-label">Default Speeds (<span id="speedUnitLabel">km/h</span>)</span>
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; width:100%;">
                                    <div class="speed-input-group"><span style="font-size:10px;">Walk</span><input type="number" id="speedWalk" class="modal-input" style="padding:6px; font-size:12px;" onchange="saveSpeeds()"></div>
                                    <div class="speed-input-group"><span style="font-size:10px;">Hike</span><input type="number" id="speedHike" class="modal-input" style="padding:6px; font-size:12px;" onchange="saveSpeeds()"></div>
                                    <div class="speed-input-group"><span style="font-size:10px;">Run</span><input type="number" id="speedRun" class="modal-input" style="padding:6px; font-size:12px;" onchange="saveSpeeds()"></div>
                                    <div class="speed-input-group"><span style="font-size:10px;">Cycle</span><input type="number" id="speedCycle" class="modal-input" style="padding:6px; font-size:12px;" onchange="saveSpeeds()"></div>
                                </div>
                            </div>
                        </div>

                        <button class="settings-header" onclick="toggleSettingsSection('accSettings', this)">
                            <span>Account</span> <span class="chevron" style="transform:rotate(-90deg)">‚ñº</span>
                        </button>
                        <div id="accSettings" class="settings-content" style="display:none;">
                            <button class="btn" onclick="makeAllPrivate()" style="margin-top:5px; background:transparent; border:1px solid var(--border); color:var(--text); opacity:0.8; font-size:11px;">üîí Make All Items Private</button>
                            <button class="btn" onclick="deleteAccount()" style="margin-top:5px; background:transparent; border:1px solid var(--danger); color:var(--danger); font-size:11px;">‚ö†Ô∏è Delete Account</button>
                        </div>

                        <div style="margin-top: 10px; border-top: 1px solid var(--border); padding-top: 15px;">
                            <p id="versionLabel" style="font-size: 11px; opacity: 0.5; text-align: center; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">GeoJournal V18.3 Stable</p>
                        </div>
                        <button class="btn" onclick="signOut()" style="margin-top:10px; background:var(--danger); color:white;">Sign Out</button>
                    </div>
                    <div class="scroll-spacer"></div>
                </div>

                <div id="detail-view">
                    <div class="detail-header-container">
                        <img id="detPhoto" src="">
                        <button class="floating-action-btn" id="floatEditBtn" title="Edit">üñãÔ∏è</button>
                        <button class="floating-action-btn btn-delete-float" id="floatDeleteBtn" onclick="deleteAction()" style="display:none;" title="Delete">üóëÔ∏è</button>
                        <label class="floating-action-btn btn-upload-float" id="floatUploadBtn" for="photoInput" style="display:none;" title="Upload Photo">üì∑</label>
                        <input type="file" id="photoInput" accept="image/*" style="display:none;">
                        <div id="detRating" style="display:none;"></div>
                        <div class="image-scrim">
                            <textarea id="editTitle" class="edit-input" rows="2"></textarea>
                        </div>
                    </div>
                    <div id="detCreator" style="font-size: 11px; opacity: 0.7; margin-bottom: 8px; padding: 0 5px; font-weight: 600;"></div>

                    <div id="editWalkOptions" style="display:none; margin: 10px 0; padding: 12px; background: rgba(37, 99, 235, 0.05); border-radius: 12px; border: 1px solid var(--primary);">
                        <div class="mode-selector" id="editModeSelector">
                            <button class="mode-btn" data-mode="walk"><span>üö∂</span><b>Walk</b></button>
                            <button class="mode-btn" data-mode="hike"><span>ü•æ</span><b>Hike</b></button>
                            <button class="mode-btn" data-mode="run"><span>‚ö°</span><b>Run</b></button>
                            <button class="mode-btn" data-mode="cycle"><span>üö≤</span><b>Cycle</b></button>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="settings-label" style="text-transform:none; font-size:12px; color: var(--primary);">Snap new points to paths</span>
                            <label class="switch"><input type="checkbox" id="editSnapToggle"><span class="slider"></span></label>
                        </div>
                        <button class="btn" id="undoEditBtn" style="margin-top:10px; height:32px; background:var(--bg); border: 1px solid var(--border); font-size:11px;">‚Ü© Undo Last Point</button>
                    </div>

                    <div id="editTypeContainer" style="display:none; margin-bottom: 10px;">
                        <span class="stat-label">Pin Category</span>
                        <div class="pin-type-grid" id="detailTypePicker"></div>
                    </div>
                    <div id="editPrivacyContainer" style="display:none; margin-bottom: 10px; padding: 12px; background: rgba(0,0,0,0.03); border-radius: 12px; border: 1px solid var(--border);">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="settings-label" style="text-transform:none; font-size:12px;">Publicly Visible</span>
                            <label class="switch"><input type="checkbox" id="editPublicToggle"><span class="slider"></span></label>
                        </div>
                    </div>
                    <div id="detStats"></div>
                    <div class="info-card"><textarea id="editDesc" class="edit-input" rows="4" placeholder="No notes added..."></textarea></div>
                    <div id="commentsSection" class="comments-section"></div>
                    <div class="scroll-spacer"></div>
                </div>
            </div>
        </aside>

        <div class="zoom-controls" id="zoomCtrl">
                <button class="zoom-btn" id="locateBtn"><div class="loc-icon-inner"></div></button>
                <button class="zoom-btn" onclick="map.zoomIn()">+</button>
                <button class="zoom-btn" onclick="map.zoomOut()">‚àí</button>
                <button class="zoom-btn" id="layerBtn" onclick="toggleLayerMenu()" title="Map Layers">üó∫Ô∏è</button>
            </div>
            <div id="layer-popup">
                <button class="layer-item-btn" onclick="setMapLayer('voyager')">üèôÔ∏è Voyager</button>
                <button class="layer-item-btn" onclick="setMapLayer('dark')">üåô Dark Matter</button>
                <button class="layer-item-btn" onclick="setMapLayer('sat')">üåç Satellite</button>
                <button class="layer-item-btn" onclick="setMapLayer('topo')">‚õ∞Ô∏è Topography</button>
                <button class="layer-item-btn" onclick="setMapLayer('transit')">üöå Transport</button>
            </div>
            <div id="elevation-dock">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 5px;">
                    <strong style="font-weight: 800; font-size: 13px;">Elevation Profile</strong>
                    <button id="closeElevBtn" class="icon-btn" style="width:30px; height:30px; background:none;">‚úï</button>
                </div>
                <div id="elevContainer"><canvas id="elevChart"></canvas></div>
            </div>

        <div id="map"></div>
    </div>

    <div id="modal-overlay">
        <div class="modal">
            <h3 id="modalTitle">Save Entry</h3>
            <div class="modal-inputs">
                <div id="pinTypeSelect" style="display:none;">
                   <span class="stat-label" style="text-align:center; display:block; margin-bottom:10px;">Select Pin Category</span>
                   <div class="pin-type-grid" id="modalTypePicker"></div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; padding:0 5px;">
                    <span class="settings-label" style="font-size:12px;">Make Public</span>
                    <label class="switch"><input type="checkbox" id="publicToggle"><span class="slider"></span></label>
                </div>
                <input type="text" id="itemName" class="modal-input" placeholder="Location Name">
                <textarea id="itemDesc" class="modal-input" placeholder="Notes..." style="height: 100px; resize: none;"></textarea>
            </div>
            <div class="modal-btns">
                <button class="btn btn-save-action" id="confirmSaveBtn" style="height: 48px; font-size: 14px;">‚úÖ Save to Library</button>
                <button class="btn" style="background:none; color: var(--text); opacity: 0.6; border: 1px solid var(--border); height: 44px;" onclick="document.getElementById('modal-overlay').style.display='none'">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script>
        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBG6ip3Uh6bDNgdr54Oy6sEtKxJROw4DC4",
            authDomain: "geojournal-fa10f.firebaseapp.com",
            databaseURL: "https://geojournal-fa10f-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "geojournal-fa10f",
            storageBucket: "geojournal-fa10f.firebasestorage.app",
            messagingSenderId: "185220958678",
            appId: "1:185220958678:web:d418dce420543722417c77",
            measurementId: "G-PX3SDJXSQR"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Pin Categories
        const PIN_TYPES = [
            { name: 'Nature', color: '#10b981', icon: 'üåø' },
            { name: 'History', color: '#ef4444', icon: 'üèõÔ∏è' },
            { name: 'Culture', color: '#d97706', icon: 'üé®' },
            { name: 'Paid', color: '#8b5cf6', icon: 'üéüÔ∏è' },
            { name: 'Water', color: '#3b82f6', icon: 'üíß' },
            { name: 'Activity', color: '#eab308', icon: '‚öΩ' },
            { name: 'Event', color: '#ec4899', icon: 'üìÖ' },
            { name: 'Tourist', color: '#06b6d4', icon: 'üì∏' }
        ];

        // Activity Color Coding
        const ACTIVITY_COLORS = {
            walk: '#10b981', 
            hike: '#d97706', 
            run: '#ef4444',  
            cycle: '#3b82f6' 
        };

        let selectedColor = PIN_TYPES[0].color;
        let storage = { pins: [], walks: [], theme: 'light', mapStyle: 'sat', isMobile: false, units: 'metric', speeds: { walk: 5, hike: 4, run: 10, cycle: 20 } };
        let currentMode = 'explore', tempPath = [], pendingCoords = null, activeSelectionId = null, isEditing = false, graphOpen = false;
        let editingCommentId = null;
        let currentUser = null;
        
        // Reworked Filters Object
        let activeFilters = {
            showPins: true,
            showWalks: true,
            activities: ['walk', 'hike', 'run', 'cycle'],
            categories: PIN_TYPES.map(t => t.name),
            sort: 'rating',
            onlyMine: false,
            search: ''
        };

        let mapItems = new L.FeatureGroup(), userPos = null, userMarker = null, nodeHandles = [], waypointMarkers = [], chartInstance = null;
        let elevationAbortController = null;
        let isFirstLocationLoad = true; 
        let walkHistory = [];

        // Recording State
        let isRecording = false;
        let isPaused = false;
        let liveElevData = [];
        let recordStartTime = null;
        let recordTimerInterval = null;
        let finalRecordedTime = 0;
        let pauseStart = 0;
        let isFlying = false;
        let flyAnimationId = null;
        let flyMarker = null;
        let currentFlySpeed = 1.0;
        let currentFlyZoom = 17.0;
        let flyStartTime = 0;

        function adjustFlySpeed(delta) {
            currentFlySpeed = Math.max(0.5, Math.min(10, currentFlySpeed + delta));
            document.getElementById('flySpeedDisplay').innerText = currentFlySpeed.toFixed(1) + 'x';
        }

        function adjustFlyZoom(delta) {
            currentFlyZoom = Math.max(10, Math.min(20, currentFlyZoom + delta));
            document.getElementById('flyZoomDisplay').innerText = currentFlyZoom.toFixed(1);
        }

        const map = L.map('map', { zoomControl: false, zoomSnap: 0.1 }).setView([51.505, -0.09], 3);
        mapItems.addTo(map);

        const mapStyles = { 
            voyager: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', 
            dark: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
            sat: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
            topo: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
            transit: 'https://tile.memomaps.de/tilegen/{z}/{x}/{y}.png'
        };

        let baseLayer = L.tileLayer(mapStyles[storage.mapStyle] || mapStyles.voyager).addTo(map);
        let tempPoly = L.polyline([], {color: '#2563eb', weight: 6, opacity: 0.8}).addTo(map);

        // --- DATABASE SYNC FUNCTIONS ---
        async function loadPermanentData() {
            try {
                // Load Public Pins
                const pubPins = await db.collection("pins").where("isPublic", "==", true).get();
                // Load My Pins
                let myPins = { docs: [] };
                if (currentUser) {
                    myPins = await db.collection("pins").where("userId", "==", currentUser.uid).get();
                }
                
                // Merge Pins (Map by ID to dedup)
                const pinMap = new Map();
                pubPins.docs.forEach(doc => pinMap.set(doc.id, doc.data()));
                myPins.docs.forEach(doc => pinMap.set(doc.id, doc.data()));
                storage.pins = Array.from(pinMap.values());
                
                // Load Public Walks
                const pubWalks = await db.collection("walks").where("isPublic", "==", true).get();
                // Load My Walks
                let myWalks = { docs: [] };
                if (currentUser) {
                    myWalks = await db.collection("walks").where("userId", "==", currentUser.uid).get();
                }

                const walkMap = new Map();
                const processWalk = (doc) => {
                    const d = doc.data();
                    if (d.path && d.path.length > 0 && typeof d.path[0] === 'object' && !Array.isArray(d.path[0])) {
                        d.path = d.path.map(p => [p.lat, p.lng]);
                    }
                    return d;
                };
                
                pubWalks.docs.forEach(doc => walkMap.set(doc.id, processWalk(doc)));
                myWalks.docs.forEach(doc => walkMap.set(doc.id, processWalk(doc)));
                storage.walks = Array.from(walkMap.values());
                
                initFiltersUI();
                refreshMapItems();
                updateHighlights();
            } catch (e) { console.error("Database load error:", e); }
        }

        async function saveToCloud(collection, data) {
            try {
                const cleanData = JSON.parse(JSON.stringify(data));
                if (cleanData.path && cleanData.path.length > 0 && Array.isArray(cleanData.path[0])) {
                    cleanData.path = cleanData.path.map(p => ({ lat: p[0], lng: p[1] }));
                }
                if (!cleanData.userId) cleanData.userId = currentUser.uid;
                
                // Ensure creatorName is set
                if (!cleanData.creatorName) {
                    if (currentUser.displayName) cleanData.creatorName = currentUser.displayName;
                    else {
                        try {
                            const uDoc = await db.collection('users').doc(currentUser.uid).get();
                            if(uDoc.exists && uDoc.data().displayName) cleanData.creatorName = uDoc.data().displayName;
                        } catch(e){}
                    }
                }

                await db.collection(collection).doc(cleanData.id.toString()).set(cleanData);
            } catch (e) { console.error("Cloud save error:", e); }
        }

        // --- NEW REDESIGNED FILTER LOGIC ---
        function initFiltersUI() {
            const pinGrid = document.getElementById('pinGridReveal');
            pinGrid.innerHTML = '';
            PIN_TYPES.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'sub-toggle-btn active';
                btn.dataset.cat = cat.name;
                btn.dataset.color = cat.color;
                btn.style.borderColor = cat.color;
                btn.style.backgroundColor = cat.color;
                btn.style.color = 'white';
                btn.innerHTML = `<span class="filter-icon">${cat.icon}</span>${cat.name}`;
                btn.onclick = () => toggleSubFilter(btn, 'category');
                pinGrid.appendChild(btn);
            });

            // Initialize Activity Buttons Colors
            document.querySelectorAll('#activityGridReveal .sub-toggle-btn').forEach(btn => {
                const type = btn.dataset.type;
                const color = ACTIVITY_COLORS[type];
                if(color) {
                    btn.dataset.color = color;
                    btn.style.borderColor = color;
                    if(btn.classList.contains('active')) {
                        btn.style.backgroundColor = color;
                        btn.style.color = 'white';
                    }
                }
            });
        }

        function toggleFilterSection(id, btn) {
            const el = document.getElementById(id);
            const isHidden = el.style.display === 'none';
            el.style.display = isHidden ? 'grid' : 'none';
            btn.classList.toggle('active', isHidden);
            const chevron = btn.querySelector('.chevron');
            if(chevron) chevron.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        function toggleSubFilter(btn, filterType) {
            btn.classList.toggle('active');
            const isActive = btn.classList.contains('active');
            
            const color = btn.dataset.color;
            if (color) {
                if (isActive) {
                    btn.style.backgroundColor = color;
                    btn.style.color = 'white';
                } else {
                    btn.style.backgroundColor = '';
                    btn.style.color = '';
                }
            }
            
            if (filterType === 'activity') {
                const val = btn.dataset.type;
                if (isActive) activeFilters.activities.push(val);
                else activeFilters.activities = activeFilters.activities.filter(a => a !== val);
            } else {
                const val = btn.dataset.cat;
                if (isActive) activeFilters.categories.push(val);
                else activeFilters.categories = activeFilters.categories.filter(c => c !== val);
            }
            updateHighlights();
        }

        function toggleMineFilter(btn) {
            activeFilters.onlyMine = !activeFilters.onlyMine;
            btn.classList.toggle('active', activeFilters.onlyMine);
            updateHighlights();
        }

        function toggleSettingsSection(id, btn) {
            const el = document.getElementById(id);
            const isHidden = el.style.display === 'none';
            el.style.display = isHidden ? 'flex' : 'none';
            const chevron = btn.querySelector('.chevron');
            if(chevron) chevron.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(-90deg)';
        }

        function setSort(type, btn) {
            activeFilters.sort = type;
            btn.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateHighlights();
        }

        // Device / Theme setup
        if (localStorage.getItem('geojournal_v11')) {
            const localData = JSON.parse(localStorage.getItem('geojournal_v11'));
            storage.theme = localData.theme || 'light';
            storage.mapStyle = localData.mapStyle || 'sat';
            storage.isMobile = localData.isMobile || false;
            storage.units = localData.units || 'metric';
            storage.speeds = localData.speeds || { walk: 5, hike: 4, run: 10, cycle: 20 };
        }

        if (storage.isMobile) {
            document.body.classList.add('mobile-mode');
            document.getElementById('deviceToggleSettings').innerText = 'Switch to PC';
        } else {
            document.getElementById('deviceToggleSettings').innerText = 'Switch to Mobile';
        }
        
        const mapSel = document.getElementById('settingsMapSelect');
        if(mapSel) mapSel.value = storage.mapStyle;

        const unitSel = document.getElementById('unitSelect');
        if(unitSel) unitSel.value = storage.units;
        updateSpeedInputs();

        function changeUnits(val) {
            storage.units = val;
            saveData();
            updateSpeedInputs();
            updateHighlights();
            if(activeSelectionId) {
                const item = storage.walks.find(w => w.id === activeSelectionId);
                if(item) updateWalkStats();
            }
        }

        function updateSpeedInputs() {
            const isImp = storage.units === 'imperial';
            document.getElementById('speedUnitLabel').innerText = isImp ? 'mph' : 'km/h';
            ['walk', 'hike', 'run', 'cycle'].forEach(type => {
                const kmh = storage.speeds[type];
                document.getElementById('speed' + type.charAt(0).toUpperCase() + type.slice(1)).value = isImp ? (kmh * 0.621371).toFixed(1) : kmh;
            });
        }

        function saveSpeeds() {
            const isImp = storage.units === 'imperial';
            ['walk', 'hike', 'run', 'cycle'].forEach(type => {
                let val = parseFloat(document.getElementById('speed' + type.charAt(0).toUpperCase() + type.slice(1)).value) || 0;
                if(isImp) val = val / 0.621371;
                storage.speeds[type] = val;
            });
            saveData();
        }

        function formatDist(km) {
            if (storage.units === 'imperial') return (km * 0.621371).toFixed(2) + ' mi';
            return parseFloat(km).toFixed(2) + ' km';
        }
        function formatElev(m) {
            if (storage.units === 'imperial') return Math.round(m * 3.28084) + ' ft';
            return Math.round(m) + ' m';
        }

        document.body.classList.add((storage.theme || 'light') + '-theme');
        document.getElementById('themeToggle').checked = (storage.theme === 'dark');

        function toggleDeviceMode() {
            storage.isMobile = !storage.isMobile;
            saveData();
            location.reload(); 
        }

        function resetSidebarScroll() {
            const area = document.getElementById('mainScrollArea');
            if (area) area.scrollTo({top: 0, behavior: 'smooth'});
        }

        // Activity selector logic
        document.querySelectorAll('#addModeSelector .mode-btn, #editModeSelector .mode-btn').forEach(btn => {
            btn.onclick = () => {
                const parent = btn.parentElement;
                parent.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const activityMode = btn.dataset.mode;
                selectedColor = ACTIVITY_COLORS[activityMode];

                if (currentMode === 'walk') {
                    tempPoly.setStyle({color: selectedColor});
                }
                
                if (isEditing && activeSelectionId) {
                    const walk = storage.walks.find(w => w.id === activeSelectionId);
                    if (walk) {
                        walk.activity = activityMode;
                        walk.color = selectedColor;
                        if (window.currentActiveLayer) {
                            window.currentActiveLayer.setStyle({color: selectedColor});
                        }
                        updateWalkStats();
                    }
                }
            };
        });

        // Mobile Dragging logic
        let startY = 0, startTop = 0, startTime = 0, isDragging = false;
        const mobileSidebar = document.getElementById('sidebar');
        const dragHandle = document.getElementById('mobileDragHandle');
        const mobileHeader = document.getElementById('mobileHeader');

        function triggerHaptic() {
            if (window.navigator && window.navigator.vibrate) {
                window.navigator.vibrate(15);
            }
        }

        function snapTo(state) {
            mobileSidebar.style.transition = 'top 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
            if (state === 'open') {
                mobileSidebar.classList.remove('half');
                mobileSidebar.classList.add('open');
                mobileSidebar.style.top = '6vh';
            } else if (state === 'half') {
                mobileSidebar.classList.remove('open');
                mobileSidebar.classList.add('half');
                mobileSidebar.style.top = '50vh';
            } else {
                mobileSidebar.classList.remove('open', 'half');
                mobileSidebar.style.top = 'calc(100vh - 110px)'; 
            }
            triggerHaptic();
            resetSidebarScroll();
        }

        const handleDragStart = (e) => {
            if (!document.body.classList.contains('mobile-mode')) return;
            startY = e.touches[0].clientY;
            startTop = mobileSidebar.offsetTop;
            startTime = Date.now();
            isDragging = false;
            mobileSidebar.style.transition = 'none';
        };

        const handleDragMove = (e) => {
            if (!document.body.classList.contains('mobile-mode')) return;
            const touchY = e.touches[0].clientY;
            const deltaY = touchY - startY;
            if (Math.abs(deltaY) > 5) isDragging = true;
            let newTop = startTop + deltaY;
            const vh = window.innerHeight;
            if (newTop < vh * 0.06) newTop = vh * 0.06;
            if (newTop > vh - 110) newTop = vh - 110;
            mobileSidebar.style.top = newTop + 'px';
        };

        const handleDragEnd = (e) => {
            if (!document.body.classList.contains('mobile-mode')) return;
            if (!isDragging) return;
            const currentTop = mobileSidebar.offsetTop;
            const vh = window.innerHeight;
            if (currentTop < vh * 0.3) snapTo('open');
            else if (currentTop < vh * 0.7) snapTo('half');
            else snapTo('bottom');
        };

        [dragHandle, mobileHeader].forEach(el => {
            el.addEventListener('touchstart', handleDragStart, { passive: true });
            el.addEventListener('touchmove', handleDragMove, { passive: true });
            el.addEventListener('touchend', handleDragEnd, { passive: true });
        });

        dragHandle.addEventListener('click', () => {
            if (document.body.classList.contains('mobile-mode')) {
                if (mobileSidebar.classList.contains('open')) snapTo('bottom');
                else if (mobileSidebar.classList.contains('half')) snapTo('open');
                else snapTo('half');
            }
        });

        // GPS watcher
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition((position) => {
                const latlng = L.latLng(position.coords.latitude, position.coords.longitude);
                userPos = latlng;
                if (!userMarker) {
                    userMarker = L.marker(latlng, { icon: L.divIcon({ className: '', html: '<div class="gps-indicator-wrapper"><div class="gps-indicator"></div><div class="gps-pulse"></div></div>', iconSize: [14, 14], iconAnchor: [7, 7] }) }).addTo(map);
                } else { userMarker.setLatLng(latlng); }
                if (isFirstLocationLoad) { map.setView(latlng, 15); isFirstLocationLoad = false; }
                
                if(isRecording && !isPaused) {
                    if(tempPath.length === 0 || latlng.distanceTo(L.latLng(tempPath[tempPath.length-1][0], tempPath[tempPath.length-1][1])) > 5) {
                        tempPath.push([latlng.lat, latlng.lng]);
                        tempPoly.setLatLngs(tempPath);
                        let d = 0; for(let i=1; i<tempPath.length; i++) d += L.latLng(tempPath[i-1][0], tempPath[i-1][1]).distanceTo(L.latLng(tempPath[i][0], tempPath[i][1])); 
                        document.getElementById('hudDist').innerText = formatDist(d/1000);
                        fetchLivePointElevation(latlng.lat, latlng.lng);
                    }
                }
            }, (error) => console.error(error), { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 });
        }

        async function fetchLivePointElevation(lat, lon) {
            try {
                const res = await fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lon}`).then(r=>r.json());
                if(res.results && res.results[0]) {
                    const e = res.results[0].elevation;
                    liveElevData.push(e);
                    const min = Math.round(Math.min(...liveElevData));
                    const max = Math.round(Math.max(...liveElevData));
                    document.getElementById('hudMinHeight').innerText = `MIN: ${formatElev(min)}`;
                    document.getElementById('hudMaxHeight').innerText = `MAX: ${formatElev(max)}`;
                    if(graphOpen) renderLiveRecordingGraph();
                }
            } catch(e){}
        }

        function renderLiveRecordingGraph() {
            document.getElementById('elevation-dock').classList.add('active');
            let currentTotal = 0, distData = [0]; 
            for(let j = 1; j < tempPath.length; j++){ 
                currentTotal += L.latLng(tempPath[j-1][0], tempPath[j-1][1]).distanceTo(L.latLng(tempPath[j][0], tempPath[j][1])); 
                distData.push(currentTotal / 1000); 
            }
            const isImp = storage.units === 'imperial';
            const ctx = document.getElementById('elevChart').getContext('2d'); 
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { 
                type:'line', 
                data:{ 
                    labels: distData.map(d => isImp ? (d * 0.621371).toFixed(1) : d.toFixed(1)), 
                    datasets:[{ data: liveElevData.map(e => isImp ? e * 3.28084 : e), borderColor:'#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.15)', fill:true, pointRadius:0, borderWidth: 2, tension:0.4 }] 
                }, 
                options:{ maintainAspectRatio:false, plugins:{ legend:{display:false} }, scales:{ x:{ title:{display:true, text: isImp ? 'mi' : 'km'} }, y:{ title:{display:true, text: isImp ? 'ft' : 'm'}, position:'right' } } } 
            });
        }

        function setupTypePickers() {
            ['modalTypePicker', 'detailTypePicker'].forEach(id => {
                const el = document.getElementById(id); if (!el) return;
                el.innerHTML = '';
                PIN_TYPES.forEach(t => {
                    const btn = document.createElement('button'); 
                    btn.className = 'type-btn';
                    btn.style.backgroundColor = t.color;
                    if(t.color === selectedColor) btn.classList.add('active');
                    btn.innerHTML = `${t.icon}<span>${t.name}</span>`;
                    btn.onclick = (e) => {
                        e.preventDefault();
                        selectedColor = t.color; 
                        el.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active')); 
                        btn.classList.add('active');
                        if(id === 'detailTypePicker' && isEditing) {
                            const item = storage.pins.find(p=>p.id===activeSelectionId) || storage.walks.find(w=>w.id===activeSelectionId);
                            if(item) { 
                                item.color = t.color; 
                                saveData(); 
                                saveToCloud(item.path ? 'walks' : 'pins', item);
                                refreshMapItems(); 
                            }
                        }
                    }; el.appendChild(btn);
                });
            });
        }

        function toggleLayerMenu() { const menu = document.getElementById('layer-popup'); menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex'; }
        function setMapLayer(style) { 
            storage.mapStyle = style; 
            map.removeLayer(baseLayer); 
            baseLayer = L.tileLayer(mapStyles[style], { maxZoom: 18 }).addTo(map); 
            saveData(); 
            document.getElementById('layer-popup').style.display = 'none';
            const sel = document.getElementById('settingsMapSelect');
            if(sel) sel.value = style;
        }
        function isUIPressed(e) { return e.originalEvent.target.closest('#sidebar') || e.originalEvent.target.closest('#elevation-dock') || e.originalEvent.target.closest('.zoom-controls') || e.originalEvent.target.closest('#layer-popup') || e.originalEvent.target.closest('#expandBtn') || e.originalEvent.target.closest('#recording-popout'); }

        const locateBtn = document.getElementById('locateBtn');
        if (locateBtn) locateBtn.onclick = (e) => { L.DomEvent.stopPropagation(e); if (userPos) map.setView(userPos, 15); };

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const expandBtn = document.getElementById('expandBtn');
            const dock = document.getElementById('elevation-dock');
            if(document.body.classList.contains('mobile-mode')) { snapTo('bottom'); return; }
            const isMinimized = sidebar.classList.toggle('minimized');
            expandBtn.style.display = isMinimized ? 'flex' : 'none';
            if (isMinimized) { dock.style.left = '20px'; } else { dock.style.left = 'calc(var(--sidebar) + 20px)'; }
            setTimeout(() => map.invalidateSize(), 400);
        }

        function goBack() {
            document.getElementById('backBtn').style.display = 'none';
            document.getElementById('minimizeBtn').style.display = 'flex';
            document.getElementById('mainTabs').style.display = 'flex';
            document.getElementById('detail-view').style.display = 'none';
            document.getElementById('editWalkOptions').style.display = 'none';
            document.getElementById('mainSearch').style.display = 'block'; 
            waypointMarkers.forEach(m => map.removeLayer(m)); waypointMarkers = [];
            closeElevation(); switchTab('explore');
            if(document.body.classList.contains('mobile-mode')) snapTo('open');
            resetSidebarScroll();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const targetTab = document.getElementById(tab + 'Tab');
            if (targetTab) targetTab.classList.add('active');
            document.getElementById('explore-panel').style.display = (tab === 'explore' ? 'block' : 'none');
            document.getElementById('add-panel').style.display = (tab === 'add' ? 'block' : 'none');
            document.getElementById('settings-panel').style.display = (tab === 'settings' ? 'block' : 'none');
            document.getElementById('detail-view').style.display = 'none';
            document.getElementById('editWalkOptions').style.display = 'none';
            document.getElementById('mainSearch').style.display = 'block'; 
            closeElevation(); setMode(tab === 'explore' ? 'explore' : 'ready');
            resetSidebarScroll();
        }

        function setMode(mode) {
            currentMode = mode; document.querySelectorAll('.btn-main').forEach(b => b.classList.remove('active-mode'));
            if (document.getElementById(mode + 'ModeBtn')) document.getElementById(mode + 'ModeBtn').classList.add('active-mode');
            
            document.getElementById('route-stats').style.display = (mode === 'walk' ? 'block' : 'none');
            document.getElementById('walk-options').style.display = (mode === 'walk' ? 'block' : 'none');
            document.getElementById('recordModeBtn').style.display = (mode === 'record' || isRecording ? 'none' : 'block');
            
            const popout = document.getElementById('recording-popout');
            popout.style.display = (isRecording ? 'flex' : 'none');
            
            const zoomCtrl = document.getElementById('zoomCtrl');
            const layerPop = document.getElementById('layer-popup');
            if(isRecording) {
                zoomCtrl.style.top = (popout.offsetHeight + 40) + 'px';
                layerPop.style.top = (popout.offsetHeight + 180) + 'px';
            } else {
                zoomCtrl.style.top = '20px';
                layerPop.style.top = '160px';
            }
            
            isEditing = false; nodeHandles.forEach(h => map.removeLayer(h));
            if(mode !== 'walk' && mode !== 'pin' && mode !== 'record') { 
                tempPath = []; 
                walkHistory = []; 
                tempPoly.setLatLngs([]); 
                closeElevation();
            }
        }

        if (pinModeBtn) pinModeBtn.onclick = () => { selectedColor = PIN_TYPES[0].color; setupTypePickers(); setMode('pin'); };
        if (walkModeBtn) walkModeBtn.onclick = () => { 
            const activityMode = document.querySelector('#addModeSelector .mode-btn.active').dataset.mode;
            selectedColor = ACTIVITY_COLORS[activityMode];
            tempPoly.setStyle({color: selectedColor});
            setupTypePickers(); 
            setMode('walk'); 
        };
        if (recordModeBtn) recordModeBtn.onclick = startRecording;

        document.getElementById('cancelAddBtn').onclick = () => {
            if(confirm("Discard current plot?")) {
                tempPath = [];
                walkHistory = [];
                tempPoly.setLatLngs([]);
                document.getElementById('liveDist').innerText = '0.00 km';
                closeElevation();
                setMode('ready');
            }
        };

        function startRecording() {
            if(!userPos) { alert("Waiting for GPS signal..."); return; }
            isRecording = true;
            isPaused = false;
            liveElevData = [];
            tempPath = [[userPos.lat, userPos.lng]];
            
            const activityMode = document.querySelector('#addModeSelector .mode-btn.active').dataset.mode;
            tempPoly.setLatLngs(tempPath);
            tempPoly.setStyle({color: ACTIVITY_COLORS[activityMode], dashArray: null}); 
            
            recordStartTime = Date.now();
            finalRecordedTime = 0;
            startTimer();

            setMode('record');
            document.getElementById('hudPausePlay').innerText = '‚è∏ PAUSE';
            document.getElementById('hudMinHeight').innerText = 'MIN: --m';
            document.getElementById('hudMaxHeight').innerText = 'MAX: --m';
            map.flyTo(userPos, 16);
            if(document.body.classList.contains('mobile-mode')) snapTo('bottom');
            fetchLivePointElevation(userPos.lat, userPos.lng);
        }

        function startTimer() {
            if(recordTimerInterval) clearInterval(recordTimerInterval);
            recordTimerInterval = setInterval(() => {
                if(!isPaused) {
                    const diff = Date.now() - recordStartTime;
                    const sec = Math.floor(diff / 1000) % 60;
                    const min = Math.floor(diff / 60000) % 60;
                    const hrs = Math.floor(diff / 3600000);
                    document.getElementById('hudTimer').innerText = 
                        (hrs > 0 ? hrs + ":" : "") + 
                        String(min).padStart(2, '0') + ":" + 
                        String(sec).padStart(2, '0');
                    finalRecordedTime = Math.floor(diff / 60000); 
                }
            }, 1000);
        }

        document.getElementById('hudPausePlay').onclick = () => {
            isPaused = !isPaused;
            document.getElementById('hudPausePlay').innerText = isPaused ? '‚ñ∂ RESUME' : '‚è∏ PAUSE';
            document.getElementById('hudPausePlay').style.background = isPaused ? 'var(--accent)' : 'rgba(255,255,255,0.2)';
            if(isPaused) { pauseStart = Date.now(); } 
            else { recordStartTime += (Date.now() - pauseStart); }
        };

        document.getElementById('hudStop').onclick = () => {
            isRecording = false;
            clearInterval(recordTimerInterval);
            if(tempPath.length > 1) {
                const activityMode = document.querySelector('#addModeSelector .mode-btn.active').dataset.mode;
                selectedColor = ACTIVITY_COLORS[activityMode] || ACTIVITY_COLORS.walk;
                setupTypePickers();
                resetModal();
                document.getElementById('pinTypeSelect').style.display = 'none'; 
                document.getElementById('modal-overlay').style.display = 'flex';
            } else {
                tempPath = [];
                tempPoly.setLatLngs([]);
                setMode('ready');
            }
            closeElevation();
        };

        document.getElementById('finishWalkBtn').onclick = () => {
            if (tempPath.length < 2) { alert("Please draw a route first!"); return; }
            const activityMode = document.querySelector('#addModeSelector .mode-btn.active').dataset.mode;
            selectedColor = ACTIVITY_COLORS[activityMode] || ACTIVITY_COLORS.walk;
            setupTypePickers();
            resetModal();
            document.getElementById('pinTypeSelect').style.display = 'none';
            document.getElementById('modal-overlay').style.display = 'flex';
        };

        function updateHighlights() {
            const list = document.getElementById('highlights-list'); if (!list) return;
            let all = [
                ...storage.pins.map(p => ({...p, type:'PIN'})), 
                ...storage.walks.map(w => ({...w, type:'WALK', lat:w.path[0][0], lng:w.path[0][1]}))
            ];
            
            all = all.filter(i => {
                if (i.type === 'PIN') {
                    if (!activeFilters.showPins) return false;
                    const cat = PIN_TYPES.find(t => t.color === i.color);
                    return cat && activeFilters.categories.includes(cat.name);
                }
                if (i.type === 'WALK') {
                    if (!activeFilters.showWalks) return false;
                    return activeFilters.activities.includes(i.activity || 'walk');
                }
                return true;
            });

            if (activeFilters.onlyMine && currentUser) {
                all = all.filter(i => i.userId === currentUser.uid);
            }

            if (activeFilters.search) {
                const term = activeFilters.search.toLowerCase();
                all = all.filter(i => i.name.toLowerCase().includes(term) || 
                    (i.creatorName && i.creatorName.toLowerCase().includes(term)) ||
                    (i.comments && i.comments.some(c => c.displayName && c.displayName.toLowerCase().includes(term))));
            }

            // Update Map to match filters
            mapItems.clearLayers();
            all.forEach(i => {
                if (i.type === 'PIN') addPin(i);
                else if (i.type === 'WALK') addWalk(i);
            });

            if (userPos) all.forEach(i => i.d = L.latLng(i.lat, i.lng).distanceTo(userPos) / 1000);
            if (activeFilters.sort === 'rating') all.sort((a,b) => b.rating - a.rating); else all.sort((a,b) => (a.d || 0) - (b.d || 0));
            
            list.innerHTML = all.length ? '' : '<p style="font-size:12px;opacity:0.5;text-align:center;margin-top:20px;">No items match filters.</p>';
            all.forEach(i => {
                const div = document.createElement('div'); div.className = 'highlight-item'; div.style.borderLeft = `4px solid ${i.color || '#2563eb'}`;
                
                let labelText = '';
                let labelColor = i.color || '#2563eb';
                let iconChar = 'üìç';

                if (i.type === 'WALK') {
                    iconChar = i.activity === 'cycle' ? 'üö≤' : (i.activity === 'run' ? '‚ö°' : (i.activity === 'hike' ? 'ü•æ' : 'üö∂'));
                    labelText = i.activity ? i.activity.toUpperCase() : 'WALK';
                    labelColor = ACTIVITY_COLORS[i.activity] || '#2563eb';
                } else {
                    const category = PIN_TYPES.find(t => t.color === i.color);
                    labelText = category ? category.name.toUpperCase() : 'PIN';
                    iconChar = category ? category.icon : 'üìç';
                }

                const visibilityLabel = i.isPublic ? 
                    `<span class="type-label" style="background:var(--accent); margin-left:5px;">PUBLIC</span>` : 
                    `<span class="type-label" style="background:#64748b; margin-left:5px;">PRIVATE</span>`;

                let ratingHtml = '';
                if (i.comments && i.comments.length > 0) {
                    ratingHtml = `<span style="color:#fbbf24; font-weight:800; margin-right:6px;">‚òÖ ${i.rating.toFixed(1)}</span>`;
                }
                const displayCreator = i.creatorName || (currentUser && i.userId === currentUser.uid ? currentUser.displayName : 'User');
                const creatorHtml = `<span style="opacity:0.7; margin-right:6px;">by ${displayCreator}</span>`;
                const distHtml = i.d ? `${formatDist(i.d)} away` : '';

                div.innerHTML = `<img class="highlight-thumb" src="${i.photo || 'https://placehold.co/100x100?text=No+Photo'}"><div style="flex:1"><span class="type-label" style="background:${labelColor}">${iconChar} ${labelText}</span>${visibilityLabel}<p style="font-weight:bold;font-size:13px;margin:0;">${i.name}</p><div style="font-size:11px;color:var(--text);opacity:0.5;">${ratingHtml}${creatorHtml}${distHtml}</div></div>`;
                div.onclick = () => { 
                    const obj = i.type === 'PIN' ? storage.pins.find(p=>p.id===i.id) : storage.walks.find(w=>w.id===i.id); 
                    if(i.type === 'WALK' && obj.path) {
                        const poly = L.polyline(obj.path);
                        const sidePadding = document.body.classList.contains('mobile-mode') ? 20 : (parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidebar')) + 40);
                        const bottomPadding = document.body.classList.contains('mobile-mode') ? (window.innerHeight / 2) : 40;
                        map.flyToBounds(poly.getBounds(), { paddingBottomRight: [sidePadding, bottomPadding], paddingTopLeft: [20, 20], duration: 1.5 });
                        map.once('moveend', () => showDetails(obj, true, null)); 
                    } else { 
                        map.flyTo([i.lat, i.lng], 15);
                        map.once('moveend', () => showDetails(obj, false, null));
                    }
                };
                list.appendChild(div);
            });
        }

        async function getSnappedPath(startLatLng, endLatLng) {
            const url = `https://router.project-osrm.org/route/v1/foot/${startLatLng.lng},${startLatLng.lat};${endLatLng.lng},${endLatLng.lat}?overview=full&geometries=geojson`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.routes && data.routes.length > 0) {
                    return data.routes[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);
                }
            } catch (error) { console.error("Routing error:", error); }
            return [[endLatLng.lat, endLatLng.lng]]; 
        }

        map.on('click', async (e) => {
            if (isUIPressed(e)) return;
            if (isEditing && window.currentActiveLayer instanceof L.Polyline) { 
                const lls = window.currentActiveLayer.getLatLngs(); 
                const snapEnabled = document.getElementById('editSnapToggle').checked;
                walkHistory.push(lls.map(l => L.latLng(l.lat, l.lng)));
                if (snapEnabled && lls.length > 0) {
                    const roadNodes = await getSnappedPath(lls[lls.length - 1], e.latlng);
                    roadNodes.forEach(node => lls.push(L.latLng(node[0], node[1])));
                } else { lls.push(e.latlng); }
                window.currentActiveLayer.setLatLngs(lls); 
                updateWalkStats(); createNodes(window.currentActiveLayer); 
                fetchElevation(lls.map(l => [l.lat, l.lng]), false); 
                return; 
            }
            if (currentMode === 'pin') { 
                pendingCoords = e.latlng; 
                resetModal(); 
                document.getElementById('pinTypeSelect').style.display = 'block';
                document.getElementById('modal-overlay').style.display = 'flex'; 
            }
            if (currentMode === 'walk') {
                const snapEnabled = document.getElementById('snapToggle').checked;
                walkHistory.push(JSON.parse(JSON.stringify(tempPath)));
                if (snapEnabled && tempPath.length > 0) {
                    const lastPt = L.latLng(tempPath[tempPath.length - 1][0], tempPath[tempPath.length - 1][1]);
                    const roadNodes = await getSnappedPath(lastPt, e.latlng);
                    tempPath.push(...roadNodes);
                } else { tempPath.push([e.latlng.lat, e.latlng.lng]); }
                tempPoly.setLatLngs(tempPath); 
                let d = 0; for(let i=1; i<tempPath.length; i++) d += L.latLng(tempPath[i-1][0], tempPath[i-1][1]).distanceTo(L.latLng(tempPath[i][0], tempPath[i][1])); 
                document.getElementById('liveDist').innerText = formatDist(d/1000); 
                fetchElevation(tempPath, false); 
            }
        });

        document.getElementById('undoAddBtn').onclick = () => {
            if (walkHistory.length > 0) {
                tempPath = walkHistory.pop();
                tempPoly.setLatLngs(tempPath);
                let d = 0; for(let i=1; i<tempPath.length; i++) d += L.latLng(tempPath[i-1][0], tempPath[i-1][1]).distanceTo(L.latLng(tempPath[i][0], tempPath[i][1])); 
                document.getElementById('liveDist').innerText = formatDist(d/1000);
                fetchElevation(tempPath, false);
            }
        };

        function resetModal() { document.getElementById('itemName').value = ''; document.getElementById('itemDesc').value = ''; setupTypePickers(); }

        document.getElementById('confirmSaveBtn').onclick = async () => {
            if (!currentUser) return;
            const id = Date.now();
            const name = document.getElementById('itemName').value || "Untitled";
            const desc = document.getElementById('itemDesc').value || "";
            const activityMode = document.querySelector('#addModeSelector .mode-btn.active').dataset.mode;
            const isPublic = document.getElementById('publicToggle').checked;
            
            let flat, flon, entry;

            if (tempPath.length < 2) { 
                flat = pendingCoords.lat; 
                flon = pendingCoords.lng; 
                entry = { id, name, desc, rating: 0, lat: flat, lng: flon, color: selectedColor, type: 'PIN', userId: currentUser.uid, creatorName: currentUser.displayName || "User", isPublic: isPublic };
                storage.pins.push(entry); 
                addPin(entry);
                await saveToCloud('pins', entry);
            } else { 
                let d = 0; 
                for(let i=1; i<tempPath.length; i++) {
                    d += L.latLng(tempPath[i-1][0], tempPath[i-1][1]).distanceTo(L.latLng(tempPath[i][0], tempPath[i][1]));
                }
                flat = tempPath[0][0]; 
                flon = tempPath[0][1]; 
                
                const activeColor = ACTIVITY_COLORS[activityMode] || ACTIVITY_COLORS.walk;

                entry = { 
                    id, name, desc, rating: 0, 
                    path: JSON.parse(JSON.stringify(tempPath)), dist: (d/1000).toFixed(2), 
                    lat: flat, lng: flon, color: activeColor, 
                    activity: activityMode, elevData: JSON.parse(JSON.stringify(liveElevData)), 
                    recordedTime: finalRecordedTime,
                    type: 'WALK',
                    userId: currentUser.uid,
                    isPublic: isPublic,
                    creatorName: currentUser.displayName || "User"
                }; 
                storage.walks.push(entry); 
                addWalk(entry); 
                await saveToCloud('walks', entry);
            }
            
            saveData(); 
            document.getElementById('modal-overlay').style.display = 'none'; 
            goBack(); 
            fetchPhoto(flat, flon, id);
            
            tempPath = [];
            tempPoly.setLatLngs([]);
            liveElevData = [];
            finalRecordedTime = 0;
        };

        async function fetchPhoto(lat, lon, id) {
            try {
                const res = await fetch(`https://en.wikipedia.org/w/api.php?action=query&list=geosearch&gsradius=500&gscoord=${lat}|${lon}&format=json&origin=*`).then(r=>r.json());
                if(res.query?.geosearch?.length) {
                    const title = res.query.geosearch[0].title;
                    const imgRes = await fetch(`https://en.wikipedia.org/w/api.php?action=query&prop=pageimages&format=json&piprop=original&titles=${encodeURIComponent(title)}&pithumbsize=500&origin=*`).then(r=>r.json());
                    const pg = Object.values(imgRes.query.pages)[0];
                    if(pg.original) { 
                        let entry = storage.pins.find(x=>x.id===id) || storage.walks.find(x=>x.id===id); 
                        if(entry && !entry.photo) { 
                            entry.photo = pg.original.source; 
                            saveData(); 
                            saveToCloud(entry.path ? 'walks' : 'pins', entry);
                            updateHighlights(); 
                        } 
                    }
                }
            } catch(e){}
        }

        function addPin(p) { 
            const pinIcon = L.divIcon({ className: 'custom-pin-marker', html: `<div class="pin-wrapper"><div class="pin-shape" style="background:${p.color || '#2563eb'}"></div></div>`, iconSize: [40, 40], iconAnchor: [20, 40] }); 
            L.marker([p.lat, p.lng], {icon: pinIcon, zIndexOffset: 1000}).addTo(mapItems).on('click', (e) => { 
                L.DomEvent.stopPropagation(e); 
                showDetails(p, false, e.target); 
            }); 
        }
        function addWalk(w) { 
            const poly = L.polyline(w.path, {color: w.color || '#2563eb', weight:5, zIndex: 500}).addTo(mapItems); 
            poly.on('mouseover', () => poly.setStyle({weight: 8}));
            poly.on('mouseout', () => poly.setStyle({weight: 5}));
            poly.on('click', (e) => { 
                L.DomEvent.stopPropagation(e); 
                const sidePadding = document.body.classList.contains('mobile-mode') ? 20 : (parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidebar')) + 40); 
                const bottomPadding = document.body.classList.contains('mobile-mode') ? (window.innerHeight / 2) : 40; 
                map.flyToBounds(e.target.getBounds(), { paddingBottomRight: [sidePadding, bottomPadding], paddingTopLeft: [20, 20], duration: 1.5 }); 
                map.once('moveend', () => showDetails(w, true, e.target)); 
            }); 
        }
        function refreshMapItems() { updateHighlights(); }

        function showDetails(item, isWalk, layer) {
            if (!item) return;
            // Ensure we work with the original storage object, not a filtered copy
            const realItem = storage.pins.find(p => p.id === item.id) || storage.walks.find(w => w.id === item.id);
            if (realItem) item = realItem;

            if (elevationAbortController) { elevationAbortController.abort(); elevationAbortController = null; }
            activeSelectionId = item.id; isEditing = false; graphOpen = false; selectedColor = item.color || PIN_TYPES[0].color;
            editingCommentId = null;
            document.getElementById('editTypeContainer').style.display = 'none'; document.getElementById('explore-panel').style.display = 'none'; document.getElementById('add-panel').style.display = 'none'; document.getElementById('settings-panel').style.display = 'none'; document.getElementById('mainTabs').style.display = 'none'; document.getElementById('mainSearch').style.display = 'none'; 
            document.getElementById('backBtn').style.display = 'flex'; document.getElementById('minimizeBtn').style.display = 'none';
            document.getElementById('detail-view').style.display = 'flex';
            document.getElementById('editWalkOptions').style.display = 'none';
            
            // Only allow edit/delete if owner
            const isOwner = currentUser && item.userId === currentUser.uid;
            document.getElementById('floatEditBtn').style.display = isOwner ? 'flex' : 'none';
            
            if(isWalk) { document.querySelectorAll('#editModeSelector .mode-btn').forEach(btn => { btn.classList.toggle('active', btn.dataset.mode === (item.activity || 'walk')); }); }
            if(document.body.classList.contains('mobile-mode')) snapTo('half');
            const floatEdit = document.getElementById('floatEditBtn'); floatEdit.innerHTML = 'üñãÔ∏è'; floatEdit.classList.remove('is-editing');
            document.getElementById('floatDeleteBtn').style.display = 'none'; document.getElementById('floatUploadBtn').style.display = 'none';
            document.getElementById('detPhoto').src = item.photo || "https://placehold.co/500x300?text=No+Photo";
            document.getElementById('editTitle').value = item.name; document.getElementById('editDesc').value = item.desc || "";
            document.querySelectorAll('.edit-input').forEach(i=>i.classList.remove('active'));
            
            const creatorDiv = document.getElementById('detCreator');
            creatorDiv.innerText = item.creatorName ? `Uploaded by ${item.creatorName}` : '';
            if(item.userId && !item.creatorName) {
                db.collection('users').doc(item.userId).get().then(doc => {
                    if(doc.exists && doc.data().displayName) { item.creatorName = doc.data().displayName; creatorDiv.innerText = `Uploaded by ${item.creatorName}`; saveData(); }
                }).catch(()=>{});
            }

            waypointMarkers.forEach(m => map.removeLayer(m)); waypointMarkers = [];
            renderComments(item);
            updateDetailRating(item);
            if (isWalk) { 
                window.currentActiveLayer = layer || mapItems.getLayers().find(l => l instanceof L.Polyline && JSON.stringify(l.getLatLngs()[0]) === JSON.stringify(L.latLng(item.path[0][0], item.path[0][1]))); 
                updateWalkStats(); 
                fetchElevation(item.path, false); 
                updateWalkWaypoints(); 
            }
            else { document.getElementById('detStats').innerHTML = ``; closeElevation(); window.currentActiveLayer = null; }
            nodeHandles.forEach(h=>map.removeLayer(h));
            resetSidebarScroll();
        }

        function updateDetailRating(item) {
            const rDiv = document.getElementById('detRating');
            if(!rDiv) return;
            if (item.comments && item.comments.length > 0) {
                rDiv.style.display = 'flex';
                rDiv.innerHTML = `‚òÖ ${(item.rating || 0).toFixed(1)}`;
            } else {
                rDiv.style.display = 'none';
            }
        }

        function renderComments(item) {
            const container = document.getElementById('commentsSection');
            if(!container) return;
            
            let html = "";

            if(currentUser) {
                const btnText = editingCommentId ? "Update Review" : "Post Review";
                const cancelBtn = editingCommentId ? `<button class="btn" onclick="cancelEdit()" style="margin-top:5px; background:transparent; border:1px solid var(--border);">Cancel</button>` : '';
                const title = editingCommentId ? 'Edit Review' : 'Rate & Review';
                html += `<div class="new-comment-box" style="margin-top:0;"><span class="settings-label">${title}</span><div class="star-input" id="commentStarInput"><span data-v="1">‚òÖ</span><span data-v="2">‚òÖ</span><span data-v="3">‚òÖ</span><span data-v="4">‚òÖ</span><span data-v="5">‚òÖ</span></div><textarea id="newCommentText" class="modal-input" rows="3" placeholder="Write a review..." style="margin-bottom:10px;"></textarea><button class="btn btn-save-action" onclick="postComment()">${btnText}</button>${cancelBtn}</div>`;
            } else {
                html += `<div style="padding:10px; background:rgba(0,0,0,0.05); border-radius:8px; text-align:center; font-size:12px;">Log in to leave a review.</div>`;
            }
            
            const count = item.comments ? item.comments.length : 0;
            html += `<div onclick="toggleReviewsList()" style="cursor:pointer; display:flex; justify-content:space-between; align-items:center; margin-top:15px; padding: 5px 0; border-bottom: 1px solid var(--border);">
                <h4 style="margin:0; font-size:14px;">Reviews (${count})</h4>
                <span id="reviewsChevron" style="font-size:10px; opacity:0.6; transform: rotate(-90deg); transition: 0.2s;">‚ñº</span>
            </div>`;

            html += `<div id="reviewsListContainer" style="display:none; margin-top:10px;">`;
            if(item.comments && item.comments.length > 0) {
                item.comments.sort((a,b) => {
                    if(currentUser && a.userId === currentUser.uid && b.userId !== currentUser.uid) return -1;
                    if(currentUser && b.userId === currentUser.uid && a.userId !== currentUser.uid) return 1;
                    return b.timestamp - a.timestamp;
                }).forEach(c => {
                    const date = new Date(c.timestamp).toLocaleDateString();
                    const stars = '‚òÖ'.repeat(c.rating) + '‚òÜ'.repeat(5 - c.rating);
                    let actions = '';
                    if(currentUser && c.userId === currentUser.uid) {
                        actions = `<div class="comment-actions"><button class="comment-action-btn" onclick="editComment(${item.id}, ${c.id})">Edit</button><button class="comment-action-btn" onclick="deleteComment(${item.id}, ${c.id})">Delete</button></div>`;
                    }
                    html += `<div class="comment-item"><div class="comment-header"><span class="comment-user">${c.displayName || 'Anonymous'}</span><span class="comment-date">${date}</span></div><div class="comment-stars">${stars}</div><p class="comment-text">${c.text}</p>${actions}</div>`;
                });
            } else {
                html += `<p style="font-size:12px; opacity:0.6; font-style:italic;">No reviews yet.</p>`;
            }
            html += `</div>`;

            container.innerHTML = html;

            if(currentUser) {
                if(editingCommentId && item.comments) {
                    const c = item.comments.find(x => x.id === editingCommentId);
                    if(c) {
                        document.getElementById('newCommentText').value = c.text;
                        window.currentCommentRating = c.rating;
                        const stars = document.querySelectorAll('#commentStarInput span');
                        stars.forEach(st => st.classList.toggle('active', parseInt(st.dataset.v) <= c.rating));
                    }
                }

                let selectedRating = 0;
                const stars = document.querySelectorAll('#commentStarInput span');
                stars.forEach(s => {
                    s.onclick = () => {
                        selectedRating = parseInt(s.dataset.v);
                        stars.forEach(st => st.classList.toggle('active', parseInt(st.dataset.v) <= selectedRating));
                        window.currentCommentRating = selectedRating;
                    };
                });
            }
        }

        function toggleReviewsList() {
            const list = document.getElementById('reviewsListContainer');
            const chev = document.getElementById('reviewsChevron');
            if(list && chev) {
                const isHidden = list.style.display === 'none';
                list.style.display = isHidden ? 'block' : 'none';
                chev.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(-90deg)';
            }
        }

        async function postComment() {
            if(!activeSelectionId || !currentUser) return;
            
            let currentDisplayName = currentUser.displayName;
            try {
                const uDoc = await db.collection('users').doc(currentUser.uid).get();
                if(uDoc.exists && uDoc.data().displayName) currentDisplayName = uDoc.data().displayName;
            } catch(e){}

            const text = document.getElementById('newCommentText').value.trim();
            const rating = window.currentCommentRating || 0;
            if(rating === 0) { alert("Please select a star rating."); return; }
            if(!text) { alert("Please write a review."); return; }

            const item = storage.pins.find(p=>p.id===activeSelectionId) || storage.walks.find(w=>w.id===activeSelectionId);
            if(!item) return;
            if(!item.comments) item.comments = [];
            
            if(editingCommentId) {
                const idx = item.comments.findIndex(c => c.id === editingCommentId);
                if(idx !== -1) {
                    item.comments[idx].text = text;
                    item.comments[idx].rating = rating;
                    item.comments[idx].timestamp = Date.now();
                }
                editingCommentId = null;
            } else {
                item.comments.push({ id: Date.now(), userId: currentUser.uid, displayName: currentDisplayName || "User", text: text, rating: rating, timestamp: Date.now() });
            }
            
            const total = item.comments.reduce((acc, c) => acc + c.rating, 0);
            item.rating = Math.round(total / item.comments.length);

            saveData(); await saveToCloud(item.path ? 'walks' : 'pins', item);
            renderComments(item); updateHighlights();
            updateDetailRating(item);
        }

        function editComment(itemId, commentId) {
            editingCommentId = commentId;
            const item = storage.pins.find(p=>p.id===itemId) || storage.walks.find(w=>w.id===itemId);
            renderComments(item);
        }

        function cancelEdit() {
            editingCommentId = null;
            const item = storage.pins.find(p=>p.id===activeSelectionId) || storage.walks.find(w=>w.id===activeSelectionId);
            window.currentCommentRating = 0;
            renderComments(item);
        }

        async function deleteComment(itemId, commentId) {
            if(!confirm("Delete this review?")) return;
            const item = storage.pins.find(p=>p.id===itemId) || storage.walks.find(w=>w.id===itemId);
            item.comments = item.comments.filter(c => c.id !== commentId);
            
            const total = item.comments.reduce((acc, c) => acc + c.rating, 0);
            item.rating = item.comments.length ? Math.round(total / item.comments.length) : 0;

            saveData(); await saveToCloud(item.path ? 'walks' : 'pins', item);
            renderComments(item); updateHighlights();
            updateDetailRating(item);
        }

        function updateWalkWaypoints() { 
            waypointMarkers.forEach(m => map.removeLayer(m)); 
            waypointMarkers = []; 
            const item = storage.walks.find(w => w.id === activeSelectionId); 
            if(item && item.path.length > 0) { 
                const startPt = item.path[0]; 
                const endPt = item.path[item.path.length-1]; 
                waypointMarkers.push(L.marker(startPt, { icon: L.divIcon({ className: 'walk-marker-icon start-icon', html: '<div class="rotate-wrapper">‚ñ∂</div>', iconSize: [24, 24], iconAnchor: [12, 12] }), zIndexOffset: 2000 }).addTo(map)); 
                waypointMarkers.push(L.marker(endPt, { icon: L.divIcon({ className: 'walk-marker-icon end-icon', html: '<div class="rotate-wrapper">üèÅ</div>', iconSize: [24, 24], iconAnchor: [12, 12] }), zIndexOffset: 2000 }).addTo(map)); 
            } 
        }
        
        function toggleGraph() { 
            graphOpen = !graphOpen; 
            const btn = document.getElementById('toggleGraphBtn') || document.querySelector('.hud-btn.elev-toggle') || document.getElementById('drawGraphBtn'); 
            if(btn) btn.innerHTML = graphOpen ? 'üìâ Hide Height Graph' : 'üìà Show Height Graph'; 
            if (graphOpen) { 
                if(document.body.classList.contains('mobile-mode') && !isRecording) snapTo('bottom');
                if(isRecording) renderLiveRecordingGraph();
                else if (currentMode === 'walk' && tempPath.length > 0) {
                    fetchElevation(tempPath, true);
                } else {
                    const item = storage.walks.find(w => w.id === activeSelectionId); 
                    if (item) renderInstantGraph(item);
                }
            } else { closeElevation(); } 
        }

        function renderInstantGraph(item) {
            if(!item.elevData || item.elevData.length === 0) {
                fetchElevation(item.path, true);
                return;
            }
            document.getElementById('elevation-dock').classList.add('active');
            let currentTotal = 0, distData = [0]; 
            for(let j = 1; j < item.path.length; j++){ 
                currentTotal += L.latLng(item.path[j-1][0], item.path[j-1][1]).distanceTo(L.latLng(item.path[j][0], item.path[j][1])); 
                distData.push(currentTotal / 1000); 
            }
            const ctx = document.getElementById('elevChart').getContext('2d'); 
            if(chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, { 
                type:'line', 
                data:{ 
                    labels: distData.map(d => d.toFixed(1)), 
                    datasets:[{ data:item.elevData, borderColor:'#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.15)', fill:true, pointRadius:0, borderWidth: 2, tension:0.4, cubicInterpolationMode: 'monotone' }] 
                }, 
                options:{ 
                    maintainAspectRatio:false, 
                    plugins:{ legend:{display:false} }, 
                    scales:{ x:{ title:{display:true, text:'km'} }, y:{ title:{display:true, text:'m'}, position:'right' } } 
                },
                plugins: [{
                    id: 'flyoverProgress',
                    afterDraw: (chart) => {
                        if (typeof window.flyoverDistance !== 'number' || window.flyoverDistance === null) return;
                        const ctx = chart.ctx;
                        const xAxis = chart.scales.x;
                        const yAxis = chart.scales.y;
                        const totalDist = parseFloat(chart.data.labels[chart.data.labels.length-1]);
                        const pct = Math.min(1, Math.max(0, window.flyoverDistance / totalDist));
                        const x = xAxis.left + (xAxis.width * pct);
                        const dataIndex = Math.floor(pct * (chart.data.datasets[0].data.length - 1));
                        const y = yAxis.getPixelForValue(chart.data.datasets[0].data[dataIndex]);
                        ctx.save(); ctx.beginPath(); ctx.moveTo(x, yAxis.top); ctx.lineTo(x, yAxis.bottom); ctx.lineWidth = 1; ctx.strokeStyle = '#ef4444'; ctx.stroke(); ctx.beginPath(); ctx.arc(x, y, 5, 0, 2 * Math.PI); ctx.fillStyle = '#ef4444'; ctx.fill(); ctx.restore();
                    }
                }]
            });
        }

        function updateWalkStats() {
            const layer = window.currentActiveLayer; const item = storage.walks.find(w => w.id === activeSelectionId); if(!item) return;
            let d = 0; if (layer) { const lls = layer.getLatLngs(); for(let j=1; j<lls.length; j++) d += lls[j-1].distanceTo(lls[j]); item.dist = (d/1000).toFixed(2); item.path = lls.map(l => [l.lat, l.lng]); } else d = parseFloat(item.dist) * 1000;
            let ascent = 0, descent = 0, minE = 0, maxE = 0;
            if(item.elevData && item.elevData.length > 0) {
                minE = Math.round(Math.min(...item.elevData)); maxE = Math.round(Math.max(...item.elevData));
                for(let i=1; i<item.elevData.length; i++) { let diff = item.elevData[i] - item.elevData[i-1]; if(diff > 0) ascent += diff; else descent += Math.abs(diff); }
            }
            
            let totalMins = 0;
            let timeLabel = "Estimated Time";
            if (item.recordedTime && item.recordedTime > 0) {
                totalMins = item.recordedTime;
                timeLabel = "Actual Time";
            } else {
                let speed = storage.speeds[item.activity || 'walk'] || 5;
                totalMins = Math.round((parseFloat(item.dist) / speed) * 60);
            }

            let hours = Math.floor(totalMins / 60), mins = totalMins % 60;            
            document.getElementById('detStats').innerHTML = `<div class="stats-grid"><div class="stat-card"><span class="stat-label">Length</span><span class="stat-value">${formatDist(item.dist)}</span></div><div class="stat-card"><span class="stat-label">${timeLabel}</span><span class="stat-value">${hours > 0 ? hours + 'h ' : ''}${mins}m</span></div><div class="stat-card-dual"><div class="dual-row"><span class="stat-sub-label">Total Climb</span><span class="stat-sub-value">${formatElev(ascent)}</span></div><div class="dual-divider"></div><div class="dual-row"><span class="stat-sub-label">Total Descent</span><span class="stat-sub-value">${formatElev(descent)}</span></div></div><div class="stat-card-dual"><div class="dual-row"><span class="stat-sub-label">Min Height</span><span class="stat-sub-value">${formatElev(minE)}</span></div><div class="dual-divider"></div><div class="dual-row"><span class="stat-sub-label">Max Height</span><span class="stat-sub-value">${formatElev(maxE)}</span></div></div><button class="elev-toggle-btn" onclick="startFlyover()" style="margin-bottom:5px;">‚úàÔ∏è Flyover</button><button id="toggleGraphBtn" class="elev-toggle-btn" onclick="toggleGraph()"><span>${graphOpen ? 'üìâ' : 'üìà'}</span> ${graphOpen ? 'Hide Height Graph' : 'Show Height Graph'}</button></div>`;
            updateWalkWaypoints(); saveData();
            saveToCloud('walks', item);
        }

        function toggleEditingLogic() {
            const item = storage.pins.find(p=>p.id===activeSelectionId) || storage.walks.find(w=>w.id===activeSelectionId);
            if (!item) return;

            if (!currentUser || item.userId !== currentUser.uid) {
                alert("You can only edit your own items.");
                return;
            }

            isEditing = !isEditing; const editBtn = document.getElementById('floatEditBtn'); editBtn.innerHTML = isEditing ? '‚úÖ' : 'üñãÔ∏è'; editBtn.classList.toggle('is-editing', isEditing);
            document.getElementById('floatDeleteBtn').style.display = isEditing ? 'flex' : 'none'; 
            document.getElementById('floatUploadBtn').style.display = isEditing ? 'flex' : 'none'; 
            
            const isWalk = (item.path !== undefined);
            document.getElementById('editTypeContainer').style.display = (isEditing && !isWalk) ? 'block' : 'none';
            document.getElementById('editWalkOptions').style.display = (isEditing && isWalk) ? 'block' : 'none';
            document.getElementById('editPrivacyContainer').style.display = isEditing ? 'block' : 'none';
            
            if(isEditing) { setupTypePickers(); walkHistory = []; }
            document.querySelectorAll('.edit-input').forEach(inp => inp.classList.toggle('active', isEditing));
            if(isEditing && window.currentActiveLayer instanceof L.Polyline) { createNodes(window.currentActiveLayer); } 
            else { nodeHandles.forEach(h=>map.removeLayer(h)); nodeHandles = []; }
            document.getElementById('editTitle').oninput = () => { item.name = document.getElementById('editTitle').value; saveData(); updateHighlights(); saveToCloud(item.path ? 'walks' : 'pins', item); };
            document.getElementById('editDesc').oninput = () => { item.desc = document.getElementById('editDesc').value; saveData(); saveToCloud(item.path ? 'walks' : 'pins', item); };
            
            if(isEditing) {
                const pubToggle = document.getElementById('editPublicToggle');
                pubToggle.checked = item.isPublic || false;
                pubToggle.onchange = (e) => {
                    item.isPublic = e.target.checked;
                    saveData();
                    saveToCloud(item.path ? 'walks' : 'pins', item);
                    updateHighlights();
                };
            }
        }

        floatEditBtn.onclick = toggleEditingLogic;

        function getBearing(startLat, startLng, destLat, destLng) {
            const startLatRad = startLat * (Math.PI / 180);
            const startLngRad = startLng * (Math.PI / 180);
            const destLatRad = destLat * (Math.PI / 180);
            const destLngRad = destLng * (Math.PI / 180);

            const y = Math.sin(destLngRad - startLngRad) * Math.cos(destLatRad);
            const x = Math.cos(startLatRad) * Math.sin(destLatRad) -
                        Math.sin(startLatRad) * Math.cos(destLatRad) * Math.cos(destLngRad - startLngRad);
            const brng = Math.atan2(y, x);
            return (brng * 180 / Math.PI + 360) % 360;
        }

        // Helper to get interpolated point at specific distance
        function getPointAtDistance(path, d, totalDist, cumDists) {
            if (d <= 0) return path[0];
            if (d >= totalDist) return path[path.length - 1];
            
            // Find segment
            for (let i = 0; i < cumDists.length; i++) {
                if (cumDists[i] >= d) {
                    const p1 = path[i];
                    const p2 = path[i+1];
                    const segmentStartDist = (i === 0) ? 0 : cumDists[i-1];
                    const segmentLen = cumDists[i] - segmentStartDist;
                    const ratio = (d - segmentStartDist) / segmentLen;
                    return [
                        p1[0] + (p2[0] - p1[0]) * ratio,
                        p1[1] + (p2[1] - p1[1]) * ratio
                    ];
                }
            }
            return path[path.length - 1];
        }

        async function startFlyover() {
            const item = storage.walks.find(w=>w.id===activeSelectionId);
            if(!item || !item.path) return;
            
            isFlying = true;
            document.getElementById('flyoverControls').style.display = 'flex';
            map.stop();
            document.getElementById('sidebar').classList.add('minimized');
            document.getElementById('expandBtn').style.display = 'flex';
            document.body.classList.add('is-flying');

            if(!graphOpen) toggleGraph();

            // Calculate speed for time estimation based on activity type
            let speedKmH = storage.speeds[item.activity || 'walk'] || 5;
            
            // Use actual average speed if it was a recorded activity
            if(item.recordedTime && item.recordedTime > 0 && parseFloat(item.dist) > 0) {
                speedKmH = parseFloat(item.dist) / (item.recordedTime / 60);
            }

            // Pre-calculate distances for optimization
            const path = item.path;
            let totalDist = 0;
            const cumDists = [];
            for(let i=0; i<path.length-1; i++) {
                totalDist += L.latLng(path[i]).distanceTo(L.latLng(path[i+1]));
                cumDists.push(totalDist);
            }
            
            // Add Fly Marker
            if(flyMarker) map.removeLayer(flyMarker);
            flyMarker = L.marker(path[0], {
                icon: L.divIcon({ className: '', html: '<div class="gps-indicator-wrapper" style="transform:scale(0.6);"><div class="gps-indicator"></div><div class="gps-pulse"></div></div>', iconSize: [10, 10], iconAnchor: [5, 5] }),
                zIndexOffset: 9999
            }).addTo(map);

            // Set initial values
            currentFlyZoom = 17.0;
            currentFlySpeed = 1.0;
            flyStartTime = Date.now();
            document.getElementById('flyZoomDisplay').innerText = currentFlyZoom.toFixed(1);
            document.getElementById('flySpeedDisplay').innerText = '1.0x';

            let currentDist = 0;
            let lastTime = 0;
            let currentBearing = getBearing(path[0][0], path[0][1], path[1][0], path[1][1]);
            
            // Base speed: 50 meters per second (180 km/h) as base 1x
            const baseSpeedMPS = 50; 

            function animate(time) {
                if (!isFlying) return;
                if (!lastTime) lastTime = time;
                const dt = time - lastTime;
                lastTime = time;

                const speedMult = currentFlySpeed;
                const moveDist = baseSpeedMPS * speedMult * (dt / 1000);
                currentDist += moveDist;

                // Update Stats
                document.getElementById('flyStatDist').innerText = formatDist(currentDist / 1000);
                
                // Estimated Time based on activity speed
                const distKm = currentDist / 1000;
                const totalSeconds = (distKm / speedKmH) * 3600;
                
                const hrs = Math.floor(totalSeconds / 3600);
                const mins = Math.floor((totalSeconds % 3600) / 60);
                const secs = Math.floor(totalSeconds % 60);
                
                const timeStr = (hrs > 0 ? `${hrs}:` : '') + `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                document.getElementById('flyStatTime').innerText = timeStr;

                // Elevation
                if (item.elevData && item.elevData.length > 0) {
                    const elevIndex = Math.min(item.elevData.length - 1, Math.floor((currentDist / totalDist) * item.elevData.length));
                    document.getElementById('flyStatElev').innerText = formatElev(item.elevData[elevIndex]);
                }

                window.flyoverDistance = currentDist / 1000;
                if(chartInstance) chartInstance.draw();

                if (currentDist >= totalDist) {
                    stopFlyover();
                    return;
                }

                // Get current position
                const pos = getPointAtDistance(path, currentDist, totalDist, cumDists);
                
                // Look ahead 40 meters for smooth bearing
                const lookAheadDist = 100; // Increased look-ahead for smoother turns
                const lookAheadPos = getPointAtDistance(path, currentDist + lookAheadDist, totalDist, cumDists);

                const targetBearing = getBearing(pos[0], pos[1], lookAheadPos[0], lookAheadPos[1]);
                let diff = targetBearing - currentBearing;
                while (diff < -180) diff += 360;
                while (diff > 180) diff -= 360;
                currentBearing += diff * 0.02; // Very smooth turn rate

                const zoomLevel = currentFlyZoom;
                map.setView(pos, zoomLevel, { animate: false });
                
                // Scale 2.5 to ensure map covers screen during rotation
                document.getElementById('map').style.transform = `rotateZ(-${currentBearing}deg) scale(2.5)`;
                
                if(flyMarker) flyMarker.setLatLng(pos);

                flyAnimationId = requestAnimationFrame(animate);
            }
            
            flyAnimationId = requestAnimationFrame(animate);
        }

        function stopFlyover() {
            isFlying = false;
            if(flyAnimationId) cancelAnimationFrame(flyAnimationId);
            document.getElementById('flyoverControls').style.display = 'none';
            document.getElementById('sidebar').classList.remove('minimized');
            document.body.classList.remove('is-flying');
            document.getElementById('map').style.transform = ''; // Reset transform
            if(flyMarker) { map.removeLayer(flyMarker); flyMarker = null; }
            window.flyoverDistance = null;
            if(chartInstance) chartInstance.draw();
            
            const item = storage.pins.find(p=>p.id===activeSelectionId) || storage.walks.find(w=>w.id===activeSelectionId);
            if(item) {
                if(item.path) {
                     const poly = L.polyline(item.path);
                     map.fitBounds(poly.getBounds(), {padding:[50,50]});
                } else {
                    map.flyTo([item.lat, item.lng], 15);
                }
            }
        }

        function createNodes(layer) {
            nodeHandles.forEach(h => map.removeLayer(h)); nodeHandles = []; const latlngs = layer.getLatLngs();
            latlngs.forEach((ll, i) => {
                let moved = false; const isStartOrEnd = (i === 0 || i === latlngs.length - 1);
                const handleClass = isStartOrEnd ? 'node-handle node-handle-hidden' : 'node-handle node-handle-visible';
                const m = L.marker(ll, { draggable: true, icon: L.divIcon({ className: handleClass, iconSize:[isStartOrEnd?30:16, isStartOrEnd?30:16], iconAnchor:[isStartOrEnd?15:8, isStartOrEnd?15:8] }), zIndexOffset: 10000 }).addTo(map);
                m.on('drag', (e) => { moved = true; const currentLls = layer.getLatLngs(); currentLls[i] = e.target.getLatLng(); layer.setLatLngs(currentLls); updateWalkStats(); });
                m.on('dragend', () => { createNodes(layer); fetchElevation(layer.getLatLngs().map(l => [l.lat, l.lng]), false); });
                m.on('click', (e) => { L.DomEvent.stopPropagation(e); if (!moved && layer.getLatLngs().length > 2) { const currentLls = layer.getLatLngs(); currentLls.splice(i, 1); layer.setLatLngs(currentLls); updateWalkStats(); createNodes(layer); fetchElevation(currentLls.map(l => [l.lat, l.lng]), false); } });
                nodeHandles.push(m);
                if (i < latlngs.length - 1) {
                    const midH = L.marker(L.latLng((ll.lat + latlngs[i+1].lat) / 2, (ll.lng + latlngs[i+1].lng) / 2), { draggable: true, icon: L.divIcon({ className:'mid-handle mid-handle-visible', iconSize:[12,12], iconAnchor:[6,6] }), zIndexOffset: 9000 }).addTo(map);
                    midH.on('dragstart', (e) => { const currentLls = layer.getLatLngs(); currentLls.splice(i + 1, 0, e.target.getLatLng()); layer.setLatLngs(currentLls); });
                    midH.on('drag', (e) => { const currentLls = layer.getLatLngs(); currentLls[i + 1] = e.target.getLatLng(); layer.setLatLngs(currentLls); updateWalkStats(); });
                    midH.on('dragend', () => { createNodes(layer); fetchElevation(layer.getLatLngs().map(l => [l.lat, l.lng]), false); });
                    nodeHandles.push(midH);
                }
            });
        }

        async function fetchElevation(path, forceOpen) {
            if (elevationAbortController) elevationAbortController.abort(); elevationAbortController = new AbortController(); const signal = elevationAbortController.signal;
            try {
                let sampledPoints = [];
                for (let i = 0; i < path.length - 1; i++) {
                    const start = L.latLng(path[i][0], path[i][1]), end = L.latLng(path[i+1][0], path[i+1][1]), dist = start.distanceTo(end); sampledPoints.push(start);
                    const numSteps = Math.floor(dist / 100); for (let j = 1; j <= numSteps; j++) { const ratio = (j * 100) / dist; sampledPoints.push(L.latLng(start.lat + (end.lat - start.lat) * ratio, start.lng + (end.lng - start.lng) * ratio)); }
                }
                sampledPoints.push(L.latLng(path[path.length - 1][0], path[path.length - 1][1]));
                const res = await fetch('https://api.open-elevation.com/api/v1/lookup', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ locations: sampledPoints.map(p => ({ latitude: p.lat, longitude: p.lng })) }), signal: signal }).then(r=>r.json());
                const elevs = res.results.map(r => r.elevation); 
                const item = storage.walks.find(w => w.id === activeSelectionId);
                if (item) item.elevData = elevs; 
                if (graphOpen || forceOpen) {
                    const isImp = storage.units === 'imperial';
                    let currentTotal = 0, distData = [0]; for(let i = 1; i < sampledPoints.length; i++){ currentTotal += sampledPoints[i-1].distanceTo(sampledPoints[i]); distData.push(currentTotal / 1000); }
                    document.getElementById('elevation-dock').classList.add('active');
                    const ctx = document.getElementById('elevChart').getContext('2d'); if(chartInstance) chartInstance.destroy();
                    chartInstance = new Chart(ctx, { type:'line', data:{ labels: distData.map(d => isImp ? (d * 0.621371).toFixed(1) : d.toFixed(1)), datasets:[{ data: elevs.map(e => isImp ? e * 3.28084 : e), borderColor:'#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.15)', fill:true, pointRadius:0, borderWidth: 2, tension:0.4, cubicInterpolationMode: 'monotone' }] }, options:{ maintainAspectRatio:false, plugins:{ legend:{display:false} }, scales:{ x:{ title:{display:true, text: isImp ? 'mi' : 'km'} }, y:{ title:{display:true, text: isImp ? 'ft' : 'm'}, position:'right' } } } });
                }
                if(item) updateWalkStats(); 
            } catch(e) { if (e.name !== 'AbortError') console.error(e); }
        }

        closeElevBtn.onclick = (e) => { L.DomEvent.stopPropagation(e); graphOpen = false; closeElevation(); if(activeSelectionId) updateWalkStats(); };
        function closeElevation() { document.getElementById('elevation-dock').classList.remove('active'); if(document.body.classList.contains('mobile-mode')) { document.getElementById('sidebar').classList.remove('hidden-sheet'); } if(chartInstance) { chartInstance.destroy(); chartInstance = null; } if (elevationAbortController) { elevationAbortController.abort(); elevationAbortController = null; } const btn = document.getElementById('toggleGraphBtn') || document.querySelector('.hud-btn.elev-toggle') || document.getElementById('drawGraphBtn'); if(btn) btn.innerHTML = 'üìà Show Height Graph'; }
        
        function saveData() { 
            localStorage.setItem('geojournal_v11', JSON.stringify({ theme: storage.theme, mapStyle: storage.mapStyle, isMobile: storage.isMobile, units: storage.units, speeds: storage.speeds })); 
        }
        
        async function deleteAction() { 
            if(!activeSelectionId) return;
            const item = storage.pins.find(p=>p.id===activeSelectionId) || storage.walks.find(w=>w.id===activeSelectionId);
            if (item && item.userId !== currentUser.uid) { alert("You can only delete your own items."); return; }
            if(confirm("Delete this entry forever?")){ 
                try {
                    const isWalk = storage.walks.some(w => w.id === activeSelectionId);
                    const collection = isWalk ? "walks" : "pins";
                    await db.collection(collection).doc(activeSelectionId.toString()).delete();
                    storage.pins = storage.pins.filter(p => p.id !== activeSelectionId); 
                    storage.walks = storage.walks.filter(w => w.id !== activeSelectionId); 
                    waypointMarkers.forEach(m => map.removeLayer(m)); waypointMarkers = [];
                    refreshMapItems(); 
                    goBack(); 
                } catch (e) { alert("Delete failed: " + e.message); }
            } 
        }
        
        async function makeAllPrivate() {
            if(!currentUser) return;
            if(!confirm("WARNING: This will make ALL your pins and activities private. They will no longer be visible to other users. This action cannot be easily undone. Continue?")) return;
            
            const myPins = storage.pins.filter(p => p.userId === currentUser.uid);
            for(let p of myPins) {
                p.isPublic = false;
                await saveToCloud('pins', p);
            }
            
            const myWalks = storage.walks.filter(w => w.userId === currentUser.uid);
            for(let w of myWalks) {
                w.isPublic = false;
                await saveToCloud('walks', w);
            }
            
            saveData();
            updateHighlights();
            alert("All items set to private.");
        }

        function deleteAccount() {
            if(!currentUser) return;
            if(confirm("DANGER: Are you sure you want to delete your account? This will permanently delete your login credentials. Your data may remain unless you delete it first. This action cannot be undone.")) {
                currentUser.delete().then(() => {
                    alert("Account deleted.");
                    location.reload();
                }).catch((error) => {
                    alert("Error deleting account: " + error.message);
                });
            }
        }

        themeToggle.onchange = (e) => { const newTheme = e.target.checked ? 'dark' : 'light'; storage.theme = newTheme; document.body.classList.remove('light-theme', 'dark-theme'); document.body.classList.add(newTheme + '-theme'); saveData(); };
        
        mainSearch.addEventListener('input', (e) => { activeFilters.search = e.target.value; updateHighlights(); });
        mainSearch.addEventListener('keypress', (e) => { if(e.key==='Enter') fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${e.target.value}`).then(r=>r.json()).then(d=>d.length && map.flyTo([d[0].lat, d[0].lon], 15)); });
        
        // AUTH LOGIC
        document.getElementById('btnLogin').onclick = () => {
            const email = document.getElementById('authEmail').value;
            const pass = document.getElementById('authPass').value;
            auth.signInWithEmailAndPassword(email, pass).catch(e => document.getElementById('authMessage').innerText = e.message);
        };

        document.getElementById('btnSignup').onclick = () => {
            const email = document.getElementById('authEmail').value;
            const pass = document.getElementById('authPass').value;
            auth.createUserWithEmailAndPassword(email, pass)
                .then(cred => {
                    cred.user.sendEmailVerification();
                    document.getElementById('authMessage').innerText = "Verification email sent! Please verify and log in.";
                    auth.signOut();
                })
                .catch(e => document.getElementById('authMessage').innerText = e.message);
        };

        document.getElementById('btnGoogle').onclick = () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(e => document.getElementById('authMessage').innerText = e.message);
        };

        document.getElementById('btnForgot').onclick = () => {
            const email = document.getElementById('authEmail').value;
            if(!email) {
                document.getElementById('authMessage').innerText = "Please enter your email address first.";
                return;
            }
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    document.getElementById('authMessage').style.color = 'var(--accent)';
                    document.getElementById('authMessage').innerText = "Reset link sent to email!";
                })
                .catch(e => {
                    document.getElementById('authMessage').style.color = 'var(--danger)';
                    document.getElementById('authMessage').innerText = e.message;
                });
        };

        function signOut() { auth.signOut(); }

        auth.onAuthStateChanged(user => {
            if (user) {
                if (user.emailVerified) {
                    currentUser = user;
                    document.getElementById('userEmailDisplay').innerText = user.email;
                    if (user.displayName) {
                        document.getElementById('settingsDisplayName').value = user.displayName;
                    }
                    document.getElementById('profileRow').style.display = 'flex';
                    document.getElementById('auth-overlay').style.display = 'none';
                    document.body.classList.remove('auth-active');
                    checkUserProfile(user);
                    loadPermanentData();
                } else {
                    document.getElementById('authMessage').innerText = "Please verify your email address to continue.";
                    auth.signOut();
                }
            } else {
                currentUser = null;
                document.getElementById('auth-overlay').style.display = 'flex';
                document.body.classList.add('auth-active');
                loadPermanentData();
            }
        });

        async function checkUserProfile(user) {
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists && userDoc.data().displayName) {
                    currentUser.displayName = userDoc.data().displayName;
                    document.getElementById('settingsDisplayName').value = currentUser.displayName;
                    updateHighlights();
                } else {
                    document.getElementById('dn-overlay').style.display = 'flex';
                }
            } catch(e) { console.error("Profile check failed", e); }
        }

        async function saveDisplayName(isInitial) {
            const inputId = isInitial ? 'newDisplayName' : 'settingsDisplayName';
            const errId = isInitial ? 'dnError' : null;
            const name = document.getElementById(inputId).value.trim();
            
            if(name.length < 3) {
                if(errId) document.getElementById(errId).innerText = "Name must be at least 3 characters.";
                else alert("Name must be at least 3 characters.");
                return;
            }

            const snapshot = await db.collection('users').where('displayName', '==', name).get();
            if(!snapshot.empty) {
                const existing = snapshot.docs[0];
                if(existing.id !== currentUser.uid) {
                    if(errId) document.getElementById(errId).innerText = "This name is already taken.";
                    else alert("This name is already taken.");
                    return;
                }
            }

            await db.collection('users').doc(currentUser.uid).set({
                displayName: name,
                email: currentUser.email,
                lowerName: name.toLowerCase()
            }, { merge: true });

            try { await currentUser.updateProfile({ displayName: name }); } catch(e) {}

            currentUser.displayName = name;
            if(isInitial) {
                document.getElementById('dn-overlay').style.display = 'none';
                document.getElementById('settingsDisplayName').value = name;
            } else {
                alert("Display Name Updated!");
            }
        }

        document.getElementById('saveDNBtn').onclick = () => saveDisplayName(true);
        document.getElementById('updateDNBtn').onclick = () => saveDisplayName(false);

        switchTab('explore');
    </script>
</body>
</html>
