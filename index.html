<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TraceLog ‚îÇ Map your journey</title>
    <link rel="icon" href="Images/foot.png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google AdSense Script -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1243519901054274" crossorigin="anonymous"></script>

    <style>
        :root {
            --sidebar: 400px; 
            --primary: #2563eb; 
            --accent: #10b981;
            --danger: #ef4444;
            --bg: #f8fafc; 
            --card: rgba(255, 255, 255, 0.9); 
            --text: #0f172a; 
            --border: #e2e8f0;
            --transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dark-theme { 
            --bg: #0f172a; 
            --card: rgba(30, 41, 59, 0.9); 
            --text: #f1f5f9; 
            --border: #334155; 
        }

        body, html { 
            margin: 0; padding: 0; height: 100%; 
            font-family: 'Inter', sans-serif; overflow: hidden; 
            background: var(--bg); color: var(--text); 
            touch-action: none;
        }

        #app { display: flex; height: 100vh; position: relative; width: 100vw; }

        #sidebar { 
            position: absolute; left: 0; top: 0; width: var(--sidebar); 
            background: var(--card); backdrop-filter: blur(10px);
            border-right: 1px solid var(--border); display: flex; 
            flex-direction: column; z-index: 4000; height: 100vh; 
            box-sizing: border-box; transition: transform var(--transition), opacity var(--transition), height var(--transition), top var(--transition);
            box-shadow: 10px 0 30px rgba(0,0,0,0.05);
        }

        body.mobile-mode #sidebar {
            width: 100vw;
            height: 100vh;
            max-height: calc(100% - 6vh); 
            top: calc(100vh - 110px); 
            left: 0;
            border-right: none;
            border-top: 1px solid var(--border);
            border-radius: 25px 25px 0 0;
            transform: none !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            padding-bottom: env(safe-area-inset-bottom);
            touch-action: pan-y;
        }

        body.mobile-mode #sidebar.open { top: 6vh; }
        body.mobile-mode #sidebar.half { top: 50vh; }
        body.mobile-mode #sidebar.hidden-sheet { top: 100vh !important; }
        body.mobile-mode #expandBtn { display: none !important; }

        .drag-handle {
            width: 60px; height: 7px; background: var(--border);
            border-radius: 10px; margin: 15px auto 10px auto;
            flex-shrink: 0; cursor: pointer;
            transition: background 0.2s;
            display: none;
        }
        .drag-handle:hover { background: #cbd5e1; }
        body.mobile-mode .drag-handle { display: block; }

        #sidebar.minimized { transform: translateX(-100%); opacity: 0; pointer-events: none; }
        .sidebar-header { padding: 20px 20px 0 20px; flex-shrink: 0; position: relative; }
        body.mobile-mode .sidebar-header { padding-top: 0; }
        .logo-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; gap: 8px; }

        .icon-btn, .tab-btn, .filter-btn, .btn, .zoom-btn, .layer-item-btn, .elev-toggle-btn {
            background: var(--border); border: none; min-width: 34px; height: 34px; 
            border-radius: 10px; cursor: pointer; display: flex; align-items: center; 
            justify-content: center; color: var(--text); font-size: 14px; transition: 0.2s;
            flex-shrink: 0; font-family: 'Inter', sans-serif; font-weight: 700;
            padding: 0 10px; text-transform: uppercase;
        }

        .icon-btn:hover, .tab-btn:hover, .filter-btn:hover, .btn:hover, .zoom-btn:hover, .layer-item-btn:hover, .elev-toggle-btn:hover { 
            background: var(--primary); color: white; transform: scale(1.05); 
        }

        .tab-btn.active, .btn-main.active-mode, .layer-item-btn.active {
            background: var(--primary); color: white; opacity: 1;
        }

        .icon-btn, .zoom-btn { width: 34px; height: 34px; padding: 0; font-size: 18px; border-radius: 10px; }
        #backBtn { display: none; font-size: 20px; }

        #expandBtn {
            position: absolute; top: 20px; left: 20px; z-index: 1900; 
            display: none; background: var(--card); border: 1px solid var(--border);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); backdrop-filter: blur(10px);
        }

        #mainSearch {
            width:100%; padding:12px; border-radius:8px; border:1px solid var(--border); 
            background:var(--bg); color:var(--text); box-sizing:border-box; margin-bottom:15px;
        }

        .tab-nav { display: flex; gap: 8px; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .tab-btn { flex: 1; font-size: 10px; opacity: 0.6; }

        .sidebar-scroll-area { 
            flex: 1; overflow-y: auto; padding: 0 20px; margin: 0; 
            display: flex; flex-direction: column; 
            -webkit-overflow-scrolling: touch;
        }
        .sidebar-scroll-area::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        .modal::-webkit-scrollbar, 
        #fullEmojiGrid::-webkit-scrollbar, 
        #modalPhotoList::-webkit-scrollbar, 
        #modalReviewPhotoPreview::-webkit-scrollbar { 
            width: 4px; height: 4px; 
        }
        .modal::-webkit-scrollbar-track, #fullEmojiGrid::-webkit-scrollbar-track, #modalPhotoList::-webkit-scrollbar-track, #modalReviewPhotoPreview::-webkit-scrollbar-track { 
            background: transparent; 
        }
        .modal::-webkit-scrollbar-thumb, #fullEmojiGrid::-webkit-scrollbar-thumb, #modalPhotoList::-webkit-scrollbar-thumb, #modalReviewPhotoPreview::-webkit-scrollbar-thumb { 
            background: var(--border); border-radius: 4px; 
        }

        .scroll-spacer { height: 450px; flex-shrink: 0; pointer-events: none; }

        #map { width: 100vw; height: 100vh; z-index: 1; }

        .pin-wrapper { width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; }
        .pin-shape {
            width: 20px; height: 20px; border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg); border: 2px solid white;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.2), 0 4px 8px rgba(0,0,0,0.3); z-index: 500;
        }

        /* PIN TYPE GRID & BUTTONS */
        .pin-type-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 10px 0; }
        .type-btn {
            aspect-ratio: 1/1; border-radius: 12px; border: none; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: 0.2s; color: white; padding: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .type-btn:hover { transform: scale(1.05); filter: brightness(1.1); }
        .type-btn.active { outline: 3px solid var(--text); outline-offset: 2px; transform: scale(1.05); }
        .type-btn span { font-size: 8px; font-weight: 900; text-transform: uppercase; margin-top: 2px; }

        .settings-container { display: flex; flex-direction: column; gap: 8px; padding-top: 10px; }
        .settings-row-refined { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 16px; background: rgba(0,0,0,0.03); border-radius: 12px; border: 1px solid var(--border);
            gap: 10px;
        }
        .settings-header {
            width: 100%; height: 40px; border: none; background: transparent;
            color: var(--text); font-weight: 800; font-size: 12px; 
            cursor: pointer; display: flex; align-items: center; justify-content: space-between; 
            padding: 0 5px; transition: 0.2s; text-transform: uppercase;
            border-bottom: 1px solid var(--border); margin-bottom: 10px; margin-top: 5px;
        }
        .settings-header:hover { opacity: 0.7; }
        .settings-content { display: flex; flex-direction: column; gap: 8px; margin-bottom: 5px; }
        .settings-label { font-size: 13px; font-weight: 600; opacity: 0.9; }

        .switch { position: relative; display: inline-block; width: 42px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; position: absolute; appearance: none; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #cbd5e1; transition: .3s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }

        .detail-header-container { position: relative; border-radius: 12px; overflow: hidden; margin-bottom: 12px; height: 180px; background: #ddd; flex-shrink: 0; }
        #detPhoto { width: 100%; height: 100%; object-fit: cover; display: block; transition: opacity 1s ease-in-out; position: absolute; inset: 0; z-index: 1; opacity: 0; }
        #detPhoto.active { opacity: 1; z-index: 2; }
        #detPhotoBack { width: 100%; height: 100%; object-fit: cover; display: block; position: absolute; inset: 0; z-index: 0; }
        #detMiniMap { width: 100%; height: 100%; position: absolute; inset: 0; z-index: 1; background: #eee; opacity: 0; transition: opacity 1s ease-in-out; }
        #detMiniMap.active { opacity: 1; z-index: 2; }
        #detMiniMap .leaflet-control-container { display: none; }

        #detRating, .floating-action-btn, #detTypeOverlay { 
            position: absolute; background: rgba(15, 23, 42, 0.7); 
            backdrop-filter: blur(8px); padding: 6px 12px; border-radius: 8px;
            color: #fbbf24; font-size: 1rem; display: flex; gap: 3px; z-index: 10; border: 1px solid rgba(255,255,255,0.1);
            transition: 0.2s;
        }
        
        #detTypeOverlay { top: 12px; left: 12px; padding: 0; background: transparent; border: none; backdrop-filter: none; }

        #detRating { top: 12px; right: 12px; }
        .floating-action-btn { top: 12px; right: 12px; left: auto; color: white; width: 34px; height: 34px; padding: 0; align-items: center; justify-content: center; cursor: pointer; background: rgba(15, 23, 42, 0.7); border-radius: 10px; }
        #floatEditBtn:hover, #floatEditBtn.is-editing { background: var(--primary); } 
        .floating-action-btn.btn-delete-float { right: 54px; left: auto; }
        .floating-action-btn.btn-delete-float:hover { background: var(--danger); }
        .btn-save-action { background: var(--border); color: var(--text); }
        .btn-save-action:hover { background: var(--accent) !important; color: white !important; }

        .image-scrim { 
            position: absolute; bottom: 0; left: 0; right: 0; min-height: 40%; 
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%); 
            display: flex; align-items: flex-end; padding: 10px 15px; pointer-events: none; z-index: 20;
        }

        #editTitle { 
            font-size: 1.4rem; font-weight: 900; color: white; background: transparent; 
            border: none; width: 100%; padding: 0; margin: 0; line-height: 1.1;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5); resize: none; overflow: hidden; pointer-events: none;
        }
        #editTitle.active { color: var(--text); background: var(--bg); border: 1px solid var(--border); padding: 5px; border-radius: 6px; text-shadow: none; pointer-events: auto; }

        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 5px 0 10px 0; }
        .stat-card { background: rgba(0,0,0,0.04); padding: 12px; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 4px; }
        .stat-card-dual { grid-column: span 2; background: rgba(0,0,0,0.04); padding: 12px; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px; }
        .dual-row { display: flex; justify-content: space-between; align-items: center; }
        .dual-divider { height: 1px; background: var(--border); width: 100%; opacity: 0.5; }
        .stat-label { font-size: 9px; font-weight: 800; text-transform: uppercase; opacity: 0.5; letter-spacing: 0.5px; }
        .stat-value { font-size: 13px; font-weight: 700; color: var(--text); }
        .stat-sub-label { font-size: 10px; font-weight: 600; opacity: 0.7; }
        .stat-sub-value { font-size: 12px; font-weight: 800; color: var(--text); }

        /* REWORKED FILTER STYLES */
        .filter-container { margin-bottom: 15px; display: flex; flex-direction: column; gap: 6px; }
        
        .filter-section { 
            display: flex; flex-direction: column; 
            background: var(--card); border: 1px solid var(--border); 
            border-radius: 16px; overflow: hidden;
        }

        .toggle-btn-main { 
            width: 100%; height: 40px; border: none; background: transparent;
            color: var(--text); font-weight: 800; font-size: 12px; 
            cursor: pointer; display: flex; align-items: center; justify-content: space-between; 
            padding: 0 18px; transition: 0.2s; text-transform: uppercase;
        }
        .toggle-btn-main:hover { background: rgba(0,0,0,0.02); }
        .toggle-btn-main.active { background: var(--card); color: var(--text); box-shadow: none; border-bottom: 1px solid var(--border); border-radius: 0; }

        .filter-grid-reveal { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; 
            padding: 12px; background: rgba(0,0,0,0.02);
            animation: slideDown 0.2s ease-out;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .sub-toggle-btn {
            width: 100%; height: 65px; border-radius: 12px; border: 1px solid var(--border);
            background: var(--card); color: var(--text); font-size: 9px; font-weight: 800;
            cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px;
            transition: 0.2s; text-transform: uppercase; box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .dark-theme .sub-toggle-btn { background: #1e293b; }
        .sub-toggle-btn:hover { transform: translateY(-2px); border-color: var(--primary); }
        .sub-toggle-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); }
        .sub-toggle-btn .filter-icon { font-size: 24px; line-height: 1; margin-bottom: 2px; }

        .gps-indicator-wrapper { position: relative; width: 14px; height: 14px; display: flex; align-items: center; justify-content: center; }
        .gps-indicator { width: 16px !important; height: 16px !important; background: #2563eb; border: 3px solid white; border-radius: 50% !important; z-index: 2; flex-shrink: 0; aspect-ratio: 1/1; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
        .gps-pulse { position: absolute; width: 45px !important; height: 45px !important; background: rgba(37, 99, 235, 0.6); border: 2px solid rgba(37, 99, 235, 0.8); border-radius: 50% !important; animation: pulse 1.8s ease-out infinite; z-index: 1; flex-shrink: 0; aspect-ratio: 1/1; }
        @keyframes pulse { 0% { transform: scale(0.4); opacity: 1; } 100% { transform: scale(3.5); opacity: 0; } }

        .loc-icon-inner { width: 16px; height: 16px; background: #2563eb; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); }

        .highlight-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 12px; margin-bottom: 8px; cursor: pointer; border: 1px solid var(--border); transition: 0.2s; position: relative; }
        .highlight-item:hover { background: var(--border); transform: translateY(-2px); }
        .highlight-thumb { width: 70px; height: 70px; border-radius: 8px; object-fit: cover; background: #ddd; flex-shrink: 0; }
        .type-label { font-size: 9px; font-weight: 800; text-transform: uppercase; padding: 2px 5px; color: white; border-radius: 3px; display: inline-block; margin-bottom: 3px; }

        .list-divider { height: 1px; background: var(--border); margin: 15px 0; width: 100%; opacity: 0.5; }
        .filter-btn { height: 40px !important; }

        #detail-view { display: none; flex-direction: column; gap: 8px; }
        .edit-input { width: 100%; background: transparent; border: 1px solid transparent; border-radius: 6px; padding: 2px 5px; color: var(--text); font-family: inherit; box-sizing: border-box; }
        #editDesc { font-size: 1.05rem; line-height: 1.5; opacity: 0.9; pointer-events: none; }
        #editDesc.active { pointer-events: auto; }
        .info-card { background: rgba(0,0,0,0.02); padding: 10px; border-radius: 10px; border: 1px solid var(--border); }

        #explore-panel, #add-panel, #settings-panel, #detail-view { padding-bottom: 20px; }

        .zoom-controls { position: absolute; top: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 8px; transition: top 0.3s ease; }
        .btn { width: 100%; height: 42px; margin-bottom: 10px; font-size: 12px; }

        #elevation-dock { 
            position: absolute; bottom: -450px; left: calc(var(--sidebar) + 20px); 
            right: 20px; height: 260px; background: var(--card); backdrop-filter: blur(10px);
            border-radius: 12px; border: 1px solid var(--border); z-index: 5000; 
            padding: 15px; transition: bottom var(--transition), left var(--transition); 
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column;
        }
        #elevation-dock.active { bottom: 20px; }
        body.mobile-mode #elevation-dock.active { bottom: 120px; left: 10px; right: 10px; height: 220px; }

        #elevContainer { flex: 1; min-height: 0; width: 100%; position: relative; }
        .walk-marker-icon { font-size: 16px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 50 !important; }
        .start-icon { background: #10b981; color: white; }
        .end-icon { background: #ef4444; color: white; }

        #modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); display: none; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(4px); }

        .modal { background: var(--card); padding: 15px; border-radius: 20px; width: 340px; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2); border: 1px solid var(--border); max-height: 90vh; overflow-y: auto; }
        .modal h3 { margin: 0 0 10px 0; font-size: 1.25rem; font-weight: 900; letter-spacing: -0.5px; text-align: center; }
        .modal-inputs { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        .modal-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 12px; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; box-sizing: border-box; font-size: 14px; font-weight: 500; transition: border-color 0.2s; }
        .modal-input:focus { border-color: var(--primary); outline: none; }
        .modal-btns { display: flex; flex-direction: column; gap: 10px; }

        #layer-popup {
            position: absolute; right: 75px; top: 160px; background: var(--card); backdrop-filter: blur(20px);
            border: 1px solid var(--border); padding: 10px; border-radius: 15px; display: none;
            flex-direction: column; gap: 6px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); 
            z-index: 7000 !important;
            transition: top 0.3s;
        }

        .node-handle, .mid-handle { cursor: pointer; z-index: 99999 !important; }
        .node-handle-visible { background: white !important; border: 3px solid var(--primary) !important; border-radius: 50%; box-shadow: 0 0 10px rgba(0,0,0,0.4); opacity: 1 !important; }
        .mid-handle-visible { background: white !important; border: 3px solid var(--accent) !important; border-radius: 50%; box-shadow: 0 0 8px rgba(0,0,0,0.3); opacity: 0.9 !important; }
        .node-handle-hidden { opacity: 0 !important; pointer-events: none; }

        .mode-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 10px; }
        .mode-btn {
            background: rgba(0,0,0,0.03); border: 1px solid var(--border);
            padding: 10px 0; border-radius: 10px; cursor: pointer;
            transition: 0.2s; display: flex; flex-direction: column; align-items: center;
            color: var(--text); height: 52px; justify-content: center;
        }
        .mode-btn span { font-size: 18px; margin-bottom: 1px; line-height: 1; }
        .mode-btn b { font-size: 9px; font-weight: 800; text-transform: uppercase; color: inherit; line-height: 1; }
        
        /* Fixed specific colors for activity mode buttons */
        .mode-btn[data-mode="walk"].active { background: #10b981; color: white !important; }
        .mode-btn[data-mode="hike"].active { background: #d97706; color: white !important; }
        .mode-btn[data-mode="run"].active { background: #ef4444; color: white !important; }
        .mode-btn[data-mode="cycle"].active { background: #3b82f6; color: white !important; }
        .mode-btn.active b { color: white !important; }

        .elev-toggle-btn { 
            grid-column: span 2; width: 100%; height: 44px; margin-top: 5px; 
            text-transform: uppercase; font-size: 12px; gap: 8px;
        }

        /* RECORDING UI POPOUT */
        #recording-popout { 
            display: none; position: fixed; 
            top: 20px; left: calc(var(--sidebar) + 20px); right: 20px;
            background: var(--primary); color: white; padding: 15px; 
            border-radius: 20px; z-index: 9000; flex-direction: column; gap: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: transform 0.3s, top 0.3s;
        }
        body.mobile-mode #recording-popout { left: 10px; right: 10px; top: 10px; }
        
        .hud-stats { display: flex; justify-content: space-between; font-size: 13px; font-weight: 900; text-transform: uppercase; }
        .hud-btns { display: flex; gap: 8px; }
        .hud-btn { 
            flex: 1; background: rgba(255,255,255,0.2); border: none; 
            color: white; padding: 10px; border-radius: 10px; 
            font-weight: 800; cursor: pointer; font-size: 11px;
        }
        .hud-btn.stop { background: var(--danger); }
        .hud-btn.elev-toggle { background: rgba(0,0,0,0.2); }
        
        .elev-minmax { display: flex; justify-content: space-between; font-size: 10px; opacity: 0.9; font-weight: 800; }
        .pulse-red { width: 8px; height: 8px; background: #ff4444; border-radius: 50%; display: inline-block; margin-right: 5px; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }

        .is-flying #map { transition: none !important; }
        .is-flying .zoom-controls { display: none !important; }
        
        #flyoverControls {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            display: none; flex-direction: column; gap: 8px;
            z-index: 9999; width: 300px;
            background: var(--card); backdrop-filter: blur(10px);
            padding: 15px; border-radius: 20px; border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .fly-control-row { display: flex; gap: 10px; align-items: center; }
        .fly-slider-group { flex: 1; display: flex; flex-direction: column; gap: 4px; align-items: center; }
        .fly-slider-group span { font-size: 9px; font-weight: 800; opacity: 0.7; letter-spacing: 0.5px; text-align: center; }
        
        .fly-adjust-group { display: flex; align-items: center; gap: 4px; background: rgba(0,0,0,0.05); padding: 3px; border-radius: 10px; border: 1px solid var(--border); width: 100%; box-sizing: border-box; }
        .fly-adjust-btn { width: 28px; height: 28px; border-radius: 7px; border: none; background: var(--card); color: var(--text); font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: 0.1s; flex-shrink: 0; }
        .fly-adjust-btn:active { transform: scale(0.95); background: var(--border); }
        .fly-val-display { font-size: 11px; font-weight: 800; flex: 1; text-align: center; font-variant-numeric: tabular-nums; }
        
        .fly-btn {
            flex: 1; height: 36px; border-radius: 10px; border: none;
            font-weight: 800; font-size: 11px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: 0.2s; background: var(--border); color: var(--text); text-transform: uppercase;
        }
        .fly-btn:hover { background: var(--primary); color: white; }
        .fly-btn.danger { background: var(--danger); color: white; }
        .fly-btn.danger:hover { background: #dc2626; }
        
        /* Fix map flickering during transform */
        .leaflet-pane, .leaflet-tile, .leaflet-marker-icon, .leaflet-marker-shadow, .leaflet-tile-container, .leaflet-pane > svg, .leaflet-pane > canvas, .leaflet-zoom-box, .leaflet-image-layer, .leaflet-layer {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            transform: translate3d(0,0,0);
            will-change: transform;
        }
        .leaflet-tile {
            outline: 1px solid transparent;
        }

        #auth-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.3); backdrop-filter: blur(2px); z-index: 10000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        
        body.auth-active #sidebar, 
        body.auth-active #expandBtn, 
        body.auth-active .zoom-controls, 
        body.auth-active #recording-popout, 
        body.auth-active #flyoverControls, 
        body.auth-active #elevation-dock,
        body.auth-active #layer-popup { display: none !important; }
        body.auth-active .gps-indicator-wrapper { display: none !important; }

        .custom-pin-marker .pin-shape { transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .custom-pin-marker:hover .pin-shape { transform: rotate(-45deg) scale(1.3); }
        .custom-pin-marker:hover { z-index: 10000 !important; }

        .speed-input-group { display: flex; flex-direction: column; gap: 2px; }

        .comments-section { margin-top: 15px; border-top: 1px solid var(--border); padding-top: 15px; }
        .comment-item { 
            background: var(--card); 
            border-radius: 16px; 
            padding: 16px; 
            margin-bottom: 12px; 
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        .comment-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .comment-avatar {
            width: 36px; height: 36px; border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white; display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 14px; text-transform: uppercase;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .comment-info { display: flex; flex-direction: column; gap: 2px; flex: 1; }
        .comment-user { font-size: 13px; font-weight: 800; color: var(--text); }
        .comment-date { font-size: 11px; opacity: 0.5; font-weight: 500; font-family: 'Inter', sans-serif; }
        .comment-stars { color: #fbbf24; font-size: 14px; letter-spacing: 2px; margin-bottom: 8px; display: inline-block; }
        .comment-text { font-size: 13px; margin: 0 0 10px 0; line-height: 1.5; opacity: 0.85; }
        .comment-photos { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; }
        .comment-photo-thumb {
            width: 70px; height: 70px; object-fit: cover; border-radius: 10px;
            border: 1px solid var(--border); cursor: zoom-in; transition: transform 0.2s;
            flex-shrink: 0;
            box-shadow: 0 3px 8px rgba(0,0,0,0.04);
        }
        .comment-photo-thumb:hover { transform: scale(1.05); }
        .new-comment-box { margin-top: 15px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
        .star-input { display: flex; gap: 5px; font-size: 24px; color: #cbd5e1; cursor: pointer; margin-bottom: 10px; }
        .star-input span.active { color: #fbbf24; }
        .comment-actions { display: flex; gap: 8px; margin-top: 12px; justify-content: flex-start; border-top: 1px solid var(--border); padding-top: 12px; }
        .comment-action-btn { 
            background: var(--bg); border: 1px solid var(--border); font-size: 11px; cursor: pointer; 
            padding: 6px 12px; color: var(--text); font-weight: 700; 
            border-radius: 8px; transition: 0.2s;
        }
        .comment-action-btn:hover { background: var(--border); }
        .comment-item { position: relative; }

        #lightbox-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000;
            display: none; align-items: center; justify-content: center; cursor: pointer;
        }
        #lightbox-img { max-width: 100%; max-height: 100%; object-fit: contain; }

        .color-dot { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .color-dot.active { border-color: var(--text); transform: scale(1.2); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .emoji-option { font-size: 16px; cursor: pointer; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: 0.2s; background: rgba(0,0,0,0.05); border: 1px solid transparent; }
        .emoji-option:hover { background: rgba(0,0,0,0.1); transform: scale(1.1); }

        .facility-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; margin-bottom: 10px; }
        .facility-btn {
            background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
            padding: 8px; font-size: 11px; cursor: pointer; display: flex; flex-direction: row;
            align-items: center; justify-content: flex-start; gap: 8px; text-align: left;
            transition: 0.2s; color: var(--text); opacity: 0.8;
        }
        .facility-btn.active { background: var(--primary); color: white; border-color: var(--primary); opacity: 1; }
        .facility-check { width: 14px; height: 14px; border: 1px solid currentColor; border-radius: 3px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .facility-btn.active .facility-check::after { content: "‚úì"; font-size: 10px; font-weight: 900; }
        .facility-tag { display: inline-flex; align-items: center; gap: 4px; background: rgba(0,0,0,0.05); border: 1px solid var(--border); border-radius: 6px; padding: 4px 8px; font-size: 11px; margin: 0 4px 4px 0; }

        .segmented-control {
            display: flex; background: rgba(0,0,0,0.05); padding: 4px;
            border-radius: 10px; border: 1px solid var(--border); margin: 10px 0;
        }
        .seg-btn {
            flex: 1; background: transparent; border: none; padding: 8px;
            border-radius: 8px; font-size: 11px; font-weight: 800;
            color: var(--text); cursor: pointer; transition: 0.2s; opacity: 0.6;
        }
        .seg-btn:hover { opacity: 1; }
        .seg-btn.active {
            background: var(--card); box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            color: var(--primary); opacity: 1;
        }

        .visited-check-corner {
            position: absolute; bottom: 8px; right: 8px;
            background: var(--accent); color: white; padding: 3px 6px;
            border-radius: 6px; font-size: 9px; font-weight: 900;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            text-transform: uppercase; letter-spacing: 0.5px;
            z-index: 5;
        }

        .desc-truncated {
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* ADVERTISEMENT CONTAINERS */
        #pc-ad-side {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            width: 160px; height: 600px; z-index: 2000;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            background: rgba(255,255,255,0.05); border: 1px solid var(--border);
            border-radius: 12px; backdrop-filter: blur(5px); pointer-events: none;
        }
        #pc-ad-side > * { pointer-events: auto; }
        body.mobile-mode #pc-ad-side { display: none; }

        #mobile-ad-banner {
            width: 100%; height: 60px; margin-bottom: 15px; flex-shrink: 0;
            background: rgba(255,255,255,0.05); border: 1px solid var(--border);
            border-radius: 12px; display: none; align-items: center; justify-content: center; overflow: hidden;
        }
        body.mobile-mode #mobile-ad-banner { display: flex; }
    </style>
</head>
<body class="dark-theme auth-active">

    <div id="app">
        <button id="expandBtn" class="icon-btn" onclick="toggleSidebar()">‚ò∞</button>
        
        <div id="auth-overlay">
            <div class="modal" style="width: 300px; padding: 30px;">
                <img src="Images/Tracelog.png" style="height: 70px; display: block; margin: 0 auto 10px auto;" alt="TraceLog">
                <p style="text-align:center; font-size:15px; margin-bottom:20px;">Map your journey</p>
                <p style="text-align:center; font-size:12px; opacity:0.7; margin-bottom:20px;">Sign in to view and create your log</p>
                <input type="email" id="authEmail" class="modal-input" placeholder="Email Address" style="margin-bottom:10px;">
                <input type="password" id="authPass" class="modal-input" placeholder="Password" style="margin-bottom:10px;">
                <button class="btn btn-save-action" id="btnLogin" style="margin-bottom:10px;">Log In</button>
                
                <button class="btn" id="btnGoogle" style="margin-bottom:15px; background:white; color:#444; border:1px solid #ccc; display:flex; align-items:center; justify-content:center; gap:10px;">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="width:18px;height:18px;">
                    Sign in with Google
                </button>
                <div style="display:flex; gap:10px; width:100%;">
                    <button class="btn" id="btnSignup" style="flex:1; height:34px; font-size:11px; background:transparent; border:1px solid var(--border);">Sign Up</button>
                    <button class="btn" id="btnForgot" style="flex:1; height:34px; font-size:11px; background:transparent; border:1px solid var(--border);">Forgot Password?</button>
                </div>
                <p id="authMessage" style="color:var(--danger); text-align:center; font-size:12px; margin:0;"></p>
            </div>
        </div>

        <div id="dn-overlay" style="position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); display: none; align-items: center; justify-content: center; z-index: 10001; backdrop-filter: blur(5px);">
            <div class="modal">
                <h3>Welcome!</h3>
                <p style="text-align:center; opacity:0.7; font-size:13px; margin-bottom:15px;">Choose a unique display name for your Log.</p>
                <input type="text" id="newDisplayName" class="modal-input" placeholder="Display Name" style="margin-bottom:10px;">
                <p id="dnError" style="color:var(--danger); font-size:12px; text-align:center; margin:0 0 10px 0; min-height:15px;"></p>
                <button class="btn btn-save-action" id="saveDNBtn">Get Started</button>
            </div>
        </div>

        <div id="lightbox-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:10000; align-items:center; justify-content:center;">
            <button class="icon-btn" onclick="closeLightbox()" style="position:absolute; top:20px; right:20px; z-index:10002; background:rgba(255,255,255,0.2); color:white; border:none;">‚úï</button>
            <button class="icon-btn" onclick="changeLightboxImage(-1)" style="position:absolute; left:20px; top:50%; transform:translateY(-50%); z-index:10002; background:rgba(255,255,255,0.2); color:white; border:none;">‚ùÆ</button>
            <button class="icon-btn" onclick="changeLightboxImage(1)" style="position:absolute; right:20px; top:50%; transform:translateY(-50%); z-index:10002; background:rgba(255,255,255,0.2); color:white; border:none;">‚ùØ</button>
            <img id="lightbox-img" src="" style="width:100%; height:100%; object-fit:contain;">
        </div>

        <div id="flyoverControls">
            <div class="fly-stats-row" style="display:flex; justify-content:space-between; width:100%; margin-bottom:10px; font-size:11px; font-weight:800; color:var(--text); background:rgba(0,0,0,0.05); padding:8px; border-radius:10px; box-sizing: border-box;">
                <span id="flyStatDist">0.00 km</span>
                <span id="flyStatElev">-- m</span>
                <span id="flyStatTime">00:00</span>
            </div>
            <div class="fly-control-row" style="justify-content: center; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
                <button class="fly-adjust-btn" onclick="rewindFlyover()" style="width:40px; height:36px; font-size:16px;" title="Rewind 10s">‚è™</button>
                <button class="fly-btn" id="flyPauseBtn" onclick="toggleFlyPause()" style="flex:1; max-width:100px;">‚è∏ PAUSE</button>
                <select id="flyMapSelect" onchange="setMapLayer(this.value)" style="height:36px; border-radius:10px; border:1px solid var(--border); background:var(--bg); color:var(--text); font-size:11px; font-weight:800; padding:0 5px; width: 90px;">
                    <option value="voyager">Voyager</option>
                    <option value="dark">Dark</option>
                    <option value="sat">Satellite</option>
                    <option value="topo">Topo</option>
                    <option value="transit">Transit</option>
                    <option value="hybrid">Hybrid</option>
                </select>
            </div>
            <div class="fly-control-row">
                <div class="fly-slider-group">
                    <span>SPEED</span>
                    <div class="fly-adjust-group">
                        <button class="fly-adjust-btn" onclick="adjustFlySpeed(-0.5)">‚àí</button>
                        <span id="flySpeedDisplay" class="fly-val-display">1.0x</span>
                        <button class="fly-adjust-btn" onclick="adjustFlySpeed(0.5)">+</button>
                    </div>
                </div>
                <div class="fly-slider-group">
                    <span>ZOOM</span>
                    <div class="fly-adjust-group">
                        <button class="fly-adjust-btn" onclick="adjustFlyZoom(-0.5)">‚àí</button>
                        <span id="flyZoomDisplay" class="fly-val-display">17.0</span>
                        <button class="fly-adjust-btn" onclick="adjustFlyZoom(0.5)">+</button>
                    </div>
                </div>
            </div>
            <div class="fly-control-row">
                <button class="fly-btn" onclick="toggleGraph()">üìà GRAPH</button>
                <button class="fly-btn danger" onclick="stopFlyover()">‚èπ EXIT</button>
            </div>
        </div>

        <div id="recording-popout">
            <div class="hud-stats">
                <span><div class="pulse-red"></div><span id="hudTimer">00:00</span></span>
                <span id="hudDist">0.00 km</span>
            </div>
            <div class="elev-minmax">
                <span id="hudMinHeight">MIN: --m</span>
                <span id="hudMaxHeight">MAX: --m</span>
            </div>
            <div class="hud-btns">
                <button class="hud-btn elev-toggle" onclick="toggleGraph()">‚õ∞Ô∏è GRAPH</button>
                <button class="hud-btn" id="hudPausePlay">‚è∏ PAUSE</button>
                <button class="hud-btn stop" id="hudStop">‚èπ END</button>
            </div>
        </div>

        <aside id="sidebar">
            <div class="drag-handle" id="mobileDragHandle"></div>
            <div class="sidebar-header" id="mobileHeader">
                <div class="logo-row">
                    <img src="Images/Tracelog.png" style="height: 50px; margin: 0;" alt="TraceLog">
                    <div style="display: flex; gap: 8px;">
                        <button id="backBtn" class="icon-btn" onclick="goBack()">‚ùÆ</button>
                        <button id="minimizeBtn" class="icon-btn" onclick="toggleSidebar()">‚úï</button>
                    </div>
                </div>
                <input type="text" id="mainSearch" placeholder="üîç Search City, Pins, Activities...">
                
                <div class="tab-nav" id="mainTabs">
                    <button class="tab-btn active" id="exploreTab" onclick="switchTab('explore')">EXPLORE</button>
                    <button class="tab-btn" id="addTab" onclick="switchTab('add')">YOU</button>
                    <button class="tab-btn" id="settingsTab" onclick="switchTab('settings')">SETTINGS</button>
                </div>
            </div>

            <div class="sidebar-scroll-area" id="mainScrollArea">
                <!-- Mobile Ad Banner (AdMob/AdSense) -->
                <div id="mobile-ad-banner">
                    <!-- Mobile Horizontal Ad Unit (320x50) -->
                    <ins class="adsbygoogle"
                         style="display:inline-block;width:320px;height:50px"
                         data-ad-client="ca-pub-1243519901054274"
                         data-ad-slot="6750221382"></ins>
                    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
                </div>

                <div id="explore-panel">
                    <div class="filter-container">
                        <span class="settings-label" style="margin-left:2px; font-size:10px; opacity:0.6; text-transform:uppercase; letter-spacing:0.5px;">Sort By:</span>
                        <div class="filter-row" style="display:flex; gap:6px;">
                            <button class="filter-btn active" onclick="setSort('rating', this)" style="flex:1">‚≠ê RATING</button>
                            <button class="filter-btn" onclick="setSort('dist', this)" style="flex:1">üìç DISTANCE</button>
                        </div>
                        
                        <div class="segmented-control">
                            <button class="seg-btn active" onclick="setFilterMode('all', this)">Both</button>
                            <button class="seg-btn" onclick="setFilterMode('pins', this)">Pins</button>
                            <button class="seg-btn" onclick="setFilterMode('walks', this)">Activities</button>
                        </div>

                        <div class="filter-section" id="filterSectionPins">
                            <button class="toggle-btn-main" onclick="toggleFilterSection('pinGridReveal', this)" style="width:100%; justify-content: space-between; padding: 0 15px;"><span>üìç Pins</span> <span class="chevron" style="opacity:0.5; font-size:10px; transition:0.3s;">‚ñº</span></button>
                            <div class="filter-grid-reveal" id="pinGridReveal" style="display:none;"></div>
                        </div>

                        <div class="filter-section" id="filterSectionActivities">
                            <button class="toggle-btn-main" onclick="toggleFilterSection('activityGridReveal', this)" style="width:100%; justify-content: space-between; padding: 0 15px;"><span>üèÉ Activities</span> <span class="chevron" style="opacity:0.5; font-size:10px; transition:0.3s;">‚ñº</span></button>
                            <div class="filter-grid-reveal" id="activityGridReveal" style="display:none;">
                                <button class="sub-toggle-btn active" data-type="walk" onclick="toggleSubFilter(this, 'activity')"><span class="filter-icon">üö∂</span>Walk</button>
                                <button class="sub-toggle-btn active" data-type="hike" onclick="toggleSubFilter(this, 'activity')"><span class="filter-icon">ü•æ</span>Hike</button>
                                <button class="sub-toggle-btn active" data-type="run" onclick="toggleSubFilter(this, 'activity')"><span class="filter-icon">‚ö°</span>Run</button>
                                <button class="sub-toggle-btn active" data-type="cycle" onclick="toggleSubFilter(this, 'activity')"><span class="filter-icon">üö≤</span>Cycle</button>
                            </div>
                        </div>
                    </div>
                    <div class="list-divider"></div>
                    
                    <div id="highlights-list"></div>
                    <div class="scroll-spacer"></div>
                </div>

                <div id="add-panel" style="display:none;">
                    <div id="walk-options" style="display:none; margin: 0 0 10px 0; padding: 12px; background: rgba(0,0,0,0.03); border-radius: 12px; border: 1px solid var(--border);">
                        <div class="mode-selector" id="addModeSelector">
                            <button class="mode-btn active" data-mode="walk"><span>üö∂</span><b>Walk</b></button>
                            <button class="mode-btn" data-mode="hike"><span>ü•æ</span><b>Hike</b></button>
                            <button class="mode-btn" data-mode="run"><span>‚ö°</span><b>Run</b></button>
                            <button class="mode-btn" data-mode="cycle"><span>üö≤</span><b>Cycle</b></button>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="settings-label" style="text-transform:none; font-size:12px;">Snap to Footpaths/Roads</span>
                            <label class="switch"><input type="checkbox" id="snapToggle"><span class="slider"></span></label>
                        </div>
                        <div style="display:flex; gap:8px; margin-top:10px;">
                            <button class="btn" id="undoAddBtn" style="flex:1; height:32px; background:rgba(0,0,0,0.05); color:var(--text); font-size:11px; margin:0;">‚Ü© Undo</button>
                            <button class="btn" id="cancelAddBtn" style="flex:1; height:32px; background:var(--danger); color:white; font-size:11px; margin:0;">‚úñ Cancel Plot</button>
                        </div>
                    </div>

                    <div id="route-stats" style="display:none; background:rgba(0,0,0,0.05); padding:15px; border-radius:12px; margin-bottom: 15px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <p id="liveDist" style="margin:0; font-weight:800; font-size: 1.2rem; color: var(--primary);">0.00 km</p>
                            <p id="liveTime" style="margin:0; font-weight:600; font-size: 0.9rem; opacity:0.7;">00m</p>
                        </div>
                        <button class="btn" id="drawGraphBtn" onclick="toggleGraph()" style="margin-top:8px; background:rgba(0,0,0,0.05); border:1px solid var(--border); font-size:11px;">üìà Show Height Graph</button>
                        <button class="btn btn-save-action" id="finishWalkBtn" style="margin-top:8px; width: 100%;">üíæ Save Activity</button>
                    </div>

                    <button class="settings-header" onclick="toggleSettingsSection('addSectionContent', this)" style="margin-top:0;">
                        <span>NEW UPLOAD</span> <span class="chevron">‚ñº</span>
                    </button>
                    <div id="addSectionContent" class="settings-content">
                        <button id="pinModeBtn" class="btn btn-main">üìç Log a Pin</button>
                        <button id="walkModeBtn" class="btn btn-main">üèÉ Trace Activity</button>
                        <button id="recordModeBtn" class="btn btn-main" style="background: var(--primary); color: white;">üõ∞Ô∏è Record an Activity</button>
                    </div>
                    
                    <div class="list-divider"></div>
                    
                    <button class="settings-header" onclick="toggleSettingsSection('myLogSectionContent', this)">
                        <span>MY UPLOADS</span> <span class="chevron">‚ñº</span>
                    </button>
                    <div id="myLogSectionContent" class="settings-content">
                        <div class="filter-container">
                            <div style="display:flex; gap:6px; margin-bottom:6px;">
                                <select onchange="setMyLogPrivacy(this.value)" style="flex:1; padding:0 10px; height:34px; border-radius:10px; border:1px solid var(--border); background:var(--bg); color:var(--text); font-size:11px; font-weight:800; font-family:inherit;">
                                    <option value="all">üëÅÔ∏è ALL VISIBILITY</option>
                                    <option value="public">üåç PUBLIC</option>
                                    <option value="private">üîí PRIVATE</option>
                                </select>
                            </div>

                            <div class="filter-row" style="display:flex; gap:6px;">
                                <button class="filter-btn" onclick="setMyLogSort('rating', this)" style="flex:1">‚≠ê RATING</button>
                                <button class="filter-btn" onclick="setMyLogSort('dist', this)" style="flex:1">üìç DISTANCE</button>
                                <button class="filter-btn active" onclick="setMyLogSort('date', this)" style="flex:1">üìÖ DATE</button>
                            </div>

                            <div class="segmented-control">
                                <button class="seg-btn active" onclick="setMyLogFilterMode('all', this)">Both</button>
                                <button class="seg-btn" onclick="setMyLogFilterMode('pins', this)">Pins</button>
                                <button class="seg-btn" onclick="setMyLogFilterMode('walks', this)">Activities</button>
                            </div>

                            <div class="filter-section" id="myLogFilterSectionPins">
                                <button class="toggle-btn-main" onclick="toggleFilterSection('myLogPinGridReveal', this)" style="width:100%; justify-content: space-between; padding: 0 15px;"><span>üìç Pins</span> <span class="chevron" style="opacity:0.5; font-size:10px; transition:0.3s;">‚ñº</span></button>
                                <div class="filter-grid-reveal" id="myLogPinGridReveal" style="display:none;"></div>
                            </div>

                            <div class="filter-section" id="myLogFilterSectionActivities">
                                <button class="toggle-btn-main" onclick="toggleFilterSection('myLogActivityGridReveal', this)" style="width:100%; justify-content: space-between; padding: 0 15px;"><span>üèÉ Activities</span> <span class="chevron" style="opacity:0.5; font-size:10px; transition:0.3s;">‚ñº</span></button>
                                <div class="filter-grid-reveal" id="myLogActivityGridReveal" style="display:none;">
                                    <button class="sub-toggle-btn active" data-type="walk" onclick="toggleMyLogSubFilter(this, 'activity')"><span class="filter-icon">üö∂</span>Walk</button>
                                    <button class="sub-toggle-btn active" data-type="hike" onclick="toggleMyLogSubFilter(this, 'activity')"><span class="filter-icon">ü•æ</span>Hike</button>
                                    <button class="sub-toggle-btn active" data-type="run" onclick="toggleMyLogSubFilter(this, 'activity')"><span class="filter-icon">‚ö°</span>Run</button>
                                    <button class="sub-toggle-btn active" data-type="cycle" onclick="toggleMyLogSubFilter(this, 'activity')"><span class="filter-icon">üö≤</span>Cycle</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="my-saved-list"></div>
                    </div>
                    
                    <div class="list-divider"></div>
                    <button class="settings-header" onclick="toggleSettingsSection('loggedSectionContent', this)">
                        <span>MY LOGBOOK</span> <span class="chevron">‚ñº</span>
                    </button>
                    <div id="loggedSectionContent" class="settings-content">
                        <div id="my-logged-list"></div>
                    </div>
                    <div class="scroll-spacer"></div>
                </div>

                <div id="settings-panel" style="display:none;">
                    <div class="settings-container">
                        <button class="settings-header" onclick="toggleSettingsSection('genSettings', this)">
                            <span>General</span> <span class="chevron">‚ñº</span>
                        </button>
                        <div id="genSettings" class="settings-content">
                            <div class="settings-row-refined" id="profileRow" style="display:none; flex-direction:column; align-items:flex-start; gap:4px;">
                                <span class="settings-label">Logged in as</span>
                                <span id="userEmailDisplay" style="font-size:12px; opacity:0.7; word-break:break-all;"></span>
                                <div style="width:100%; margin-top:8px; padding-top:8px; border-top:1px solid var(--border);">
                                    <span class="settings-label" style="font-size:11px;">Display Name</span>
                                    <div style="display:flex; gap:5px; margin-top:4px;">
                                        <input type="text" id="settingsDisplayName" class="modal-input" style="padding:6px; font-size:12px;" placeholder="Loading..."><button class="btn" id="updateDNBtn" style="width:auto; padding:0 10px; height:30px;">Save</button>
                                    </div>
                                </div>
                                <div style="width:100%; margin-top:8px; padding-top:8px; border-top:1px solid var(--border); display:flex; flex-direction:column; gap:8px;">
                                    <span class="settings-label" style="font-size:11px;">Avatar Style</span>
                                    <div style="display:flex; align-items:center; gap:12px;">
                                        <div id="settingsAvatarPreview" class="comment-avatar" style="width:48px; height:48px; font-size:18px; flex-shrink:0;"></div>
                                        <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
                                            <input type="text" id="avatarTextInput" class="modal-input" maxlength="2" placeholder="Initials or Emoji" style="padding:6px; font-size:12px; width:100%;">
                                            <div style="display:flex; gap:4px; flex-wrap:wrap;" id="profileEmojiPicker"></div>
                                            <div style="display:flex; gap:6px; flex-wrap:wrap;" id="profileColorPicker"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="settings-row-refined">
                                <span class="settings-label">Map Style</span>
                                <select id="settingsMapSelect" onchange="setMapLayer(this.value)" style="padding:4px; border-radius:6px; border:1px solid var(--border); background:var(--bg); color:var(--text); font-size:11px; max-width: 120px;">
                                    <option value="voyager">Voyager</option>
                                    <option value="dark">Dark</option>
                                    <option value="sat">Satellite</option>
                                    <option value="topo">Topography</option>
                                    <option value="transit">Transport</option>
                                    <option value="hybrid">Hybrid</option>
                                </select>
                            </div>
                            <div class="settings-row-refined">
                                <span class="settings-label">App Dark Mode</span>
                                <label class="switch"><input type="checkbox" id="themeToggle"><span class="slider"></span></label>
                            </div>
                            <div class="settings-row-refined">
                                <span class="settings-label">Interface Mode</span>
                                <button class="btn" id="deviceToggleSettings" onclick="toggleDeviceMode()" style="width:auto; height:28px; font-size:11px; padding:0 10px; background:var(--bg); border:1px solid var(--border);">Switch Mode</button>
                            </div>
                        </div>

                        <button class="settings-header" onclick="toggleSettingsSection('prefSettings', this)">
                            <span>Preferences</span> <span class="chevron" style="transform:rotate(-90deg)">‚ñº</span>
                        </button>
                        <div id="prefSettings" class="settings-content" style="display:none;">
                            <div class="settings-row-refined">
                                <span class="settings-label">Units</span>
                                <select id="unitSelect" onchange="changeUnits(this.value)" style="padding:4px; border-radius:6px; border:1px solid var(--border); background:var(--bg); color:var(--text); font-size:11px; max-width: 120px;">
                                    <option value="metric">Metric (km, m)</option>
                                    <option value="imperial">Imperial (mi, ft)</option>
                                </select>
                            </div>
                            <div class="settings-row-refined" style="flex-direction:column; align-items:flex-start; gap:10px;">
                                <span class="settings-label">Default Speeds (<span id="speedUnitLabel">km/h</span>)</span>
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; width:100%;">
                                    <div class="speed-input-group"><span style="font-size:10px;">Walk</span><input type="number" id="speedWalk" class="modal-input" style="padding:6px; font-size:12px;" onchange="saveSpeeds()"></div>
                                    <div class="speed-input-group"><span style="font-size:10px;">Hike</span><input type="number" id="speedHike" class="modal-input" style="padding:6px; font-size:12px;" onchange="saveSpeeds()"></div>
                                    <div class="speed-input-group"><span style="font-size:10px;">Run</span><input type="number" id="speedRun" class="modal-input" style="padding:6px; font-size:12px;" onchange="saveSpeeds()"></div>
                                    <div class="speed-input-group"><span style="font-size:10px;">Cycle</span><input type="number" id="speedCycle" class="modal-input" style="padding:6px; font-size:12px;" onchange="saveSpeeds()"></div>
                                </div>
                            </div>
                        </div>

                        <button class="settings-header" onclick="toggleSettingsSection('accSettings', this)">
                            <span>Account</span> <span class="chevron" style="transform:rotate(-90deg)">‚ñº</span>
                        </button>
                        <div id="accSettings" class="settings-content" style="display:none;">
                            <button class="btn" onclick="makeAllPrivate()" style="margin-top:5px; background:transparent; border:1px solid var(--border); color:var(--text); opacity:0.8; font-size:11px;">üîí Make All Items Private</button>
                            <button class="btn" onclick="deleteAccount()" style="margin-top:5px; background:transparent; border:1px solid var(--danger); color:var(--danger); font-size:11px;">‚ö†Ô∏è Delete Account</button>
                        </div>

                        <div style="margin-top: 10px; border-top: 1px solid var(--border); padding-top: 15px;">
                            <p id="versionLabel" style="font-size: 11px; opacity: 0.5; text-align: center; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">TraceLog V18.3 Stable</p>
                        </div>
                        <button class="btn" onclick="signOut()" style="margin-top:10px; background:var(--danger); color:white;">Sign Out</button>
                    </div>
                    <div class="scroll-spacer"></div>
                </div>

                <div id="detail-view">
                    <div class="detail-header-container">
                        <div id="detMiniMap"></div>
                        <img id="detPhotoBack" src="">
                        <img id="detPhoto" src="">
                        <div id="detTypeOverlay"></div>
                        <button class="floating-action-btn" id="floatEditBtn" title="Edit">üñãÔ∏è</button>
                        <button class="floating-action-btn btn-delete-float" id="floatDeleteBtn" onclick="deleteAction()" style="display:none;" title="Delete">üóëÔ∏è</button>
                        <div id="detRating" style="display:none;"></div>
                        <div class="image-scrim">
                            <textarea id="editTitle" class="edit-input" rows="1"></textarea>
                        </div>
                    </div>
                    <div id="detCreator" style="margin-bottom: 8px; padding: 0 5px;"></div>
                    <button class="btn" id="editAddPhotoBtn" onclick="openUrlUploadPopup('edit')" style="display:none; margin-bottom:10px; background:var(--bg); border:1px solid var(--border); color:var(--text); font-weight:600;">üì∑ Add Photo URL</button>
                    <div id="detTypeLabel" style="padding: 0 5px; margin-bottom: 4px;"></div>
                    <button class="btn" id="markVisitedBtn" onclick="toggleVisited()" style="margin: 0 5px 10px 5px; width: calc(100% - 10px); font-weight:700; border:1px solid var(--border);">‚≠ï Mark Visited</button>

                    <div id="editWalkOptions" style="display:none; margin: 10px 0; padding: 12px; background: rgba(37, 99, 235, 0.05); border-radius: 12px; border: 1px solid var(--primary);">
                        <div class="mode-selector" id="editModeSelector">
                            <button class="mode-btn" data-mode="walk"><span>üö∂</span><b>Walk</b></button>
                            <button class="mode-btn" data-mode="hike"><span>ü•æ</span><b>Hike</b></button>
                            <button class="mode-btn" data-mode="run"><span>‚ö°</span><b>Run</b></button>
                            <button class="mode-btn" data-mode="cycle"><span>üö≤</span><b>Cycle</b></button>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="settings-label" style="text-transform:none; font-size:12px; color: var(--primary);">Snap new points to paths</span>
                            <label class="switch"><input type="checkbox" id="editSnapToggle"><span class="slider"></span></label>
                        </div>
                        <button class="btn" id="undoEditBtn" style="margin-top:10px; height:32px; background:var(--bg); border: 1px solid var(--border); font-size:11px;">‚Ü© Undo Last Point</button>
                    </div>

                    <div id="editTypeContainer" style="display:none; margin-bottom: 10px;">
                        <span class="stat-label">Pin Category</span>
                        <div class="pin-type-grid" id="detailTypePicker"></div>
                    </div>
                    <div id="editPrivacyContainer" style="display:none; margin-bottom: 10px; padding: 12px; background: rgba(0,0,0,0.03); border-radius: 12px; border: 1px solid var(--border);">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="settings-label" style="text-transform:none; font-size:12px;">Publicly Visible</span>
                            <label class="switch"><input type="checkbox" id="editPublicToggle"><span class="slider"></span></label>
                        </div>
                    </div>
                    <div id="detFacilities" style="display:flex; flex-wrap:wrap; margin-bottom:10px;"></div>
                    <div id="editFacilitiesContainer" style="display:none; margin-bottom:10px;">
                        <span class="settings-label">Facilities</span>
                        <div class="facility-grid" id="editFacilityPicker"></div>
                    </div>

                    <div id="detStats"></div>
                    <div class="info-card">
                        <div id="viewDescContainer">
                            <p id="viewDescText" style="margin:0; font-size:1.05rem; line-height:1.5; opacity:0.9; white-space: pre-wrap;"></p>
                            <button id="viewDescShowMoreBtn" style="display:none; background:none; border:none; color:var(--primary); font-weight:700; font-size:11px; padding:0; margin-top:5px; cursor:pointer;">Show More</button>
                        </div>
                        <textarea id="editDesc" class="edit-input" rows="4" placeholder="No notes added..." style="display:none;"></textarea>
                    </div>
                    <div id="commentsSection" class="comments-section"></div>
                    <div class="scroll-spacer"></div>
                </div>
            </div>
        </aside>

        <div class="zoom-controls" id="zoomCtrl">
                <button class="zoom-btn" id="locateBtn"><div class="loc-icon-inner"></div></button>
                <button class="zoom-btn" onclick="map.zoomIn()">+</button>
                <button class="zoom-btn" onclick="map.zoomOut()">‚àí</button>
                <button class="zoom-btn" id="layerBtn" onclick="toggleLayerMenu()" title="Map Layers">üó∫Ô∏è</button>
            </div>
            <div id="layer-popup">
                <button class="layer-item-btn" onclick="setMapLayer('voyager')">üèôÔ∏è Voyager</button>
                <button class="layer-item-btn" onclick="setMapLayer('dark')">üåô Dark Matter</button>
                <button class="layer-item-btn" onclick="setMapLayer('sat')">üåç Satellite</button>
                <button class="layer-item-btn" onclick="setMapLayer('topo')">‚õ∞Ô∏è Topography</button>
                <button class="layer-item-btn" onclick="setMapLayer('transit')">üöå Transport</button>
                <button class="layer-item-btn" onclick="setMapLayer('hybrid')">üõ∞Ô∏è Hybrid</button>
            </div>
            <div id="elevation-dock">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 5px;">
                    <strong style="font-weight: 800; font-size: 13px;">Elevation Profile</strong>
                    <button id="closeElevBtn" class="icon-btn" style="width:30px; height:30px; background:none;">‚úï</button>
                </div>
                <div id="elevContainer"><canvas id="elevChart"></canvas></div>
            </div>

        <!-- PC Ad Banner (AdMob/AdSense) -->
        <div id="pc-ad-side">
            <!-- PC Vertical Ad Unit (160x600) -->
            <ins class="adsbygoogle"
                 style="display:inline-block;width:160px;height:600px"
                 data-ad-client="ca-pub-1243519901054274"
                 data-ad-slot="6555139052"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>

        <div id="map"></div>
    </div>

    <div id="upload-popup" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:11000; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
        <div class="modal" style="width:300px; align-items:center; padding:20px;">
            <h3 style="margin-top:0;">Add Photo URL</h3>
            <input type="text" id="imgUrlInput" class="modal-input" placeholder="Paste image link here..." style="margin-bottom:10px; padding:8px;">
            <div id="uploadPreviewContainer" style="width:100%; height:200px; background:#333; margin-bottom:15px; display:flex; align-items:center; justify-content:center; border-radius:8px; overflow:hidden;">
                <img id="uploadPreview" style="max-width:100%; max-height:100%; object-fit:contain;">
            </div>
            <div id="uploadProgressContainer" style="width:100%; height:6px; background:#eee; border-radius:3px; margin-bottom:10px; display:none; overflow:hidden;">
                <div id="uploadProgressBar" style="width:0%; height:100%; background:var(--primary); transition:width 0.2s;"></div>
            </div>
            <p id="uploadStatus" style="font-size:12px; opacity:0.7; margin-bottom:15px; text-align:center;">Previewing image...</p>
            <div style="display:flex; gap:10px; width:100%;">
                <button class="btn" onclick="cancelUpload()" style="flex:1; background:transparent; border:1px solid var(--border); color:var(--text);">Cancel</button>
                <button class="btn btn-save-action" id="btnConfirmUpload" onclick="performUrlAdd()" style="flex:1;">Add Image</button>
            </div>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="modal">
            <h3 id="modalTitle">Save Entry</h3>
            <div class="modal-inputs">
                <div id="pinTypeSelect" style="display:none;">
                   <span class="stat-label" style="text-align:center; display:block; margin-bottom:10px;">Select Pin Category</span>
                   <div class="pin-type-grid" id="modalTypePicker"></div>
                </div>
                <div id="modalPhotoSection">
                    <div id="modalPhotoList" style="display:flex; gap:5px; overflow-x:auto; margin-bottom:5px;"></div>
                    <button class="btn" onclick="openUrlUploadPopup('create')" style="background:rgba(0,0,0,0.05); border:1px solid var(--border); font-size:11px; height:32px;">üì∑ Add Photo</button>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; padding:0 5px;">
                    <span class="settings-label" style="font-size:12px;">Mark as Visited</span>
                    <label class="switch"><input type="checkbox" id="visitedToggle"><span class="slider"></span></label>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; padding:0 5px;">
                    <span class="settings-label" style="font-size:12px;">Make Public</span>
                    <label class="switch"><input type="checkbox" id="publicToggle"><span class="slider"></span></label>
                </div>
                <div id="modalFacilitiesSection">
                    <span class="settings-label" style="font-size:12px; margin-bottom:5px; display:block;">Facilities</span>
                    <div class="facility-grid" id="modalFacilityPicker"></div>
                </div>
                <input type="text" id="itemName" class="modal-input" placeholder="Location Name">
                <textarea id="itemDesc" class="modal-input" placeholder="Notes..." style="height: 60px; resize: none;"></textarea>
            </div>
            <div class="modal-btns">
                <button class="btn btn-save-action" id="confirmSaveBtn" style="height: 48px; font-size: 14px;">‚úÖ Save to Library</button>
                <button class="btn" style="background:none; color: var(--text); opacity: 0.6; border: 1px solid var(--border); height: 44px;" onclick="document.getElementById('modal-overlay').style.display='none'">Cancel</button>
            </div>
        </div>
    </div>

    <div id="emoji-modal-overlay" style="display:none; position:fixed; inset:0; background:rgba(15, 23, 42, 0.7); align-items:center; justify-content:center; z-index:10002; backdrop-filter:blur(4px);">
        <div class="modal" style="width: 320px; max-height: 80vh; display: flex; flex-direction: column;">
            <h3 style="margin-top:0;">Select Icon</h3>
            <div id="fullEmojiGrid" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; overflow-y: auto; padding-right: 5px; flex: 1;"></div>
            <button class="btn" onclick="document.getElementById('emoji-modal-overlay').style.display='none'" style="margin-top:15px; background:transparent; border:1px solid var(--border); color:var(--text);">Close</button>
        </div>
    </div>

    <div id="review-modal-overlay" style="display:none; position:fixed; inset:0; background:rgba(15, 23, 42, 0.7); align-items:center; justify-content:center; z-index:9999; backdrop-filter:blur(4px);">
        <div class="modal">
            <h3 id="reviewModalTitle">Rate & Review</h3>
            <div class="star-input" id="modalReviewStars" style="justify-content:center; margin-bottom:15px;">
                <span data-v="1">‚òÖ</span><span data-v="2">‚òÖ</span><span data-v="3">‚òÖ</span><span data-v="4">‚òÖ</span><span data-v="5">‚òÖ</span>
            </div>
            <textarea id="modalReviewText" class="modal-input" rows="4" placeholder="Share your experience (optional)..." style="margin-bottom:10px;"></textarea>
            <div id="modalReviewPhotoPreview" style="display:flex; gap:5px; overflow-x:auto; margin-bottom:10px;"></div>
            <button class="btn" onclick="openUrlUploadPopup('review')" style="margin-bottom:15px; background:rgba(0,0,0,0.05); border:1px solid var(--border); font-size:13px; height:42px; font-weight:600;">üì∑ Add Photo</button>
            <div class="modal-btns">
                <button class="btn btn-save-action" onclick="postComment()" id="postReviewBtn">Post Review</button>
                <button class="btn" onclick="closeReviewModal()" style="background:transparent; border:1px solid var(--border); color:var(--text);">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <script>
        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBG6ip3Uh6bDNgdr54Oy6sEtKxJROw4DC4",
            authDomain: "geojournal-fa10f.firebaseapp.com",
            databaseURL: "https://geojournal-fa10f-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "geojournal-fa10f",
            storageBucket: "geojournal-fa10f.firebasestorage.app",
            messagingSenderId: "185220958678",
            appId: "1:185220958678:web:d418dce420543722417c77",
            measurementId: "G-PX3SDJXSQR"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storageService = firebase.storage();

        // Pin Categories
        const PIN_TYPES = [
            { name: 'Nature', color: '#10b981', icon: 'üåø' },
            { name: 'History', color: '#ef4444', icon: 'üèõÔ∏è' },
            { name: 'Culture', color: '#d97706', icon: 'üé®' },
            { name: 'Mountain', color: '#8b5cf6', icon: '‚õ∞Ô∏è' },
            { name: 'Water', color: '#3b82f6', icon: 'üíß' },
            { name: 'Rock Formation', color: '#eab308', icon: 'ü™®' },
            { name: 'Landmark', color: '#ec4899', icon: 'üóø' },
            { name: 'Waterfall', color: '#06b6d4', icon: 'üåä' }
        ];

        const FACILITIES = [
            { id: 'parking', label: 'Car Park Nearby', icon: 'üÖøÔ∏è' },
            { id: 'free_parking', label: 'Free Parking Nearby', icon: 'üÜì' },
            { id: 'transport', label: 'Public Transport Nearby', icon: 'üöå' },
            { id: 'toilets', label: 'Toilets Nearby', icon: 'üöª' },
            { id: 'shop', label: 'Shop Nearby', icon: 'üõí' },
            { id: 'cafe', label: 'Cafe Nearby', icon: '‚òï' },
            { id: 'bins', label: 'Bins Nearby', icon: 'üóëÔ∏è' },
            { id: 'pets', label: 'Pets Allowed', icon: 'üêæ' },
            { id: 'camping', label: 'Camping Nearby', icon: '‚õ∫' },
            { id: 'wheelchair', label: 'Wheelchair Accessable', icon: '‚ôø' }
        ];

        const AVATAR_COLORS = [
            'linear-gradient(135deg, #2563eb, #06b6d4)', 
            'linear-gradient(135deg, #10b981, #3b82f6)', 
            'linear-gradient(135deg, #ef4444, #f59e0b)', 
            'linear-gradient(135deg, #8b5cf6, #ec4899)', 
            'linear-gradient(135deg, #ec4899, #f43f5e)', 
            'linear-gradient(135deg, #06b6d4, #10b981)', 
            'linear-gradient(135deg, #6366f1, #8b5cf6)', 
            'linear-gradient(135deg, #64748b, #94a3b8)',
            'linear-gradient(135deg, #f97316, #facc15)',
            'linear-gradient(135deg, #14b8a6, #0ea5e9)',
            'linear-gradient(135deg, #84cc16, #10b981)',
            'linear-gradient(135deg, #a855f7, #d946ef)',
            'linear-gradient(135deg, #3b82f6, #1d4ed8)',
            'linear-gradient(135deg, #f43f5e, #be123c)',
            'linear-gradient(135deg, #475569, #1e293b)',
            'linear-gradient(135deg, #78716c, #44403c)'
        ];

        const BASIC_EMOJIS = ['üë§', 'üôÇ', 'üìç', 'üå≤', 'üèîÔ∏è', 'üåä', 'üö≤', 'üèÉ'];
        const ALL_EMOJIS = [
            'üë§', 'üôÇ', 'üòÄ', 'üòé', 'ü§†', 'ü•≥', 'üò¥', 'ü§î', 
            'üìç', 'üè†', 'üè¢', '‚õ∫', 'üè∞', 'üóΩ', 'üóº', 'üóø',
            'üå≤', 'üå≥', 'üå¥', 'üåµ', 'üåø', 'üçÇ', 'üçÅ', 'üçÑ',
            'üèîÔ∏è', '‚õ∞Ô∏è', 'üåã', 'üóª', 'üèúÔ∏è', 'üèñÔ∏è', 'üèùÔ∏è', 'üèûÔ∏è',
            'üåä', 'üíß', 'üî•', 'üåà', '‚òÄÔ∏è', 'üåô', '‚≠ê', '‚òÅÔ∏è',
            'üö≤', 'üèÉ', 'üö∂', 'üßó', 'üèÑ', 'üèä', 'üö£', 'üèá',
            'üöó', '‚úàÔ∏è', 'üöÄ', 'üöÅ', 'üöÇ', 'üöå', 'üèéÔ∏è', 'üèçÔ∏è',
            'üì∏', 'üé®', 'üé§', 'üéß', 'üéÆ', 'üé≤', 'üß©', 'üß∏',
            'üê∂', 'üê±', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å',
            'üê∏', 'üê¢', 'üêô', 'üê¨', 'üê≥', 'ü¶à', 'üêä', 'ü¶ï'
        ];

        // Activity Color Coding
        const ACTIVITY_COLORS = {
            walk: '#10b981', 
            hike: '#d97706', 
            run: '#ef4444',  
            cycle: '#3b82f6' 
        };

        let selectedColor = PIN_TYPES[0].color;
        let storage = { pins: [], walks: [], theme: 'dark', mapStyle: 'sat', isMobile: false, units: 'metric', speeds: { walk: 5, hike: 4, run: 10, cycle: 20 } };
        let currentMode = 'explore', tempPath = [], pendingCoords = null, activeSelectionId = null, isEditing = false, graphOpen = false;
        let editingCommentId = null;
        let currentUser = null;
        let slideshowInterval = null;
        let currentPhotoIndex = 0;
        let activeLightboxPhotos = [];
        let currentLightboxIndex = 0;
        let tempCreationPhotos = [];
        let tempReviewPhotos = [];
        let uploadContext = 'edit';
        
        // Reworked Filters Object
        let activeFilters = {
            showPins: true,
            showWalks: true,
            activities: ['walk', 'hike', 'run', 'cycle'],
            categories: PIN_TYPES.map(t => t.name),
            sort: 'rating',
            onlyMine: false,
            search: ''
        };
        
        let myLogFilters = {
            showPins: true,
            showWalks: true,
            activities: ['walk', 'hike', 'run', 'cycle'],
            categories: PIN_TYPES.map(t => t.name),
            sort: 'date',
            privacy: 'all',
            visited: 'all'
        };

        let currentTab = 'explore';
        let mapItems = new L.FeatureGroup(), userPos = null, userMarker = null, nodeHandles = [], waypointMarkers = [], chartInstance = null;
        let elevationAbortController = null;
        let miniMap = null, miniMapLayer = null, miniMapPoly = null;
        let isFirstLocationLoad = true; 
        let walkHistory = [];

        // Recording State
        let isRecording = false;
        let isPaused = false;
        let liveElevData = [];
        let recordStartTime = null;
        let recordTimerInterval = null;
        let finalRecordedTime = 0;
        let pauseStart = 0;
        let isFlying = false;
        let flyAnimationId = null;
        let flyMarker = null;
        let currentFlySpeed = 1.0;
        let currentFlyZoom = 17.0;
        let flyStartTime = 0;
        let isFlyPaused = false;
        let flyPath = null;
        let flyTotalDist = 0;
        let flyCumDists = [];
        let currentFlyDist = 0;
        let flyCurrentBearing = 0;
        let flyLastTime = 0;
        let flySpeedKmH = 5;

        function formatDate(ts) {
            if (!ts) return '';
            return new Date(ts).toLocaleDateString('en-GB');
        }

        function adjustFlySpeed(delta) {
            currentFlySpeed = Math.max(0.5, Math.min(10, currentFlySpeed + delta));
            document.getElementById('flySpeedDisplay').innerText = currentFlySpeed.toFixed(1) + 'x';
        }

        function adjustFlyZoom(delta) {
            currentFlyZoom = Math.max(10, Math.min(20, currentFlyZoom + delta));
            document.getElementById('flyZoomDisplay').innerText = currentFlyZoom.toFixed(1);
        }
        
        function toggleFlyPause() {
            isFlyPaused = !isFlyPaused;
            const btn = document.getElementById('flyPauseBtn');
            if(isFlyPaused) {
                btn.innerText = "‚ñ∂ RESUME";
                btn.style.background = "var(--accent)";
                btn.style.color = "white";
            } else {
                btn.innerText = "‚è∏ PAUSE";
                btn.style.background = "var(--border)";
                btn.style.color = "var(--text)";
            }
        }

        function rewindFlyover() {
            const distToRewind = 50 * currentFlySpeed * 10; 
            currentFlyDist = Math.max(0, currentFlyDist - distToRewind);
            if(isFlyPaused) updateFlyoverFrame();
        }

        const map = L.map('map', { zoomControl: false, zoomSnap: 0.1 }).setView([51.505, -0.09], 3);
        mapItems.addTo(map);

        const mapStyles = { 
            voyager: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', 
            dark: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
            sat: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
            topo: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
            transit: 'https://tile.memomaps.de/tilegen/{z}/{x}/{y}.png',
            hybrid: 'https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}'
        };

        let baseLayer = L.tileLayer(mapStyles[storage.mapStyle] || mapStyles.voyager).addTo(map);
        let tempPoly = L.polyline([], {color: '#2563eb', weight: 6, opacity: 0.8}).addTo(map);

        // --- DATABASE SYNC FUNCTIONS ---
        async function loadPermanentData() {
            try {
                // Load Public Pins
                const pubPins = await db.collection("pins").where("isPublic", "==", true).get();
                // Load My Pins
                let myPins = { docs: [] };
                if (currentUser) {
                    myPins = await db.collection("pins").where("userId", "==", currentUser.uid).get();
                }
                
                // Merge Pins (Map by ID to dedup)
                const pinMap = new Map();
                pubPins.docs.forEach(doc => pinMap.set(doc.id, doc.data()));
                myPins.docs.forEach(doc => pinMap.set(doc.id, doc.data()));
                storage.pins = Array.from(pinMap.values());
                
                // Load Public Walks
                const pubWalks = await db.collection("walks").where("isPublic", "==", true).get();
                // Load My Walks
                let myWalks = { docs: [] };
                if (currentUser) {
                    myWalks = await db.collection("walks").where("userId", "==", currentUser.uid).get();
                }

                const walkMap = new Map();
                const processWalk = (doc) => {
                    const d = doc.data();
                    if (d.path && d.path.length > 0 && typeof d.path[0] === 'object' && !Array.isArray(d.path[0])) {
                        d.path = d.path.map(p => [p.lat, p.lng]);
                    }
                    return d;
                };
                
                pubWalks.docs.forEach(doc => walkMap.set(doc.id, processWalk(doc)));
                myWalks.docs.forEach(doc => walkMap.set(doc.id, processWalk(doc)));
                storage.walks = Array.from(walkMap.values());
                
                initFiltersUI();
                initMyLogFiltersUI();
                applyVisitedStatus();
                refreshMapItems();
                updateHighlights();
            } catch (e) { console.error("Database load error:", e); }
        }

        async function saveToCloud(collection, data) {
            try {
                const cleanData = JSON.parse(JSON.stringify(data));
                if (cleanData.path && cleanData.path.length > 0 && Array.isArray(cleanData.path[0])) {
                    cleanData.path = cleanData.path.map(p => ({ lat: p[0], lng: p[1] }));
                }
                if (!cleanData.userId) cleanData.userId = currentUser.uid;
                
                // Ensure creatorName is set
                if (!cleanData.creatorName) {
                    if (currentUser.displayName) cleanData.creatorName = currentUser.displayName;
                    else {
                        try {
                            const uDoc = await db.collection('users').doc(currentUser.uid).get();
                            if(uDoc.exists && uDoc.data().displayName) cleanData.creatorName = uDoc.data().displayName;
                        } catch(e){}
                    }
                }

                await db.collection(collection).doc(cleanData.id.toString()).set(cleanData);
            } catch (e) { console.error("Cloud save error:", e); }
        }

        function applyVisitedStatus() {
            if (!currentUser) return;
            const visitedSet = new Set(currentUser.visitedItems || []);
            const visitedMap = currentUser.visitedData || {};
            
            const process = (item) => {
                if (visitedMap[item.id]) {
                    item.visited = true;
                    item.visitedDate = visitedMap[item.id];
                } else if (visitedSet.has(item.id)) {
                    item.visited = true;
                    item.visitedDate = null;
                } else {
                    item.visited = false;
                    item.visitedDate = null;
                }
            };
            
            storage.pins.forEach(process);
            storage.walks.forEach(process);
        }

        // --- NEW REDESIGNED FILTER LOGIC ---
        function initFiltersUI() {
            const pinGrid = document.getElementById('pinGridReveal');
            pinGrid.innerHTML = '';
            PIN_TYPES.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'sub-toggle-btn active';
                btn.dataset.cat = cat.name;
                btn.dataset.color = cat.color;
                btn.style.borderColor = cat.color;
                btn.style.backgroundColor = cat.color;
                btn.style.color = 'white';
                btn.innerHTML = `<span class="filter-icon">${cat.icon}</span>${cat.name}`;
                btn.onclick = () => toggleSubFilter(btn, 'category');
                pinGrid.appendChild(btn);
            });

            // Initialize Activity Buttons Colors
            document.querySelectorAll('#activityGridReveal .sub-toggle-btn').forEach(btn => {
                const type = btn.dataset.type;
                const color = ACTIVITY_COLORS[type];
                if(color) {
                    btn.dataset.color = color;
                    btn.style.borderColor = color;
                    if(btn.classList.contains('active')) {
                        btn.style.backgroundColor = color;
                        btn.style.color = 'white';
                    }
                }
            });
        }
        
        function initMyLogFiltersUI() {
            const pinGrid = document.getElementById('myLogPinGridReveal');
            pinGrid.innerHTML = '';
            PIN_TYPES.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'sub-toggle-btn active';
                btn.dataset.cat = cat.name;
                btn.dataset.color = cat.color;
                btn.style.borderColor = cat.color;
                btn.style.backgroundColor = cat.color;
                btn.style.color = 'white';
                btn.innerHTML = `<span class="filter-icon">${cat.icon}</span>${cat.name}`;
                btn.onclick = () => toggleMyLogSubFilter(btn, 'category');
                pinGrid.appendChild(btn);
            });
            
            document.querySelectorAll('#myLogActivityGridReveal .sub-toggle-btn').forEach(btn => {
                const type = btn.dataset.type;
                const color = ACTIVITY_COLORS[type];
                if(color) {
                    btn.dataset.color = color;
                    btn.style.borderColor = color;
                    if(btn.classList.contains('active')) {
                        btn.style.backgroundColor = color;
                        btn.style.color = 'white';
                    }
                }
            });
        }

        function toggleFilterSection(id, btn) {
            const el = document.getElementById(id);
            const isHidden = el.style.display === 'none';
            el.style.display = isHidden ? 'grid' : 'none';
            btn.classList.toggle('active', isHidden);
            const chevron = btn.querySelector('.chevron');
            if(chevron) chevron.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        function toggleSubFilter(btn, filterType) {
            btn.classList.toggle('active');
            const isActive = btn.classList.contains('active');
            
            const color = btn.dataset.color;
            if (color) {
                if (isActive) {
                    btn.style.backgroundColor = color;
                    btn.style.color = 'white';
                } else {
                    btn.style.backgroundColor = '';
                    btn.style.color = '';
                }
            }
            
            if (filterType === 'activity') {
                const val = btn.dataset.type;
                if (isActive) activeFilters.activities.push(val);
                else activeFilters.activities = activeFilters.activities.filter(a => a !== val);
            } else {
                const val = btn.dataset.cat;
                if (isActive) activeFilters.categories.push(val);
                else activeFilters.categories = activeFilters.categories.filter(c => c !== val);
            }
            updateHighlights();
        }

        function setFilterMode(mode, btn) {
            btn.parentElement.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            if (mode === 'all') {
                activeFilters.showPins = true; activeFilters.showWalks = true;
                document.getElementById('filterSectionPins').style.display = 'flex';
                document.getElementById('filterSectionActivities').style.display = 'flex';
            } else if (mode === 'pins') {
                activeFilters.showPins = true; activeFilters.showWalks = false;
                document.getElementById('filterSectionPins').style.display = 'flex';
                document.getElementById('filterSectionActivities').style.display = 'none';
            } else if (mode === 'walks') {
                activeFilters.showPins = false; activeFilters.showWalks = true;
                document.getElementById('filterSectionPins').style.display = 'none';
                document.getElementById('filterSectionActivities').style.display = 'flex';
            }
            updateHighlights();
        }

        function setMyLogSort(type, btn) {
            myLogFilters.sort = type;
            btn.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateMyLogList();
        }
        
        function setMyLogPrivacy(val) {
            myLogFilters.privacy = val;
            updateMyLogList();
        }

        async function toggleVisited() {
            if(!activeSelectionId) return;
            const item = storage.pins.find(p=>p.id===activeSelectionId) || storage.walks.find(w=>w.id===activeSelectionId);
            if(!item) return;
            
            item.visited = !item.visited;
            
            if (!currentUser.visitedData) currentUser.visitedData = {};
            if (!currentUser.visitedItems) currentUser.visitedItems = []; // Legacy support
            
            const idStr = item.id.toString();
            
            if (item.visited) {
                item.visitedDate = Date.now();
                currentUser.visitedData[idStr] = item.visitedDate;
                if (!currentUser.visitedItems.includes(item.id)) currentUser.visitedItems.push(item.id);
            } else {
                delete currentUser.visitedData[idStr];
                item.visitedDate = null;
                currentUser.visitedItems = currentUser.visitedItems.filter(id => id !== item.id);
            }

            // Save to User Profile instead of Item
            db.collection('users').doc(currentUser.uid).set({ visitedItems: currentUser.visitedItems, visitedData: currentUser.visitedData }, { merge: true });

            updateVisitedButton(item);
            refreshMapItems();
        }

        function setMyLogVisited(val, btn) {
            myLogFilters.visited = val;
            btn.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateMyLogList();
        }
        
        function setMyLogFilterMode(mode, btn) {
            btn.parentElement.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if (mode === 'all') {
                myLogFilters.showPins = true; myLogFilters.showWalks = true;
                document.getElementById('myLogFilterSectionPins').style.display = 'flex';
                document.getElementById('myLogFilterSectionActivities').style.display = 'flex';
            } else if (mode === 'pins') {
                myLogFilters.showPins = true; myLogFilters.showWalks = false;
                document.getElementById('myLogFilterSectionPins').style.display = 'flex';
                document.getElementById('myLogFilterSectionActivities').style.display = 'none';
            } else if (mode === 'walks') {
                myLogFilters.showPins = false; myLogFilters.showWalks = true;
                document.getElementById('myLogFilterSectionPins').style.display = 'none';
                document.getElementById('myLogFilterSectionActivities').style.display = 'flex';
            }
            updateMyLogList();
        }
        
        function toggleMyLogSubFilter(btn, filterType) {
            btn.classList.toggle('active');
            const isActive = btn.classList.contains('active');
            const color = btn.dataset.color;
            if (color) { btn.style.backgroundColor = isActive ? color : ''; btn.style.color = isActive ? 'white' : ''; }
            
            const val = filterType === 'activity' ? btn.dataset.type : btn.dataset.cat;
            if (isActive) { if(filterType==='activity') myLogFilters.activities.push(val); else myLogFilters.categories.push(val); }
            else { if(filterType==='activity') myLogFilters.activities = myLogFilters.activities.filter(a=>a!==val); else myLogFilters.categories = myLogFilters.categories.filter(c=>c!==val); }
            updateMyLogList();
        }

        function toggleSettingsSection(id, btn) {
            const el = document.getElementById(id);
            const isHidden = el.style.display === 'none';
            el.style.display = isHidden ? 'flex' : 'none';
            const chevron = btn.querySelector('.chevron');
            if(chevron) chevron.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(-90deg)';
        }

        function setSort(type, btn) {
            activeFilters.sort = type;
            btn.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateHighlights();
        }

        // Device / Theme setup
        if (localStorage.getItem('geojournal_v11')) {
            const localData = JSON.parse(localStorage.getItem('geojournal_v11'));
            storage.theme = localData.theme || 'dark';
            storage.mapStyle = localData.mapStyle || 'sat';
            storage.isMobile = localData.isMobile || false;
            storage.units = localData.units || 'metric';
            storage.speeds = localData.speeds || { walk: 5, hike: 4, run: 10, cycle: 20 };
        }

        if (storage.isMobile) {
            document.body.classList.add('mobile-mode');
            document.getElementById('deviceToggleSettings').innerText = 'Switch to PC';
        } else {
            document.getElementById('deviceToggleSettings').innerText = 'Switch to Mobile';
        }
        
        const mapSel = document.getElementById('settingsMapSelect');
        if(mapSel) mapSel.value = storage.mapStyle;

        const unitSel = document.getElementById('unitSelect');
        if(unitSel) unitSel.value = storage.units;
        updateSpeedInputs();

        function changeUnits(val) {
            storage.units = val;
            saveData();
            updateSpeedInputs();
            updateHighlights();
            if(activeSelectionId) {
                const item = storage.walks.find(w => w.id === activeSelectionId);
                if(item) updateWalkStats();
            }
        }

        function updateSpeedInputs() {
            const isImp = storage.units === 'imperial';
            document.getElementById('speedUnitLabel').innerText = isImp ? 'mph' : 'km/h';
            ['walk', 'hike', 'run', 'cycle'].forEach(type => {
                const kmh = storage.speeds[type];
                document.getElementById('speed' + type.charAt(0).toUpperCase() + type.slice(1)).value = isImp ? (kmh * 0.621371).toFixed(1) : kmh;
            });
        }

        function saveSpeeds() {
            const isImp = storage.units === 'imperial';
            ['walk', 'hike', 'run', 'cycle'].forEach(type => {
                let val = parseFloat(document.getElementById('speed' + type.charAt(0).toUpperCase() + type.slice(1)).value) || 0;
                if(isImp) val = val / 0.621371;
                storage.speeds[type] = val;
            });
            saveData();
        }

        function formatDist(km) {
            if (storage.units === 'imperial') return (km * 0.621371).toFixed(2) + ' mi';
            return parseFloat(km).toFixed(2) + ' km';
        }
        function formatElev(m) {
            if (storage.units === 'imperial') return Math.round(m * 3.28084) + ' ft';
            return Math.round(m) + ' m';
        }

        const theme = storage.theme || 'dark';
        document.body.classList.remove('light-theme', 'dark-theme');
        document.body.classList.add(theme + '-theme');
        document.getElementById('themeToggle').checked = (storage.theme === 'dark');

        function toggleDeviceMode() {
            storage.isMobile = !storage.isMobile;
            saveData();
            location.reload(); 
        }

        function resetSidebarScroll() {
            const area = document.getElementById('mainScrollArea');
            if (area) area.scrollTo({top: 0, behavior: 'smooth'});
        }

        // Activity selector logic
        document.querySelectorAll('#addModeSelector .mode-btn, #editModeSelector .mode-btn').forEach(btn => {
            btn.onclick = () => {
                const parent = btn.parentElement;
                parent.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const activityMode = btn.dataset.mode;
                selectedColor = ACTIVITY_COLORS[activityMode];

                if (currentMode === 'walk') {
                    tempPoly.setStyle({color: selectedColor});
                }
                if (currentMode === 'walk') updateWalkStats();
                
                if (isEditing && activeSelectionId) {
                    const walk = storage.walks.find(w => w.id === activeSelectionId);
                    if (walk) {
                        walk.activity = activityMode;
                        walk.color = selectedColor;
                        if (window.currentActiveLayer) {
                            window.currentActiveLayer.setStyle({color: selectedColor});
                        }
                        renderTypeLabel(walk);
                        updateWalkStats();
                    }
                }
            };
        });

        // Mobile Dragging logic
        let startY = 0, startTop = 0, startTime = 0, isDragging = false;
        const mobileSidebar = document.getElementById('sidebar');
        const dragHandle = document.getElementById('mobileDragHandle');
        const mobileHeader = document.getElementById('mobileHeader');

        function triggerHaptic() {
            if (window.navigator && window.navigator.vibrate) {
                window.navigator.vibrate(15);
            }
        }

        function snapTo(state) {
            mobileSidebar.style.transition = 'top 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
            if (state === 'open') {
                mobileSidebar.classList.remove('half');
                mobileSidebar.classList.add('open');
                mobileSidebar.style.top = '6vh';
            } else if (state === 'half') {
                mobileSidebar.classList.remove('open');
                mobileSidebar.classList.add('half');
                mobileSidebar.style.top = '50vh';
            } else {
                mobileSidebar.classList.remove('open', 'half');
                mobileSidebar.style.top = 'calc(100vh - 110px)'; 
            }
            triggerHaptic();
            resetSidebarScroll();
        }

        const handleDragStart = (e) => {
            if (!document.body.classList.contains('mobile-mode')) return;
            startY = e.touches[0].clientY;
            startTop = mobileSidebar.offsetTop;
            startTime = Date.now();
            isDragging = false;
            mobileSidebar.style.transition = 'none';
        };

        const handleDragMove = (e) => {
            if (!document.body.classList.contains('mobile-mode')) return;
            const touchY = e.touches[0].clientY;
            const deltaY = touchY - startY;
            if (Math.abs(deltaY) > 5) isDragging = true;
            let newTop = startTop + deltaY;
            const vh = window.innerHeight;
            if (newTop < vh * 0.06) newTop = vh * 0.06;
            if (newTop > vh - 110) newTop = vh - 110;
            mobileSidebar.style.top = newTop + 'px';
        };

        const handleDragEnd = (e) => {
            if (!document.body.classList.contains('mobile-mode')) return;
            if (!isDragging) return;
            const currentTop = mobileSidebar.offsetTop;
            const vh = window.innerHeight;
            if (currentTop < vh * 0.3) snapTo('open');
            else if (currentTop < vh * 0.7) snapTo('half');
            else snapTo('bottom');
        };

        [dragHandle, mobileHeader].forEach(el => {
            el.addEventListener('touchstart', handleDragStart, { passive: true });
            el.addEventListener('touchmove', handleDragMove, { passive: true });
            el.addEventListener('touchend', handleDragEnd, { passive: true });
        });

        dragHandle.addEventListener('click', () => {
            if (document.body.classList.contains('mobile-mode')) {
                if (mobileSidebar.classList.contains('open')) snapTo('bottom');
                else if (mobileSidebar.classList.contains('half')) snapTo('open');
                else snapTo('half');
            }
        });

        // GPS watcher
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition((position) => {
                const latlng = L.latLng(position.coords.latitude, position.coords.longitude);
                userPos = latlng;
                if (!userMarker) {
                    userMarker = L.marker(latlng, { icon: L.divIcon({ className: '', html: '<div class="gps-indicator-wrapper"><div class="gps-indicator"></div><div class="gps-pulse"></div></div>', iconSize: [14, 14], iconAnchor: [7, 7] }) }).addTo(map);
                } else { userMarker.setLatLng(latlng); }
                if (isFirstLocationLoad) { map.setView(latlng, 15); isFirstLocationLoad = false; }
                
                if(isRecording && !isPaused) {
                    if(tempPath.length === 0 || latlng.distanceTo(L.latLng(tempPath[tempPath.length-1][0], tempPath[tempPath.length-1][1])) > 5) {
                        tempPath.push([latlng.lat, latlng.lng]);
                        tempPoly.setLatLngs(tempPath);
                        let d = 0; for(let i=1; i<tempPath.length; i++) d += L.latLng(tempPath[i-1][0], tempPath[i-1][1]).distanceTo(L.latLng(tempPath[i][0], tempPath[i][1])); 
                        document.getElementById('hudDist').innerText = formatDist(d/1000);
                        fetchLivePointElevation(latlng.lat, latlng.lng);
                    }
                }
                updateHighlights();
            }, (error) => console.error(error), { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 });
        }

        async function fetchLivePointElevation(lat, lon) {
            try {
                const res = await fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lon}`).then(r=>r.json());
                if(res.results && res.results[0]) {
                    const e = res.results[0].elevation;
                    liveElevData.push(e);
                    const min = Math.round(Math.min(...liveElevData));
                    const max = Math.round(Math.max(...liveElevData));
                    document.getElementById('hudMinHeight').innerText = `MIN: ${formatElev(min)}`;
                    document.getElementById('hudMaxHeight').innerText = `MAX: ${formatElev(max)}`;
                    if(graphOpen) renderLiveRecordingGraph();
                }
            } catch(e){}
        }

        function renderLiveRecordingGraph() {
            document.getElementById('elevation-dock').classList.add('active');
            let currentTotal = 0, distData = [0]; 
            for(let j = 1; j < tempPath.length; j++){ 
                currentTotal += L.latLng(tempPath[j-1][0], tempPath[j-1][1]).distanceTo(L.latLng(tempPath[j][0], tempPath[j][1])); 
                distData.push(currentTotal / 1000); 
            }
            const isImp = storage.units === 'imperial';
            const ctx = document.getElementById('elevChart').getContext('2d'); 
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { 
                type:'line', 
                data:{ 
                    labels: distData.map(d => isImp ? (d * 0.621371).toFixed(1) : d.toFixed(1)), 
                    datasets:[{ data: liveElevData.map(e => isImp ? e * 3.28084 : e), borderColor:'#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.15)', fill:true, pointRadius:0, borderWidth: 2, tension:0.4 }] 
                }, 
                options:{ maintainAspectRatio:false, plugins:{ legend:{display:false} }, scales:{ x:{ title:{display:true, text: isImp ? 'mi' : 'km'} }, y:{ title:{display:true, text: isImp ? 'ft' : 'm'}, position:'right' } } } 
            });
        }

        function renderTypeLabel(item) {
            const typeLabelDiv = document.getElementById('detTypeLabel');
            const typeOverlay = document.getElementById('detTypeOverlay');
            if (!typeLabelDiv) return;
            
            let typeText = '', typeColor = item.color || '#2563eb', typeIcon = 'üìç';
            if (item.path || item.type === 'WALK') {
                const act = item.activity || 'walk';
                typeText = act.toUpperCase();
                typeColor = ACTIVITY_COLORS[act] || '#2563eb';
                typeIcon = act === 'cycle' ? 'üö≤' : (act === 'run' ? '‚ö°' : (act === 'hike' ? 'ü•æ' : 'üö∂'));
            } else {
                const cat = PIN_TYPES.find(t => t.color === item.color);
                typeText = cat ? cat.name.toUpperCase() : 'PIN';
                typeIcon = cat ? cat.icon : 'üìç';
            }
            
            let lat = item.lat;
            let lng = item.lng;
            if ((!lat || !lng) && item.path && item.path.length > 0) {
                lat = item.path[0][0];
                lng = item.path[0][1];
            }
            
            let distText = '';
            if (userPos && lat && lng) {
                const d = userPos.distanceTo(L.latLng(lat, lng)) / 1000;
                distText = ` ‚Ä¢ ${formatDist(d)} away`;
            }

            const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            
            if(typeOverlay) {
                typeOverlay.innerHTML = `<span class="type-label" style="background:${typeColor}; font-size:11px; padding:4px 8px; border-radius:6px; box-shadow:0 2px 4px rgba(0,0,0,0.2); margin:0;">${typeIcon} ${typeText}</span>`;
            }
            
            const isOwner = currentUser && item.userId === currentUser.uid;
            let ownerHtml = '';
            if (isOwner) {
                const btnText = isEditing ? '‚úÖ Finish Editing' : 'üñãÔ∏è Edit Entry';
                const btnBg = isEditing ? 'var(--accent)' : 'var(--primary)';
                const delDisplay = isEditing ? 'flex' : 'none';

                ownerHtml = `
                    <div style="display:flex; gap:8px; margin-bottom:4px;">
                        <button class="btn" id="bigEditBtn" onclick="toggleEditingLogic()" style="flex:1; height:44px; font-size:13px; background:${btnBg}; border:none; color:white; display:flex; align-items:center; justify-content:center; gap:8px; font-weight:700; border-radius:12px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                            ${btnText}
                        </button>
                        <button class="btn" id="bigDeleteBtn" onclick="deleteAction()" style="display:${delDisplay}; width:44px; height:44px; background:var(--danger); border:none; color:white; align-items:center; justify-content:center; border-radius:12px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">üóëÔ∏è</button>
                    </div>
                `;
            }

            typeLabelDiv.innerHTML = `
                ${ownerHtml}
                <a href="${navUrl}" target="_blank" style="text-decoration:none; display:block;">
                    <button class="btn" style="width:100%; height:44px; font-size:13px; background:var(--card); border:1px solid var(--border); color:var(--text); display:flex; align-items:center; justify-content:center; gap:8px; font-weight:700; border-radius:12px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/a/aa/Google_Maps_icon_%282020%29.svg" style="width:20px; height:20px;"> Navigate${distText}
                    </button>
                </a>`;
        }

        function setupTypePickers() {
            ['modalTypePicker', 'detailTypePicker'].forEach(id => {
                const el = document.getElementById(id); if (!el) return;
                el.innerHTML = '';
                PIN_TYPES.forEach(t => {
                    const btn = document.createElement('button'); 
                    btn.className = 'type-btn';
                    btn.style.backgroundColor = t.color;
                    if(t.color === selectedColor) btn.classList.add('active');
                    btn.innerHTML = `${t.icon}<span>${t.name}</span>`;
                    btn.onclick = (e) => {
                        e.preventDefault();
                        selectedColor = t.color; 
                        el.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active')); 
                        btn.classList.add('active');
                        if(id === 'detailTypePicker' && isEditing) {
                            const item = storage.pins.find(p=>p.id===activeSelectionId) || storage.walks.find(w=>w.id===activeSelectionId);
                            if(item) { 
                                item.color = t.color; 
                                saveData(); 
                                saveToCloud(item.path ? 'walks' : 'pins', item);
                                refreshMapItems(); 
                                renderTypeLabel(item);
                            }
                        }
                    }; el.appendChild(btn);
                });
            });
        }

        function toggleLayerMenu() { const menu = document.getElementById('layer-popup'); menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex'; }
        function setMapLayer(style) { 
            storage.mapStyle = style; 
            map.removeLayer(baseLayer); 
            baseLayer = L.tileLayer(mapStyles[style], { maxZoom: 18 }).addTo(map); 
            saveData(); 
            document.getElementById('layer-popup').style.display = 'none';
            
            const flySel = document.getElementById('flyMapSelect');
            if(flySel) flySel.value = style;
            
            const sel = document.getElementById('settingsMapSelect');
            if(sel) sel.value = style;
        }
        function isUIPressed(e) { return e.originalEvent.target.closest('#sidebar') || e.originalEvent.target.closest('#elevation-dock') || e.originalEvent.target.closest('.zoom-controls') || e.originalEvent.target.closest('#layer-popup') || e.originalEvent.target.closest('#expandBtn') || e.originalEvent.target.closest('#recording-popout'); }

        const locateBtn = document.getElementById('locateBtn');
        if (locateBtn) locateBtn.onclick = (e) => { L.DomEvent.stopPropagation(e); if (userPos) map.setView(userPos, 15); };

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const expandBtn = document.getElementById('expandBtn');
            const dock = document.getElementById('elevation-dock');
            if(document.body.classList.contains('mobile-mode')) { snapTo('bottom'); return; }
            const isMinimized = sidebar.classList.toggle('minimized');
            expandBtn.style.display = isMinimized ? 'flex' : 'none';
            if (isMinimized) { dock.style.left = '20px'; } else { dock.style.left = 'calc(var(--sidebar) + 20px)'; }
            setTimeout(() => map.invalidateSize(), 400);
        }

        function goBack() {
            document.getElementById('backBtn').style.display = 'none';
            document.getElementById('minimizeBtn').style.display = 'flex';
            document.getElementById('mainTabs').style.display = 'flex';
            document.getElementById('detail-view').style.display = 'none';
            document.getElementById('editWalkOptions').style.display = 'none';
            document.getElementById('mainSearch').style.display = 'block'; 
            waypointMarkers.forEach(m => map.removeLayer(m)); waypointMarkers = [];
            closeElevation(); switchTab('explore');
            if(document.body.classList.contains('mobile-mode')) snapTo('open');
            resetSidebarScroll();
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const targetTab = document.getElementById(tab + 'Tab');
            if (targetTab) targetTab.classList.add('active');
            document.getElementById('explore-panel').style.display = (tab === 'explore' ? 'block' : 'none');
            document.getElementById('add-panel').style.display = (tab === 'add' ? 'block' : 'none');
            document.getElementById('settings-panel').style.display = (tab === 'settings' ? 'block' : 'none');
            document.getElementById('detail-view').style.display = 'none';
            document.getElementById('editWalkOptions').style.display = 'none';
            document.getElementById('mainSearch').style.display = 'block'; 
            closeElevation(); setMode(tab === 'explore' ? 'explore' : 'ready');
            refreshMapItems();
            resetSidebarScroll();
        }

        function setMode(mode) {
            currentMode = mode; document.querySelectorAll('.btn-main').forEach(b => b.classList.remove('active-mode'));
            if (document.getElementById(mode + 'ModeBtn')) document.getElementById(mode + 'ModeBtn').classList.add('active-mode');
            
            document.getElementById('route-stats').style.display = (mode === 'walk' ? 'block' : 'none');
            document.getElementById('walk-options').style.display = (mode === 'walk' ? 'block' : 'none');
            document.getElementById('recordModeBtn').style.display = (mode === 'record' || isRecording ? 'none' : 'block');
            
            const popout = document.getElementById('recording-popout');
            popout.style.display = (isRecording ? 'flex' : 'none');
            
            const zoomCtrl = document.getElementById('zoomCtrl');
            const layerPop = document.getElementById('layer-popup');
            if(isRecording) {
                zoomCtrl.style.top = (popout.offsetHeight + 40) + 'px';
                layerPop.style.top = (popout.offsetHeight + 180) + 'px';
            } else {
                zoomCtrl.style.top = '20px';
                layerPop.style.top = '160px';
            }
            
            isEditing = false; nodeHandles.forEach(h => map.removeLayer(h));
            if(mode !== 'walk' && mode !== 'pin' && mode !== 'record') { 
                tempPath = []; 
                walkHistory = []; 
                nodeHandles.forEach(h => map.removeLayer(h)); nodeHandles = [];
                tempPoly.setLatLngs([]); 
                closeElevation();
            }
        }

        if (pinModeBtn) pinModeBtn.onclick = () => { selectedColor = PIN_TYPES[0].color; setupTypePickers(); setMode('pin'); };
        if (walkModeBtn) walkModeBtn.onclick = () => { 
            const activityMode = document.querySelector('#addModeSelector .mode-btn.active').dataset.mode;
            selectedColor = ACTIVITY_COLORS[activityMode];
            tempPoly.setStyle({color: selectedColor});
            setupTypePickers(); 
            setMode('walk'); 
        };
        if (recordModeBtn) recordModeBtn.onclick = startRecording;

        document.getElementById('cancelAddBtn').onclick = () => {
            if(confirm("Discard current plot?")) {
                tempPath = [];
                walkHistory = [];
                tempPoly.setLatLngs([]);
                nodeHandles.forEach(h => map.removeLayer(h)); nodeHandles = [];
                document.getElementById('liveDist').innerText = '0.00 km';
                closeElevation();
                setMode('ready');
            }
        };

        function startRecording() {
            if(!userPos) { alert("Waiting for GPS signal..."); return; }
            isRecording = true;
            isPaused = false;
            liveElevData = [];
            tempPath = [[userPos.lat, userPos.lng]];
            
            const activityMode = document.querySelector('#addModeSelector .mode-btn.active').dataset.mode;
            tempPoly.setLatLngs(tempPath);
            tempPoly.setStyle({color: ACTIVITY_COLORS[activityMode], dashArray: null}); 
            
            recordStartTime = Date.now();
            finalRecordedTime = 0;
            startTimer();

            setMode('record');
            document.getElementById('hudPausePlay').innerText = '‚è∏ PAUSE';
            document.getElementById('hudMinHeight').innerText = 'MIN: --m';
            document.getElementById('hudMaxHeight').innerText = 'MAX: --m';
            map.flyTo(userPos, 16);
            if(document.body.classList.contains('mobile-mode')) snapTo('bottom');
            fetchLivePointElevation(userPos.lat, userPos.lng);
        }

        function startTimer() {
            if(recordTimerInterval) clearInterval(recordTimerInterval);
            recordTimerInterval = setInterval(() => {
                if(!isPaused) {
                    const diff = Date.now() - recordStartTime;
                    const sec = Math.floor(diff / 1000) % 60;
                    const min = Math.floor(diff / 60000) % 60;
                    const hrs = Math.floor(diff / 3600000);
                    document.getElementById('hudTimer').innerText = 
                        (hrs > 0 ? hrs + ":" : "") + 
                        String(min).padStart(2, '0') + ":" + 
                        String(sec).padStart(2, '0');
                    finalRecordedTime = Math.floor(diff / 60000); 
                }
            }, 1000);
        }

        document.getElementById('hudPausePlay').onclick = () => {
            isPaused = !isPaused;
            document.getElementById('hudPausePlay').innerText = isPaused ? '‚ñ∂ RESUME' : '‚è∏ PAUSE';
            document.getElementById('hudPausePlay').style.background = isPaused ? 'var(--accent)' : 'rgba(255,255,255,0.2)';
            if(isPaused) { pauseStart = Date.now(); } 
            else { recordStartTime += (Date.now() - pauseStart); }
        };

        document.getElementById('hudStop').onclick = () => {
            isRecording = false;
            clearInterval(recordTimerInterval);
            if(tempPath.length > 1) {
                const activityMode = document.querySelector('#addModeSelector .mode-btn.active').dataset.mode;
                selectedColor = ACTIVITY_COLORS[activityMode] || ACTIVITY_COLORS.walk;
                setupTypePickers();
                resetModal();
                document.getElementById('pinTypeSelect').style.display = 'none'; 
                document.getElementById('modal-overlay').style.display = 'flex';
            } else {
                tempPath = [];
                tempPoly.setLatLngs([]);
                setMode('ready');
            }
            closeElevation();
        };

        document.getElementById('finishWalkBtn').onclick = () => {
            if (tempPath.length < 2) { alert("Please draw a route first!"); return; }
            const activityMode = document.querySelector('#addModeSelector .mode-btn.active').dataset.mode;
            selectedColor = ACTIVITY_COLORS[activityMode] || ACTIVITY_COLORS.walk;
            setupTypePickers();
            resetModal();
            document.getElementById('pinTypeSelect').style.display = 'none';
            document.getElementById('modal-overlay').style.display = 'flex';
        };

        function updateHighlights() {
            const list = document.getElementById('highlights-list'); if (!list) return;
            let all = [
                ...storage.pins.map(p => ({...p, type:'PIN'})), 
                ...storage.walks.map(w => ({...w, type:'WALK', lat:w.path[0][0], lng:w.path[0][1]}))
            ];
            
            // Explore Tab: Only show Public items
            all = all.filter(i => i.isPublic === true);
            
            all = all.filter(i => {
                if (i.type === 'PIN') {
                    if (!activeFilters.showPins) return false;
                    const cat = PIN_TYPES.find(t => t.color === i.color);
                    return cat && activeFilters.categories.includes(cat.name);
                }
                if (i.type === 'WALK') {
                    if (!activeFilters.showWalks) return false;
                    return activeFilters.activities.includes(i.activity || 'walk');
                }
                return true;
            });

            if (activeFilters.search) {
                const term = activeFilters.search.toLowerCase();
                all = all.filter(i => i.name.toLowerCase().includes(term) || 
                    (i.creatorName && i.creatorName.toLowerCase().includes(term)) ||
                    (i.comments && i.comments.some(c => c.displayName && c.displayName.toLowerCase().includes(term))));
            }

            // Update Map if on Explore Tab
            if (currentTab === 'explore') {
                mapItems.clearLayers();
                all.forEach(i => {
                    if (i.type === 'PIN') addPin(i);
                    else if (i.type === 'WALK') addWalk(i);
                });
            }

            if (userPos) all.forEach(i => i.d = L.latLng(i.lat, i.lng).distanceTo(userPos) / 1000);
            
            if (activeFilters.sort === 'rating') {
                all.sort((a,b) => {
                    const r = (b.rating || 0) - (a.rating || 0);
                    return r !== 0 ? r : (b.id - a.id);
                });
            } else {
                all.sort((a,b) => {
                    const dist = (a.d || 0) - (b.d || 0);
                    return dist !== 0 ? dist : (b.id - a.id);
                });
            }
            
            list.innerHTML = all.length ? '' : '<p style="font-size:12px;opacity:0.5;text-align:center;margin-top:20px;">No items match filters.</p>';
            all.forEach(i => {
                const div = document.createElement('div'); div.className = 'highlight-item'; div.style.borderLeft = `4px solid ${i.color || '#2563eb'}`;
                
                let labelText = '';
                let labelColor = i.color || '#2563eb';
                let iconChar = 'üìç';

                if (i.type === 'WALK') {
                    iconChar = i.activity === 'cycle' ? 'üö≤' : (i.activity === 'run' ? '‚ö°' : (i.activity === 'hike' ? 'ü•æ' : 'üö∂'));
                    labelText = i.activity ? i.activity.toUpperCase() : 'WALK';
                    labelColor = ACTIVITY_COLORS[i.activity] || '#2563eb';
                } else {
                    const category = PIN_TYPES.find(t => t.color === i.color);
                    labelText = category ? category.name.toUpperCase() : 'PIN';
                    iconChar = category ? category.icon : 'üìç';
                }

                let ratingHtml = '';
                if (i.rating > 0) {
                    ratingHtml = `<span style="display:inline-block; background:rgba(251, 191, 36, 0.15); color:#fbbf24; font-weight:800; padding:2px 6px; border-radius:4px; font-size:10px;">‚òÖ ${i.rating.toFixed(1)}</span>`;
                }
                
                const distHtml = (i.d !== undefined && i.d !== null) ? `<span style="font-weight:600; opacity:0.7;">${formatDist(i.d)} away</span>` : '';

                const thumb = (i.photos && i.photos.length > 0) ? i.photos[0] : (i.photo || 'https://placehold.co/100x100?text=No+Photo');
                
                let thumbHtml = `<img class="highlight-thumb" src="${thumb}">`;
                if (i.type === 'WALK' && i.path) {
                    thumbHtml = getRouteThumbnail(i.path, i.color || '#2563eb');
                }
                
                div.innerHTML = `
                    ${thumbHtml}
                    <div style="flex:1; min-width:0;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                            <span class="type-label" style="background:${labelColor}">${iconChar} ${labelText}</span>
                        </div>
                        <p style="font-weight:bold; font-size:13px; margin:0 0 6px 0; line-height:1.2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${i.name}</p>
                        <div style="display:flex; align-items:center; gap:8px; font-size:11px; color:var(--text); opacity:0.8;">
                            ${ratingHtml}
                            ${distHtml}
                        </div>
                    </div>${i.visited ? '<div class="visited-check-corner">‚úì</div>' : ''}`;
                div.onclick = () => { 
                    const obj = i.type === 'PIN' ? storage.pins.find(p=>p.id===i.id) : storage.walks.find(w=>w.id===i.id); 
                    if(i.type === 'WALK' && obj.path) {
                        const poly = L.polyline(obj.path);
                        const isMobile = document.body.classList.contains('mobile-mode');
                        const sidebarW = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidebar')) || 400;
                        const leftPad = isMobile ? 20 : (sidebarW + 30);
                        const bottomPad = isMobile ? (window.innerHeight / 2) : 40;
                        map.flyToBounds(poly.getBounds(), { paddingTopLeft: [leftPad, 20], paddingBottomRight: [20, bottomPad], duration: 0.8 });
                        showDetails(obj, true, null); 
                    } else { 
                        map.flyTo([i.lat, i.lng], 18, { duration: 0.8 });
                        showDetails(obj, false, null);
                    }
                };
                list.appendChild(div);
            });
        }

        async function getSnappedPath(startLatLng, endLatLng) {
            const url = `https://router.project-osrm.org/route/v1/foot/${startLatLng.lng},${startLatLng.lat};${endLatLng.lng},${endLatLng.lat}?overview=full&geometries=geojson`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.routes && data.routes.length > 0) {
                    return data.routes[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);
                }
            } catch (error) { console.error("Routing error:", error); }
            return [[endLatLng.lat, endLatLng.lng]]; 
        }

        map.on('click', async (e) => {
            if (isUIPressed(e)) return;
            if (isEditing && window.currentActiveLayer instanceof L.Polyline) { 
                const lls = window.currentActiveLayer.getLatLngs(); 
                const snapEnabled = document.getElementById('editSnapToggle').checked;
                walkHistory.push(lls.map(l => L.latLng(l.lat, l.lng)));
                if (snapEnabled && lls.length > 0) {
                    const roadNodes = await getSnappedPath(lls[lls.length - 1], e.latlng);
                    roadNodes.forEach(node => lls.push(L.latLng(node[0], node[1])));
                } else { lls.push(e.latlng); }
                window.currentActiveLayer.setLatLngs(lls); 
                updateWalkStats(); createNodes(window.currentActiveLayer); 
                fetchElevation(lls.map(l => [l.lat, l.lng]), false); 
                return; 
            }
            if (currentMode === 'pin') { 
                pendingCoords = e.latlng; 
                resetModal(); 
                document.getElementById('pinTypeSelect').style.display = 'block';
                document.getElementById('modal-overlay').style.display = 'flex'; 
            }
            if (currentMode === 'walk') {
                const snapEnabled = document.getElementById('snapToggle').checked;
                walkHistory.push(JSON.parse(JSON.stringify(tempPath)));
                if (snapEnabled && tempPath.length > 0) {
                    const lastPt = L.latLng(tempPath[tempPath.length - 1][0], tempPath[tempPath.length - 1][1]);
                    const roadNodes = await getSnappedPath(lastPt, e.latlng);
                    tempPath.push(...roadNodes);
                } else { tempPath.push([e.latlng.lat, e.latlng.lng]); }
                tempPoly.setLatLngs(tempPath); 
                createNodes(tempPoly);
                updateWalkStats();
                fetchElevation(tempPath, false); 
            }
        });

        function renderFacilityPicker(containerId, selectedIds = [], isEditingMode = false) {
            const container = document.getElementById(containerId);
            if(!container) return;
            container.innerHTML = '';
            FACILITIES.forEach(f => {
                const btn = document.createElement('div');
                btn.className = 'facility-btn';
                btn.dataset.id = f.id;
                if(selectedIds.includes(f.id)) btn.classList.add('active');
                btn.innerHTML = `<div class="facility-check"></div><span>${f.label}</span>`;
                btn.onclick = () => {
                    btn.classList.toggle('active');
                    if(isEditingMode && activeSelectionId) {
                        const item = storage.pins.find(p=>p.id===activeSelectionId) || storage.walks.find(w=>w.id===activeSelectionId);
                        if(item) {
                            if(!item.facilities) item.facilities = [];
                            if(btn.classList.contains('active')) {
                                if(!item.facilities.includes(f.id)) item.facilities.push(f.id);
                            } else {
                                item.facilities = item.facilities.filter(id => id !== f.id);
                            }
                            saveData();
                            saveToCloud(item.path ? 'walks' : 'pins', item);
                        }
                    }
                };
                container.appendChild(btn);
            });
        }

        function getSelectedFacilities(containerId) {
            const container = document.getElementById(containerId);
            if(!container) return [];
            const selected = [];
            container.querySelectorAll('.facility-btn.active').forEach(btn => selected.push(btn.dataset.id));
            return selected;
        }

        document.getElementById('undoAddBtn').onclick = () => {
            if (walkHistory.length > 0) {
                tempPath = walkHistory.pop();
                tempPoly.setLatLngs(tempPath);
                createNodes(tempPoly);
                updateWalkStats();
                fetchElevation(tempPath, false);
            }
        };

        function resetModal() { document.getElementById('itemName').value = ''; document.getElementById('itemDesc').value = ''; setupTypePickers(); tempCreationPhotos = []; document.getElementById('modalPhotoList').innerHTML = ''; renderFacilityPicker('modalFacilityPicker'); }

        document.getElementById('confirmSaveBtn').onclick = async () => {
            if (!currentUser) return;
            const id = Date.now();
            const name = document.getElementById('itemName').value || "Untitled";
            const desc = document.getElementById('itemDesc').value || "";
            const facilities = getSelectedFacilities('modalFacilityPicker');
            const activityMode = document.querySelector('#addModeSelector .mode-btn.active').dataset.mode;
            const isPublic = document.getElementById('publicToggle').checked;
            const isVisited = document.getElementById('visitedToggle').checked;
            
            // Handle Visited State
            const visitedState = isVisited;
            const visitedDate = isVisited ? Date.now() : null;
            
            if (isVisited) {
                if (!currentUser.visitedData) currentUser.visitedData = {};
                if (!currentUser.visitedItems) currentUser.visitedItems = [];
                currentUser.visitedData[id.toString()] = visitedDate;
                currentUser.visitedItems.push(id);
                // Update user profile immediately
                db.collection('users').doc(currentUser.uid).set({ 
                    visitedItems: currentUser.visitedItems, 
                    visitedData: currentUser.visitedData 
                }, { merge: true });
            }
            
            let flat, flon, entry;

            if (tempPath.length < 2) { 
                flat = pendingCoords.lat; 
                flon = pendingCoords.lng; 
                entry = { id, name, desc, rating: 0, lat: flat, lng: flon, color: selectedColor, type: 'PIN', userId: currentUser.uid, creatorName: currentUser.displayName || "User", isPublic: isPublic, photos: [...tempCreationPhotos], facilities: facilities, visited: visitedState, visitedDate: visitedDate };
                storage.pins.push(entry); 
                addPin(entry);
                await saveToCloud('pins', entry);
            } else { 
                let d = 0; 
                for(let i=1; i<tempPath.length; i++) {
                    d += L.latLng(tempPath[i-1][0], tempPath[i-1][1]).distanceTo(L.latLng(tempPath[i][0], tempPath[i][1]));
                }
                flat = tempPath[0][0]; 
                flon = tempPath[0][1]; 
                
                const activeColor = ACTIVITY_COLORS[activityMode] || ACTIVITY_COLORS.walk;

                entry = { 
                    id, name, desc, rating: 0, 
                    path: JSON.parse(JSON.stringify(tempPath)), dist: (d/1000).toFixed(2), 
                    lat: flat, lng: flon, color: activeColor, 
                    activity: activityMode, elevData: JSON.parse(JSON.stringify(liveElevData)), 
                    recordedTime: finalRecordedTime,
                    type: 'WALK',
                    userId: currentUser.uid,
                    isPublic: isPublic,
                    creatorName: currentUser.displayName || "User",
                    photos: [...tempCreationPhotos],
                    facilities: facilities,
                    visited: visitedState,
                    visitedDate: visitedDate
                }; 
                storage.walks.push(entry); 
                addWalk(entry); 
                await saveToCloud('walks', entry);
            }
            
            saveData(); 
            document.getElementById('modal-overlay').style.display = 'none'; 
            goBack(); 
            fetchPhoto(flat, flon, id);
            tempCreationPhotos = [];
            
            tempPath = [];
            tempPoly.setLatLngs([]);
            liveElevData = [];
            finalRecordedTime = 0;
        };

        async function fetchPhoto(lat, lon, id) {
            try {
                const res = await fetch(`https://en.wikipedia.org/w/api.php?action=query&list=geosearch&gsradius=500&gscoord=${lat}|${lon}&format=json&origin=*`).then(r=>r.json());
                if(res.query?.geosearch?.length) {
                    const title = res.query.geosearch[0].title;
                    const imgRes = await fetch(`https://en.wikipedia.org/w/api.php?action=query&prop=pageimages&format=json&piprop=original&titles=${encodeURIComponent(title)}&pithumbsize=500&origin=*`).then(r=>r.json());
                    const pg = Object.values(imgRes.query.pages)[0];
                    if(pg.original) { 
                        let entry = storage.pins.find(x=>x.id===id) || storage.walks.find(x=>x.id===id); 
                        if(entry && !entry.photo) { 
                            entry.photo = pg.original.source; 
                            saveData(); 
                            saveToCloud(entry.path ? 'walks' : 'pins', entry);
                            updateHighlights(); 
                        } 
                    }
                }
            } catch(e){}
        }

        function addPin(p) { 
            const pinIcon = L.divIcon({ className: 'custom-pin-marker', html: `<div class="pin-wrapper"><div class="pin-shape" style="background:${p.color || '#2563eb'}"></div></div>`, iconSize: [40, 40], iconAnchor: [20, 40] }); 
            L.marker([p.lat, p.lng], {icon: pinIcon, zIndexOffset: 1000}).addTo(mapItems).on('click', (e) => { 
                L.DomEvent.stopPropagation(e);
                map.flyTo([p.lat, p.lng], 18, { duration: 0.8 });
                showDetails(p, false, e.target); 
            }); 
        }
        function addWalk(w) { 
            const poly = L.polyline(w.path, {color: w.color || '#2563eb', weight:5, zIndex: 500}).addTo(mapItems); 
            poly.on('mouseover', () => poly.setStyle({weight: 8}));
            poly.on('mouseout', () => poly.setStyle({weight: 5}));
            poly.on('click', (e) => { 
                L.DomEvent.stopPropagation(e); 
                const isMobile = document.body.classList.contains('mobile-mode');
                const sidebarW = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidebar')) || 400;
                const leftPad = isMobile ? 20 : (sidebarW + 30);
                const bottomPad = isMobile ? (window.innerHeight / 2) : 40;
                map.flyToBounds(e.target.getBounds(), { paddingTopLeft: [leftPad, 20], paddingBottomRight: [20, bottomPad], duration: 0.8 });
                showDetails(w, true, e.target); 
            }); 
        }
        function refreshMapItems() { 
            updateHighlights(); 
            updateMyLogList();
        }

        function showDetails(item, isWalk, layer) {
            if (!item) return;
            // Ensure we work with the original storage object, not a filtered copy
            const realItem = storage.pins.find(p => p.id === item.id) || storage.walks.find(w => w.id === item.id);
            if (realItem) item = realItem;

            if (elevationAbortController) { elevationAbortController.abort(); elevationAbortController = null; }
            activeSelectionId = item.id; isEditing = false; graphOpen = false; selectedColor = item.color || PIN_TYPES[0].color;
            
            // Fetch latest data (comments, rating) from cloud
            const collectionName = item.path ? 'walks' : 'pins';
            db.collection(collectionName).doc(item.id.toString()).get().then(doc => {
                if(doc.exists && activeSelectionId === item.id) {
                    const data = doc.data();
                    item.comments = data.comments || [];
                    item.rating = data.rating || 0;
                    if(data.photos) item.photos = data.photos;
                    saveData();
                    renderComments(item);
                    updateDetailRating(item);
                    updateHighlights();
                }
            }).catch(e => console.log("Background fetch failed", e));

            editingCommentId = null;
            document.getElementById('editTypeContainer').style.display = 'none'; document.getElementById('explore-panel').style.display = 'none'; document.getElementById('add-panel').style.display = 'none'; document.getElementById('settings-panel').style.display = 'none'; document.getElementById('mainTabs').style.display = 'none'; document.getElementById('mainSearch').style.display = 'none'; 
            document.getElementById('backBtn').style.display = 'flex'; document.getElementById('minimizeBtn').style.display = 'none';
            document.getElementById('detail-view').style.display = 'flex';
            document.getElementById('editWalkOptions').style.display = 'none';
            
            // Only allow edit/delete if owner
            const isOwner = currentUser && item.userId === currentUser.uid;
            document.getElementById('floatEditBtn').style.display = 'none';
            
            if(isWalk) { document.querySelectorAll('#editModeSelector .mode-btn').forEach(btn => { btn.classList.toggle('active', btn.dataset.mode === (item.activity || 'walk')); }); }
            if(document.body.classList.contains('mobile-mode')) snapTo('half');
            const floatEdit = document.getElementById('floatEditBtn'); floatEdit.innerHTML = 'üñãÔ∏è'; floatEdit.classList.remove('is-editing');
            document.getElementById('floatDeleteBtn').style.display = 'none'; document.getElementById('editAddPhotoBtn').style.display = 'none';
            
            // Slideshow Logic
            if(slideshowInterval) { clearInterval(slideshowInterval); slideshowInterval = null; }
            const imgEl = document.getElementById('detPhoto');
            const imgBackEl = document.getElementById('detPhotoBack');
            
            const miniMapEl = document.getElementById('detMiniMap');
            miniMapEl.classList.remove('active');
            imgEl.classList.add('active');
            
            let photos = [];
            if(item.photos && item.photos.length > 0) photos = [...item.photos];
            else if(item.photo) photos = [item.photo];

            const showMapPreview = isWalk && item.path && item.path.length > 0;
            const slideCount = photos.length + (showMapPreview ? 1 : 0);

            if(slideCount > 0) {
                currentPhotoIndex = 0;
                
                const updateSlide = () => {
                    const isMapSlide = showMapPreview && currentPhotoIndex === 0;
                    
                    if (isMapSlide) {
                        imgEl.classList.remove('active');
                        miniMapEl.classList.add('active');
                        
                        if (!miniMap) {
                            miniMap = L.map('detMiniMap', { zoomControl: false, attributionControl: false, dragging: false, touchZoom: false, scrollWheelZoom: false, doubleClickZoom: false, boxZoom: false, keyboard: false });
                        }
                        if (miniMapLayer) miniMap.removeLayer(miniMapLayer);
                        miniMapLayer = L.tileLayer(mapStyles.sat).addTo(miniMap);
                        
                        if (miniMapPoly) miniMap.removeLayer(miniMapPoly);
                        miniMapPoly = L.polyline(item.path, { color: item.color || '#2563eb', weight: 4 }).addTo(miniMap);
                        
                        miniMap.invalidateSize();
                        miniMap.fitBounds(miniMapPoly.getBounds(), { paddingTopLeft: [20, 20], paddingBottomRight: [20, 80] });
                    } else {
                        miniMapEl.classList.remove('active');
                        
                        const pIndex = showMapPreview ? currentPhotoIndex - 1 : currentPhotoIndex;
                        if (photos[pIndex]) {
                            if (!imgEl.src || imgEl.style.opacity === '0' || miniMapEl.classList.contains('active')) {
                                imgEl.src = photos[pIndex];
                                imgBackEl.src = photos[pIndex];
                                imgEl.classList.add('active');
                            } else {
                                imgBackEl.src = imgEl.src;
                                imgEl.style.transition = 'none';
                                imgEl.classList.remove('active');
                                imgEl.src = photos[pIndex];
                                void imgEl.offsetWidth; 
                                imgEl.style.transition = 'opacity 1s ease-in-out';
                                imgEl.classList.add('active');
                            }
                            imgEl.onclick = () => openLightbox(pIndex, photos);
                        }
                    }
                };

                updateSlide();

                if(slideCount > 1) {
                    slideshowInterval = setInterval(() => {
                        currentPhotoIndex = (currentPhotoIndex + 1) % slideCount;
                        updateSlide();
                    }, 5000);
                }
            } else { 
                imgEl.src = "https://placehold.co/500x300?text=No+Photo"; 
                imgBackEl.src = "https://placehold.co/500x300?text=No+Photo";
                imgEl.onclick = null; 
            }

            const titleEl = document.getElementById('editTitle');
            titleEl.value = item.name; 
            titleEl.style.height = 'auto';
            titleEl.style.height = titleEl.scrollHeight + 'px';
            
            document.getElementById('editDesc').value = item.desc || "";
            
            // Description View Logic
            const descText = item.desc || "No notes added...";
            const viewContainer = document.getElementById('viewDescContainer');
            const viewText = document.getElementById('viewDescText');
            const showMoreBtn = document.getElementById('viewDescShowMoreBtn');
            
            viewText.innerText = descText;
            viewText.classList.remove('desc-truncated');
            showMoreBtn.style.display = 'none';
            showMoreBtn.innerText = 'Show More';
            
            if (descText.length > 150 || (descText.match(/\n/g) || []).length > 3) {
                 viewText.classList.add('desc-truncated');
                 showMoreBtn.style.display = 'block';
                 showMoreBtn.onclick = () => { const isTrunc = viewText.classList.toggle('desc-truncated'); showMoreBtn.innerText = isTrunc ? 'Show More' : 'Show Less'; };
            }

            document.querySelectorAll('.edit-input').forEach(i=>i.classList.remove('active'));
            document.getElementById('editDesc').style.display = 'none';
            document.getElementById('viewDescContainer').style.display = 'block';
            
            const creatorDiv = document.getElementById('detCreator');
            let creatorName = item.creatorName || 'Unknown';
            let creatorColor = 'linear-gradient(135deg, #64748b, #94a3b8)';
            let creatorAvatar = 'üë§';

            if(currentUser && item.userId === currentUser.uid) {
                creatorName = currentUser.displayName;
                creatorColor = currentUser.color || creatorColor;
                creatorAvatar = currentUser.avatarText || creatorAvatar;
            }
            
            const dateStr = formatDate(item.id);
            
            const renderCreator = (name, color, avatar) => {
                return `<div style="display:flex; align-items:center; gap:10px; padding:5px 0;"><div class="comment-avatar" style="width:32px; height:32px; font-size:14px; background:${color}">${avatar}</div><div style="display:flex; flex-direction:column; justify-content:center;"><span style="font-weight:700; font-size:13px;">${name}</span><span style="font-size:11px; opacity:0.6;">Uploaded on ${dateStr}</span></div></div>`;
            };

            creatorDiv.innerHTML = renderCreator(creatorName, creatorColor, creatorAvatar);

            if(item.userId && (item.userId !== currentUser?.uid)) {
                const reqId = item.id;
                db.collection('users').doc(item.userId).get().then(doc => {
                    if(activeSelectionId !== reqId) return;
                    if(doc.exists) { const d = doc.data(); creatorDiv.innerHTML = renderCreator(d.displayName || 'Unknown', d.color || creatorColor, d.avatarText || creatorAvatar); }
                }).catch(()=>{});
            }

            renderTypeLabel(item);
            updateVisitedButton(item);

            const facilitiesDiv = document.getElementById('detFacilities');
            facilitiesDiv.innerHTML = '';
            if(item.facilities && item.facilities.length > 0) {
                item.facilities.forEach(fid => {
                    const f = FACILITIES.find(x => x.id === fid);
                    if(f) {
                        facilitiesDiv.innerHTML += `<div class="facility-tag">${f.icon} ${f.label}</div>`;
                    }
                });
                facilitiesDiv.style.display = 'flex';
            } else { facilitiesDiv.style.display = 'none'; }

            waypointMarkers.forEach(m => map.removeLayer(m)); waypointMarkers = [];
            renderComments(item);
            updateDetailRating(item);
            if (isWalk) { 
                window.currentActiveLayer = layer || mapItems.getLayers().find(l => l instanceof L.Polyline && JSON.stringify(l.getLatLngs()[0]) === JSON.stringify(L.latLng(item.path[0][0], item.path[0][1]))); 
                updateWalkStats(); 
                fetchElevation(item.path, false); 
                updateWalkWaypoints(); 
            }
            else { document.getElementById('detStats').innerHTML = ``; closeElevation(); window.currentActiveLayer = null; }
            nodeHandles.forEach(h=>map.removeLayer(h));
            resetSidebarScroll();
        }

        function updateVisitedButton(item) {
            const btn = document.getElementById('markVisitedBtn');
            if(!btn) return;
            
            const isWalk = (item.path !== undefined);
            const isVisited = item.visited === true;
            let label = isWalk ? (isVisited ? '‚úÖ Completed' : '‚≠ï Mark Completed') : (isVisited ? '‚úÖ Visited' : '‚≠ï Mark Visited');
            
            if (isVisited && item.visitedDate) {
                const dateStr = formatDate(item.visitedDate);
                label += ` (${dateStr})`;
            }
            
            btn.innerText = label;
            btn.style.background = isVisited ? 'var(--accent)' : 'var(--bg)';
            btn.style.color = isVisited ? 'white' : 'var(--text)';
        }

        function updateDetailRating(item) {
            const rDiv = document.getElementById('detRating');
            if(!rDiv) return;
            if (item.comments && item.comments.length > 0) {
                rDiv.style.display = 'flex';
                rDiv.innerHTML = `‚òÖ ${(item.rating || 0).toFixed(1)}`;
            } else {
                rDiv.style.display = 'none';
            }
        }

        function renderComments(item) {
            const container = document.getElementById('commentsSection');
            if(!container) return;
            
            let html = "";

            const count = item.comments ? item.comments.length : 0;
            
            html += `<div onclick="toggleReviewsList()" style="cursor:pointer; display:flex; justify-content:space-between; align-items:center; margin-top:5px; padding: 10px 0; border-bottom: 1px solid var(--border);">
                <h4 style="margin:0; font-size:14px;">Reviews (${count})</h4>
                <span id="reviewsChevron" style="font-size:10px; opacity:0.6; transition: 0.2s;">‚ñº</span>
            </div>`;

            if(currentUser) {
                html += `<button class="btn" onclick="openReviewModal()" style="margin-top:10px; margin-bottom:10px; background:var(--bg); border:1px solid var(--border); color:var(--text);">Write a Review</button>`;
            }

            html += `<div id="reviewsListContainer" style="display:block; margin-top:10px;">`;
            if(item.comments && item.comments.length > 0) {
                item.comments.sort((a,b) => {
                    if(currentUser && a.userId === currentUser.uid && b.userId !== currentUser.uid) return -1;
                    if(currentUser && b.userId === currentUser.uid && a.userId !== currentUser.uid) return 1;
                    return b.timestamp - a.timestamp;
                }).forEach(c => {
                    const date = formatDate(c.timestamp);
                    let actions = '';
                    if(currentUser && c.userId === currentUser.uid) {
                        actions = `<div class="comment-actions"><button class="comment-action-btn" onclick="editComment(${item.id}, ${c.id})">Edit</button><button class="comment-action-btn" onclick="deleteComment(${item.id}, ${c.id})" style="color:var(--danger); border-color:var(--danger);">Delete</button></div>`;
                    }

                    let photoHtml = '';
                    if(c.photos && c.photos.length > 0) {
                        photoHtml = `<div class="comment-photos">`;
                        c.photos.forEach((p, idx) => {
                             photoHtml += `<img src="${p}" class="comment-photo-thumb" onclick="openLightbox(${idx}, ${JSON.stringify(c.photos).replace(/"/g, '&quot;')}); event.stopPropagation();">`;
                        });
                        photoHtml += `</div>`;
                    }

                    const commName = (currentUser && c.userId === currentUser.uid) ? currentUser.displayName : (c.displayName || 'Anonymous');
                    let displayText = commName.substring(0, 2).toUpperCase();
                    if (currentUser && c.userId === currentUser.uid && currentUser.avatarText) displayText = currentUser.avatarText;
                    else if (c.avatarText) displayText = c.avatarText;
                    
                    const avatarBg = (currentUser && c.userId === currentUser.uid && currentUser.color) ? currentUser.color : (c.userColor || 'linear-gradient(135deg, var(--primary), var(--accent))');
                    const ratingDisplay = `<div style="position:absolute; top:16px; right:16px; font-size:13px; font-weight:800; color:#fbbf24; background:rgba(251, 191, 36, 0.15); padding:2px 8px; border-radius:6px;">${c.rating.toFixed(1)} ‚òÖ</div>`;
                    
                    html += `<div class="comment-item">${ratingDisplay}<div class="comment-header"><div class="comment-avatar" style="background:${avatarBg}">${displayText}</div><div class="comment-info"><span class="comment-user">${commName}</span><span class="comment-date">${date}</span></div></div><p class="comment-text" style="margin-top:5px;">${c.text}</p>${photoHtml}${actions}</div>`;
                });
            } else {
                html += `<p style="font-size:12px; opacity:0.6; font-style:italic;">No reviews yet.</p>`;
            }
            html += `</div>`;

            container.innerHTML = html;
        }

        function renderReviewThumbnails() {
            const container = document.getElementById('modalReviewPhotoPreview');
            if(!container) return;
            container.innerHTML = tempReviewPhotos.map(url => `<img src="${url}" style="width:40px; height:40px; object-fit:cover; border-radius:4px; border:1px solid var(--border);">`).join('');
        }

        function openReviewModal() {
            document.getElementById('review-modal-overlay').style.display = 'flex';
            const stars = document.querySelectorAll('#modalReviewStars span');
            
            // Setup star click listeners
            stars.forEach(s => {
                s.onclick = () => {
                    const val = parseInt(s.dataset.v);
                    window.currentCommentRating = val;
                    stars.forEach(st => st.classList.toggle('active', parseInt(st.dataset.v) <= val));
                };
            });

            if(editingCommentId) {
                document.getElementById('reviewModalTitle').innerText = 'Edit Review';
                document.getElementById('postReviewBtn').innerText = 'Update Review';
                const item = storage.pins.find(p=>p.id===activeSelectionId) || storage.walks.find(w=>w.id===activeSelectionId);
                const c = item.comments.find(x => x.id === editingCommentId);
                if(c) {
                    document.getElementById('modalReviewText').value = c.text;
                    window.currentCommentRating = c.rating;
                    stars.forEach(st => st.classList.toggle('active', parseInt(st.dataset.v) <= c.rating));
                    tempReviewPhotos = c.photos ? [...c.photos] : [];
                    renderReviewThumbnails();
                }
            } else {
                document.getElementById('reviewModalTitle').innerText = 'Rate & Review';
                document.getElementById('postReviewBtn').innerText = 'Post Review';
                document.getElementById('modalReviewText').value = '';
                window.currentCommentRating = 0;
                stars.forEach(st => st.classList.remove('active'));
                tempReviewPhotos = [];
                renderReviewThumbnails();
            }
        }

        function closeReviewModal() {
            document.getElementById('review-modal-overlay').style.display = 'none';
            if(editingCommentId) {
                editingCommentId = null;
                const item = storage.pins.find(p=>p.id===activeSelectionId) || storage.walks.find(w=>w.id===activeSelectionId);
                renderComments(item);
            }
        }

        function toggleReviewsList() {
            const list = document.getElementById('reviewsListContainer');
            const chev = document.getElementById('reviewsChevron');
            if(list && chev) {
                const isHidden = list.style.display === 'none';
                list.style.display = isHidden ? 'block' : 'none';
                chev.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(-90deg)';
            }
        }

        async function postComment() {
            if(!activeSelectionId || !currentUser) return;
            
            let currentDisplayName = currentUser.displayName;
            try {
                const uDoc = await db.collection('users').doc(currentUser.uid).get();
                if(uDoc.exists && uDoc.data().displayName) currentDisplayName = uDoc.data().displayName;
            } catch(e){}

            const text = document.getElementById('modalReviewText').value.trim();
            const rating = window.currentCommentRating || 0;
            if(rating === 0) { alert("Please select a star rating."); return; }

            const item = storage.pins.find(p=>p.id===activeSelectionId) || storage.walks.find(w=>w.id===activeSelectionId);
            if(!item) return;
            if(!item.comments) item.comments = [];
            
            if(editingCommentId) {
                const idx = item.comments.findIndex(c => c.id === editingCommentId);
                if(idx !== -1) {
                    item.comments[idx].text = text;
                    item.comments[idx].rating = rating;
                    item.comments[idx].timestamp = Date.now();
                    item.comments[idx].photos = [...tempReviewPhotos];
                }
                editingCommentId = null;
            } else {
                item.comments.push({ id: Date.now(), userId: currentUser.uid, displayName: currentDisplayName || "User", text: text, rating: rating, timestamp: Date.now(), photos: [...tempReviewPhotos], userColor: currentUser.color || null, avatarText: currentUser.avatarText || null });
            }
            
            const total = item.comments.reduce((acc, c) => acc + c.rating, 0);
            item.rating = parseFloat((total / item.comments.length).toFixed(1));

            saveData(); 
            closeReviewModal();
            renderComments(item); updateHighlights();
            updateDetailRating(item);
            tempReviewPhotos = [];
            updateMyLogList();
            await saveToCloud(item.path ? 'walks' : 'pins', item);
        }

        function editComment(itemId, commentId) {
            editingCommentId = commentId;
            openReviewModal();
        }

        function cancelEdit() {
            editingCommentId = null;
            closeReviewModal();
        }

        async function deleteComment(itemId, commentId) {
            if(!confirm("Delete this review?")) return;
            const item = storage.pins.find(p=>p.id===itemId) || storage.walks.find(w=>w.id===itemId);
            item.comments = item.comments.filter(c => c.id !== commentId);
            
            const total = item.comments.reduce((acc, c) => acc + c.rating, 0);
            item.rating = item.comments.length ? parseFloat((total / item.comments.length).toFixed(1)) : 0;

            saveData(); await saveToCloud(item.path ? 'walks' : 'pins', item);
            renderComments(item); updateHighlights();
            updateDetailRating(item);
            updateMyLogList();
        }

        function updateWalkWaypoints() { 
            waypointMarkers.forEach(m => map.removeLayer(m)); 
            waypointMarkers = []; 
            const item = storage.walks.find(w => w.id === activeSelectionId); 
            if(item && item.path.length > 0) { 
                const startPt = item.path[0]; 
                const endPt = item.path[item.path.length-1]; 
                waypointMarkers.push(L.marker(startPt, { icon: L.divIcon({ className: 'walk-marker-icon start-icon', html: '<div class="rotate-wrapper">‚ñ∂</div>', iconSize: [24, 24], iconAnchor: [12, 12] }), zIndexOffset: 2000 }).addTo(map)); 
                waypointMarkers.push(L.marker(endPt, { icon: L.divIcon({ className: 'walk-marker-icon end-icon', html: '<div class="rotate-wrapper">üèÅ</div>', iconSize: [24, 24], iconAnchor: [12, 12] }), zIndexOffset: 2000 }).addTo(map)); 
            } 
        }
        
        function toggleGraph() { 
            graphOpen = !graphOpen; 
            const btn = document.getElementById('toggleGraphBtn') || document.querySelector('.hud-btn.elev-toggle') || document.getElementById('drawGraphBtn'); 
            if(btn) btn.innerHTML = graphOpen ? 'üìâ Hide Height Graph' : 'üìà Show Height Graph'; 
            if (graphOpen) { 
                if(document.body.classList.contains('mobile-mode') && !isRecording) snapTo('bottom');
                if(isRecording) renderLiveRecordingGraph();
                else if (currentMode === 'walk' && tempPath.length > 0) {
                    fetchElevation(tempPath, true);
                } else {
                    const item = storage.walks.find(w => w.id === activeSelectionId); 
                    if (item) renderInstantGraph(item);
                }
            } else { closeElevation(); } 
        }

        function renderInstantGraph(item) {
            if(!item.elevData || item.elevData.length === 0) {
                fetchElevation(item.path, true);
                return;
            }
            document.getElementById('elevation-dock').classList.add('active');
            let currentTotal = 0, distData = [0]; 
            for(let j = 1; j < item.path.length; j++){ 
                currentTotal += L.latLng(item.path[j-1][0], item.path[j-1][1]).distanceTo(L.latLng(item.path[j][0], item.path[j][1])); 
                distData.push(currentTotal / 1000); 
            }
            const ctx = document.getElementById('elevChart').getContext('2d'); 
            if(chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, { 
                type:'line', 
                data:{ 
                    labels: distData.map(d => d.toFixed(1)), 
                    datasets:[{ data:item.elevData, borderColor:'#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.15)', fill:true, pointRadius:0, borderWidth: 2, tension:0.4, cubicInterpolationMode: 'monotone' }] 
                }, 
                options:{ 
                    maintainAspectRatio:false, 
                    plugins:{ legend:{display:false} }, 
                    scales:{ x:{ title:{display:true, text:'km'} }, y:{ title:{display:true, text:'m'}, position:'right' } } 
                },
                plugins: [{
                    id: 'flyoverProgress',
                    afterDraw: (chart) => {
                        if (typeof window.flyoverDistance !== 'number' || window.flyoverDistance === null) return;
                        const ctx = chart.ctx;
                        const xAxis = chart.scales.x;
                        const yAxis = chart.scales.y;
                        const totalDist = parseFloat(chart.data.labels[chart.data.labels.length-1]);
                        const pct = Math.min(1, Math.max(0, window.flyoverDistance / totalDist));
                        const x = xAxis.left + (xAxis.width * pct);
                        const dataIndex = Math.floor(pct * (chart.data.datasets[0].data.length - 1));
                        const y = yAxis.getPixelForValue(chart.data.datasets[0].data[dataIndex]);
                        ctx.save(); ctx.beginPath(); ctx.moveTo(x, yAxis.top); ctx.lineTo(x, yAxis.bottom); ctx.lineWidth = 1; ctx.strokeStyle = '#ef4444'; ctx.stroke(); ctx.beginPath(); ctx.arc(x, y, 5, 0, 2 * Math.PI); ctx.fillStyle = '#ef4444'; ctx.fill(); ctx.restore();
                    }
                }]
            });
        }

        function updateWalkStats() {
            const item = storage.walks.find(w => w.id === activeSelectionId);
            
            if (!item && currentMode === 'walk') {
                let d = 0;
                const lls = tempPoly.getLatLngs();
                for(let j=1; j<lls.length; j++) d += lls[j-1].distanceTo(lls[j]);
                const distKm = d/1000;
                document.getElementById('liveDist').innerText = formatDist(distKm);
                
                const activityMode = document.querySelector('#addModeSelector .mode-btn.active').dataset.mode;
                const speed = storage.speeds[activityMode] || 5;
                const totalMins = Math.round((distKm / speed) * 60);
                const hours = Math.floor(totalMins / 60);
                const mins = totalMins % 60;
                const timeEl = document.getElementById('liveTime');
                if(timeEl) timeEl.innerText = (hours > 0 ? hours + 'h ' : '') + mins + 'm';
                tempPath = lls.map(l => [l.lat, l.lng]);
                return;
            }

            const layer = window.currentActiveLayer; if(!item) return;
            let d = 0; if (layer) { const lls = layer.getLatLngs(); for(let j=1; j<lls.length; j++) d += lls[j-1].distanceTo(lls[j]); item.dist = (d/1000).toFixed(2); item.path = lls.map(l => [l.lat, l.lng]); } else d = parseFloat(item.dist) * 1000;
            let ascent = 0, descent = 0, minE = 0, maxE = 0;
            if(item.elevData && item.elevData.length > 0) {
                minE = Math.round(Math.min(...item.elevData)); maxE = Math.round(Math.max(...item.elevData));
                for(let i=1; i<item.elevData.length; i++) { let diff = item.elevData[i] - item.elevData[i-1]; if(diff > 0) ascent += diff; else descent += Math.abs(diff); }
            }
            
            let totalMins = 0;
            let timeLabel = "Estimated Time";
            if (item.recordedTime && item.recordedTime > 0) {
                totalMins = item.recordedTime;
                timeLabel = "Actual Time";
            } else {
                let speed = storage.speeds[item.activity || 'walk'] || 5;
                totalMins = Math.round((parseFloat(item.dist) / speed) * 60);
            }

            let hours = Math.floor(totalMins / 60), mins = totalMins % 60;            
            document.getElementById('detStats').innerHTML = `<div class="stats-grid"><div class="stat-card"><span class="stat-label">Length</span><span class="stat-value">${formatDist(item.dist)}</span></div><div class="stat-card"><span class="stat-label">${timeLabel}</span><span class="stat-value">${hours > 0 ? hours + 'h ' : ''}${mins}m</span></div><div class="stat-card-dual"><div class="dual-row"><span class="stat-sub-label">Total Climb</span><span class="stat-sub-value">${formatElev(ascent)}</span></div><div class="dual-divider"></div><div class="dual-row"><span class="stat-sub-label">Total Descent</span><span class="stat-sub-value">${formatElev(descent)}</span></div></div><div class="stat-card-dual"><div class="dual-row"><span class="stat-sub-label">Min Height</span><span class="stat-sub-value">${formatElev(minE)}</span></div><div class="dual-divider"></div><div class="dual-row"><span class="stat-sub-label">Max Height</span><span class="stat-sub-value">${formatElev(maxE)}</span></div></div><button class="elev-toggle-btn" onclick="startFlyover()" style="margin-bottom:5px;">‚úàÔ∏è Flyover</button><button id="toggleGraphBtn" class="elev-toggle-btn" onclick="toggleGraph()"><span>${graphOpen ? 'üìâ' : 'üìà'}</span> ${graphOpen ? 'Hide Height Graph' : 'Show Height Graph'}</button></div>`;
            updateWalkWaypoints(); saveData();
            saveToCloud('walks', item);
            updateMyLogList();
        }

        function toggleEditingLogic() {
            const item = storage.pins.find(p=>p.id===activeSelectionId) || storage.walks.find(w=>w.id===activeSelectionId);
            if (!item) return;

            if (!currentUser || item.userId !== currentUser.uid) {
                alert("You can only edit your own items.");
                return;
            }

            isEditing = !isEditing; const editBtn = document.getElementById('floatEditBtn'); editBtn.innerHTML = isEditing ? '‚úÖ' : 'üñãÔ∏è'; editBtn.classList.toggle('is-editing', isEditing);
            
            const bigBtn = document.getElementById('bigEditBtn');
            const bigDelBtn = document.getElementById('bigDeleteBtn');
            if(bigBtn) {
                bigBtn.innerHTML = isEditing ? '‚úÖ Finish Editing' : 'üñãÔ∏è Edit Entry';
                bigBtn.style.background = isEditing ? 'var(--accent)' : 'var(--primary)';
            }
            
            if(bigDelBtn) {
                bigDelBtn.style.display = isEditing ? 'flex' : 'none';
            }

            document.getElementById('floatDeleteBtn').style.display = 'none'; 
            document.getElementById('editAddPhotoBtn').style.display = isEditing ? 'block' : 'none'; 
            
            const isWalk = (item.path !== undefined);
            document.getElementById('editTypeContainer').style.display = (isEditing && !isWalk) ? 'block' : 'none';
            document.getElementById('editWalkOptions').style.display = (isEditing && isWalk) ? 'block' : 'none';
            document.getElementById('editPrivacyContainer').style.display = isEditing ? 'block' : 'none';
            
            if(!isEditing) {
                const facilitiesDiv = document.getElementById('detFacilities');
                facilitiesDiv.innerHTML = '';
                if(item.facilities && item.facilities.length > 0) {
                    item.facilities.forEach(fid => {
                        const f = FACILITIES.find(x => x.id === fid);
                        if(f) facilitiesDiv.innerHTML += `<div class="facility-tag">${f.icon} ${f.label}</div>`;
                    });
                }
                
                // Update Description View
                const descText = item.desc || "No notes added...";
                const viewText = document.getElementById('viewDescText');
                const showMoreBtn = document.getElementById('viewDescShowMoreBtn');
                
                viewText.innerText = descText;
                viewText.classList.remove('desc-truncated');
                showMoreBtn.style.display = 'none';
                showMoreBtn.innerText = 'Show More';
                
                if (descText.length > 150 || (descText.match(/\n/g) || []).length > 3) {
                     viewText.classList.add('desc-truncated');
                     showMoreBtn.style.display = 'block';
                     showMoreBtn.onclick = () => { const isTrunc = viewText.classList.toggle('desc-truncated'); showMoreBtn.innerText = isTrunc ? 'Show More' : 'Show Less'; };
                }

                saveData();
                saveToCloud(item.path ? 'walks' : 'pins', item);
                updateHighlights();
                updateMyLogList();
                renderTypeLabel(item);
            }

            document.getElementById('detFacilities').style.display = (isEditing || (!item.facilities || item.facilities.length === 0)) ? 'none' : 'flex';
            document.getElementById('editFacilitiesContainer').style.display = isEditing ? 'block' : 'none';
            if(isEditing) renderFacilityPicker('editFacilityPicker', item.facilities || [], true);
            
            if(isEditing) { setupTypePickers(); walkHistory = []; }
            
            document.querySelectorAll('.edit-input').forEach(inp => inp.classList.toggle('active', isEditing));
            document.getElementById('editDesc').style.display = isEditing ? 'block' : 'none';
            document.getElementById('viewDescContainer').style.display = isEditing ? 'none' : 'block';
            
            if(isEditing && window.currentActiveLayer instanceof L.Polyline) { createNodes(window.currentActiveLayer); } 
            else { nodeHandles.forEach(h=>map.removeLayer(h)); nodeHandles = []; }
            document.getElementById('editTitle').oninput = function() { 
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
                item.name = this.value; 
                saveData(); 
                updateHighlights(); 
                updateMyLogList(); 
                saveToCloud(item.path ? 'walks' : 'pins', item); 
            };
            document.getElementById('editDesc').oninput = () => { item.desc = document.getElementById('editDesc').value; saveData(); updateMyLogList(); saveToCloud(item.path ? 'walks' : 'pins', item); };
            
            if(isEditing) {
                const pubToggle = document.getElementById('editPublicToggle');
                pubToggle.checked = item.isPublic || false;
                pubToggle.onchange = (e) => {
                    item.isPublic = e.target.checked;
                    saveData();
                    saveToCloud(item.path ? 'walks' : 'pins', item);
                    updateHighlights();
                    updateMyLogList();
                };
            }
        }

        function openUrlUploadPopup(context) {
            uploadContext = context;
            document.getElementById('upload-popup').style.display = 'flex';
            document.getElementById('imgUrlInput').value = '';
            document.getElementById('uploadPreview').src = '';
            document.getElementById('uploadPreview').style.display = 'none';
            document.getElementById('uploadPreviewContainer').style.display = 'none';
            document.getElementById('uploadStatus').innerText = 'Enter a URL to preview';
            document.getElementById('uploadStatus').style.color = 'var(--text)';
            document.getElementById('uploadProgressContainer').style.display = 'none';
            document.getElementById('btnConfirmUpload').style.display = 'block';
            document.getElementById('btnConfirmUpload').disabled = true;
            document.getElementById('btnConfirmUpload').style.opacity = '0.5';
        }

        const imgUrlInput = document.getElementById('imgUrlInput');
        const previewImg = document.getElementById('uploadPreview');
        if(imgUrlInput && previewImg) {
            imgUrlInput.oninput = (e) => {
                const url = e.target.value.trim();
                if(url) {
                    document.getElementById('uploadPreviewContainer').style.display = 'flex';
                    previewImg.src = url;
                    document.getElementById('uploadStatus').innerText = 'Previewing...';
                    document.getElementById('uploadStatus').style.color = 'var(--text)';
                } else {
                    document.getElementById('uploadPreviewContainer').style.display = 'none';
                    document.getElementById('uploadStatus').innerText = 'Enter a URL to preview';
                }
            };
            
            previewImg.onload = () => { previewImg.style.display = 'block'; document.getElementById('btnConfirmUpload').disabled = false; document.getElementById('btnConfirmUpload').style.opacity = '1'; document.getElementById('uploadStatus').innerText = 'Image loaded'; document.getElementById('uploadStatus').style.color = 'var(--accent)'; };
            previewImg.onerror = () => { previewImg.style.display = 'none'; document.getElementById('btnConfirmUpload').disabled = true; document.getElementById('btnConfirmUpload').style.opacity = '0.5'; document.getElementById('uploadStatus').innerText = 'Invalid Image URL'; document.getElementById('uploadStatus').style.color = 'var(--danger)'; };
        }

        function cancelUpload() {
            document.getElementById('upload-popup').style.display = 'none';
            document.getElementById('imgUrlInput').value = '';
        }

        async function performUrlAdd() {
            const url = document.getElementById('imgUrlInput').value.trim();
            if (!url) return;

            if (uploadContext === 'create') {
                tempCreationPhotos.push(url);
                document.getElementById('modalPhotoList').innerHTML += `<img src="${url}" style="width:40px; height:40px; object-fit:cover; border-radius:4px; border:1px solid var(--border);">`;
                cancelUpload();
                return;
            }

            if (uploadContext === 'review') {
                tempReviewPhotos.push(url);
                renderReviewThumbnails();
                cancelUpload();
                return;
            }
            
            if (!activeSelectionId) return;
            
            const item = storage.pins.find(p=>p.id===activeSelectionId) || storage.walks.find(w=>w.id===activeSelectionId);
            if(!item) return;

            if(!item.photos) item.photos = [];
            if(item.photo) { item.photos.push(item.photo); delete item.photo; }
            item.photos.push(url);
            
            saveData(); 
            await saveToCloud(item.path ? 'walks' : 'pins', item);
            showDetails(item, item.path !== undefined, null);
            updateMyLogList();
            cancelUpload();
        }

        function getHighResUrl(url) {
            if (!url) return '';
            // Handle Wikipedia/Wikimedia thumbnails to get original
            if ((url.includes('wikipedia.org') || url.includes('wikimedia.org')) && url.includes('/thumb/')) {
                try {
                    const parts = url.split('/thumb/');
                    if (parts.length === 2) {
                        const suffix = parts[1];
                        const pathParts = suffix.split('/');
                        if (pathParts.length >= 2) {
                            pathParts.pop(); // Remove the last segment (the thumbnail filename)
                            return parts[0] + '/' + pathParts.join('/');
                        }
                    }
                } catch(e) { return url; }
            }
            return url;
        }

        function openLightbox(index, photos) { activeLightboxPhotos = photos; currentLightboxIndex = index; updateLightboxImage(); document.getElementById('lightbox-overlay').style.display = 'flex'; }
        function closeLightbox() { document.getElementById('lightbox-overlay').style.display = 'none'; }
        function changeLightboxImage(dir) { if (!activeLightboxPhotos.length) return; currentLightboxIndex = (currentLightboxIndex + dir + activeLightboxPhotos.length) % activeLightboxPhotos.length; updateLightboxImage(); }
        function updateLightboxImage() { 
            const img = document.getElementById('lightbox-img'); 
            if (activeLightboxPhotos[currentLightboxIndex]) {
                // Force high resolution URL immediately to prevent blurry upscaling
                img.src = getHighResUrl(activeLightboxPhotos[currentLightboxIndex]);
            }
        }

        floatEditBtn.onclick = toggleEditingLogic;

        function getBearing(startLat, startLng, destLat, destLng) {
            const startLatRad = startLat * (Math.PI / 180);
            const startLngRad = startLng * (Math.PI / 180);
            const destLatRad = destLat * (Math.PI / 180);
            const destLngRad = destLng * (Math.PI / 180);

            const y = Math.sin(destLngRad - startLngRad) * Math.cos(destLatRad);
            const x = Math.cos(startLatRad) * Math.sin(destLatRad) -
                        Math.sin(startLatRad) * Math.cos(destLatRad) * Math.cos(destLngRad - startLngRad);
            const brng = Math.atan2(y, x);
            return (brng * 180 / Math.PI + 360) % 360;
        }

        function getRouteThumbnail(path, color) {
            if (!path || path.length < 2) return '<div class="highlight-thumb" style="background:#eee; display:flex; align-items:center; justify-content:center;">üó∫Ô∏è</div>';
            
            let minLat = Infinity, maxLat = -Infinity, minLng = Infinity, maxLng = -Infinity;
            path.forEach(p => {
                const lat = p[0], lng = p[1];
                if(lat < minLat) minLat = lat;
                if(lat > maxLat) maxLat = lat;
                if(lng < minLng) minLng = lng;
                if(lng > maxLng) maxLng = lng;
            });

            const centerLat = (minLat + maxLat) / 2;
            const centerLng = (minLng + maxLng) / 2;
            const zoom = 12;
            const x = Math.floor((centerLng + 180) / 360 * Math.pow(2, zoom));
            const y = Math.floor((1 - Math.log(Math.tan(centerLat * Math.PI / 180) + 1 / Math.cos(centerLat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom));
            const tileUrl = `https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/${zoom}/${y}/${x}`;

            const w = 70, h = 70, pad = 10;
            const availW = w - 2*pad, availH = h - 2*pad;
            const latRange = maxLat - minLat || 0.0001;
            const lngRange = maxLng - minLng || 0.0001;
            
            const scaleX = availW / lngRange;
            const scaleY = availH / latRange;
            const scale = Math.min(scaleX, scaleY);
            
            const contentW = lngRange * scale;
            const contentH = latRange * scale;
            const offX = pad + (availW - contentW) / 2;
            const offY = pad + (availH - contentH) / 2;

            let d = "";
            path.forEach((p, i) => {
                const x = offX + (p[1] - minLng) * scale;
                const y = offY + (maxLat - p[0]) * scale; 
                d += (i === 0 ? "M" : "L") + `${x.toFixed(1)},${y.toFixed(1)}`;
            });

            return `<div class="highlight-thumb" style="background-image:url('${tileUrl}'); background-size:cover; background-position:center; display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative;">
                <div style="position:absolute; inset:0; background:rgba(0,0,0,0.3);"></div>
                <svg width="70" height="70" viewBox="0 0 70 70" style="display:block; position:relative; z-index:1;">
                    <path d="${d}" stroke="${color}" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round" style="filter:drop-shadow(0 1px 2px rgba(0,0,0,0.5));"/>
                </svg>
            </div>`;
        }

        // Helper to get interpolated point at specific distance
        function getPointAtDistance(path, d, totalDist, cumDists) {
            if (d <= 0) return path[0];
            if (d >= totalDist) return path[path.length - 1];
            
            // Find segment
            for (let i = 0; i < cumDists.length; i++) {
                if (cumDists[i] >= d) {
                    const p1 = path[i];
                    const p2 = path[i+1];
                    const segmentStartDist = (i === 0) ? 0 : cumDists[i-1];
                    const segmentLen = cumDists[i] - segmentStartDist;
                    const ratio = (d - segmentStartDist) / segmentLen;
                    return [
                        p1[0] + (p2[0] - p1[0]) * ratio,
                        p1[1] + (p2[1] - p1[1]) * ratio
                    ];
                }
            }
            return path[path.length - 1];
        }

        async function startFlyover() {
            const item = storage.walks.find(w=>w.id===activeSelectionId);
            if(!item || !item.path) return;
            
            isFlying = true;
            document.getElementById('flyoverControls').style.display = 'flex';
            map.stop();
            document.getElementById('sidebar').classList.add('minimized');
            document.getElementById('expandBtn').style.display = 'flex';
            document.body.classList.add('is-flying');
            
            isFlyPaused = false;
            document.getElementById('flyPauseBtn').innerText = "‚è∏ PAUSE";
            document.getElementById('flyPauseBtn').style.background = "var(--border)";
            document.getElementById('flyPauseBtn').style.color = "var(--text)";
            
            const flySel = document.getElementById('flyMapSelect');
            if(flySel) flySel.value = storage.mapStyle;

            if(!graphOpen) toggleGraph();

            // Calculate speed for time estimation based on activity type
            let speedKmH = storage.speeds[item.activity || 'walk'] || 5;
            
            // Use actual average speed if it was a recorded activity
            if(item.recordedTime && item.recordedTime > 0 && parseFloat(item.dist) > 0) {
                flySpeedKmH = parseFloat(item.dist) / (item.recordedTime / 60);
            } else {
                flySpeedKmH = storage.speeds[item.activity || 'walk'] || 5;
            }

            // Pre-calculate distances for optimization
            flyPath = item.path;
            flyTotalDist = 0;
            flyCumDists = [];
            for(let i=0; i<flyPath.length-1; i++) {
                flyTotalDist += L.latLng(flyPath[i]).distanceTo(L.latLng(flyPath[i+1]));
                flyCumDists.push(flyTotalDist);
            }
            
            // Add Fly Marker
            if(flyMarker) map.removeLayer(flyMarker);
            flyMarker = L.marker(flyPath[0], {
                icon: L.divIcon({ className: '', html: '<div class="gps-indicator-wrapper" style="transform:scale(0.6);"><div class="gps-indicator"></div><div class="gps-pulse"></div></div>', iconSize: [10, 10], iconAnchor: [5, 5] }),
                zIndexOffset: 9999
            }).addTo(map);

            // Set initial values
            currentFlyZoom = 17.0;
            currentFlySpeed = 1.0;
            flyStartTime = Date.now();
            document.getElementById('flyZoomDisplay').innerText = currentFlyZoom.toFixed(1);
            document.getElementById('flySpeedDisplay').innerText = '1.0x';

            currentFlyDist = 0;
            flyLastTime = 0;
            flyCurrentBearing = getBearing(flyPath[0][0], flyPath[0][1], flyPath[1][0], flyPath[1][1]);
            
            // Base speed: 50 meters per second (180 km/h) as base 1x
            const baseSpeedMPS = 50; 

            function animate(time) {
                if (!isFlying) return;
                if (!flyLastTime) flyLastTime = time;
                const dt = time - flyLastTime;
                flyLastTime = time;

                if (!isFlyPaused) {
                    const moveDist = baseSpeedMPS * currentFlySpeed * (dt / 1000);
                    currentFlyDist += moveDist;
                }
                
                updateFlyoverFrame();

                if (currentFlyDist >= flyTotalDist) {
                    stopFlyover();
                    return;
                }
                
                flyAnimationId = requestAnimationFrame(animate);
            }
            
            flyAnimationId = requestAnimationFrame(animate);
        }
        
        function updateFlyoverFrame() {
                const item = storage.walks.find(w=>w.id===activeSelectionId);
                
                // Update Stats
                document.getElementById('flyStatDist').innerText = formatDist(currentFlyDist / 1000);
                
                // Estimated Time based on activity speed
                const distKm = currentFlyDist / 1000;
                const totalSeconds = (distKm / flySpeedKmH) * 3600;
                
                const hrs = Math.floor(totalSeconds / 3600);
                const mins = Math.floor((totalSeconds % 3600) / 60);
                const secs = Math.floor(totalSeconds % 60);
                
                const timeStr = (hrs > 0 ? `${hrs}:` : '') + `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                document.getElementById('flyStatTime').innerText = timeStr;

                // Elevation
                if (item.elevData && item.elevData.length > 0) {
                    const elevIndex = Math.min(item.elevData.length - 1, Math.floor((currentFlyDist / flyTotalDist) * item.elevData.length));
                    document.getElementById('flyStatElev').innerText = formatElev(item.elevData[elevIndex]);
                }

                window.flyoverDistance = currentFlyDist / 1000;
                if(chartInstance) chartInstance.draw();

                // Get current position
                const pos = getPointAtDistance(flyPath, currentFlyDist, flyTotalDist, flyCumDists);
                
                // Look ahead 40 meters for smooth bearing
                const lookAheadDist = 100; // Increased look-ahead for smoother turns
                const lookAheadPos = getPointAtDistance(flyPath, currentFlyDist + lookAheadDist, flyTotalDist, flyCumDists);

                const targetBearing = getBearing(pos[0], pos[1], lookAheadPos[0], lookAheadPos[1]);
                let diff = targetBearing - flyCurrentBearing;
                while (diff < -180) diff += 360;
                while (diff > 180) diff -= 360;
                flyCurrentBearing += diff * 0.02; // Very smooth turn rate

                const zoomLevel = currentFlyZoom;
                map.setView(pos, zoomLevel, { animate: false });
                
                // Scale 2.5 to ensure map covers screen during rotation
                document.getElementById('map').style.transform = `rotateZ(-${flyCurrentBearing}deg) scale(2.5)`;
                
                if(flyMarker) flyMarker.setLatLng(pos);
        }

        function stopFlyover() {
            isFlying = false;
            if(flyAnimationId) cancelAnimationFrame(flyAnimationId);
            document.getElementById('flyoverControls').style.display = 'none';
            document.getElementById('sidebar').classList.remove('minimized');
            document.body.classList.remove('is-flying');
            document.getElementById('map').style.transform = ''; // Reset transform
            if(flyMarker) { map.removeLayer(flyMarker); flyMarker = null; }
            window.flyoverDistance = null;
            if(chartInstance) chartInstance.draw();
            
            const item = storage.pins.find(p=>p.id===activeSelectionId) || storage.walks.find(w=>w.id===activeSelectionId);
            if(item) {
                if(item.path) {
                     const poly = L.polyline(item.path);
                     map.fitBounds(poly.getBounds(), {padding:[50,50]});
                } else {
                    map.flyTo([item.lat, item.lng], 15);
                }
            }
        }

        function createNodes(layer) {
            nodeHandles.forEach(h => map.removeLayer(h)); nodeHandles = []; const latlngs = layer.getLatLngs();
            latlngs.forEach((ll, i) => {
                let moved = false; const isStartOrEnd = (i === 0 || i === latlngs.length - 1);
                const handleClass = isStartOrEnd ? 'node-handle node-handle-hidden' : 'node-handle node-handle-visible';
                const m = L.marker(ll, { draggable: true, icon: L.divIcon({ className: handleClass, iconSize:[isStartOrEnd?30:16, isStartOrEnd?30:16], iconAnchor:[isStartOrEnd?15:8, isStartOrEnd?15:8] }), zIndexOffset: 10000 }).addTo(map);
                m.on('drag', (e) => { moved = true; const currentLls = layer.getLatLngs(); currentLls[i] = e.target.getLatLng(); layer.setLatLngs(currentLls); updateWalkStats(); });
                m.on('dragend', () => { createNodes(layer); fetchElevation(layer.getLatLngs().map(l => [l.lat, l.lng]), false); });
                m.on('click', (e) => { L.DomEvent.stopPropagation(e); if (!moved && layer.getLatLngs().length > 2) { const currentLls = layer.getLatLngs(); currentLls.splice(i, 1); layer.setLatLngs(currentLls); updateWalkStats(); createNodes(layer); fetchElevation(currentLls.map(l => [l.lat, l.lng]), false); } });
                nodeHandles.push(m);
                if (i < latlngs.length - 1) {
                    const midH = L.marker(L.latLng((ll.lat + latlngs[i+1].lat) / 2, (ll.lng + latlngs[i+1].lng) / 2), { draggable: true, icon: L.divIcon({ className:'mid-handle mid-handle-visible', iconSize:[12,12], iconAnchor:[6,6] }), zIndexOffset: 9000 }).addTo(map);
                    midH.on('dragstart', (e) => { const currentLls = layer.getLatLngs(); currentLls.splice(i + 1, 0, e.target.getLatLng()); layer.setLatLngs(currentLls); });
                    midH.on('drag', (e) => { const currentLls = layer.getLatLngs(); currentLls[i + 1] = e.target.getLatLng(); layer.setLatLngs(currentLls); updateWalkStats(); });
                    midH.on('dragend', () => { createNodes(layer); fetchElevation(layer.getLatLngs().map(l => [l.lat, l.lng]), false); });
                    nodeHandles.push(midH);
                }
            });
        }

        async function fetchElevation(path, forceOpen) {
            if (elevationAbortController) elevationAbortController.abort(); elevationAbortController = new AbortController(); const signal = elevationAbortController.signal;
            try {
                let sampledPoints = [];
                for (let i = 0; i < path.length - 1; i++) {
                    const start = L.latLng(path[i][0], path[i][1]), end = L.latLng(path[i+1][0], path[i+1][1]), dist = start.distanceTo(end); sampledPoints.push(start);
                    const numSteps = Math.floor(dist / 100); for (let j = 1; j <= numSteps; j++) { const ratio = (j * 100) / dist; sampledPoints.push(L.latLng(start.lat + (end.lat - start.lat) * ratio, start.lng + (end.lng - start.lng) * ratio)); }
                }
                sampledPoints.push(L.latLng(path[path.length - 1][0], path[path.length - 1][1]));
                const res = await fetch('https://api.open-elevation.com/api/v1/lookup', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ locations: sampledPoints.map(p => ({ latitude: p.lat, longitude: p.lng })) }), signal: signal }).then(r=>r.json());
                const elevs = res.results.map(r => r.elevation); 
                
                if (!activeSelectionId && currentMode === 'walk') {
                    if (graphOpen || forceOpen) {
                        const isImp = storage.units === 'imperial';
                        let currentTotal = 0, distData = [0]; for(let i = 1; i < sampledPoints.length; i++){ currentTotal += sampledPoints[i-1].distanceTo(sampledPoints[i]); distData.push(currentTotal / 1000); }
                        document.getElementById('elevation-dock').classList.add('active');
                        const ctx = document.getElementById('elevChart').getContext('2d'); if(chartInstance) chartInstance.destroy();
                        chartInstance = new Chart(ctx, { type:'line', data:{ labels: distData.map(d => isImp ? (d * 0.621371).toFixed(1) : d.toFixed(1)), datasets:[{ data: elevs.map(e => isImp ? e * 3.28084 : e), borderColor:'#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.15)', fill:true, pointRadius:0, borderWidth: 2, tension:0.4, cubicInterpolationMode: 'monotone' }] }, options:{ maintainAspectRatio:false, plugins:{ legend:{display:false} }, scales:{ x:{ title:{display:true, text: isImp ? 'mi' : 'km'} }, y:{ title:{display:true, text: isImp ? 'ft' : 'm'}, position:'right' } } } });
                    }
                    return;
                }

                const item = storage.walks.find(w => w.id === activeSelectionId);
                if (item) item.elevData = elevs; 
                if (graphOpen || forceOpen) {
                    const isImp = storage.units === 'imperial';
                    let currentTotal = 0, distData = [0]; for(let i = 1; i < sampledPoints.length; i++){ currentTotal += sampledPoints[i-1].distanceTo(sampledPoints[i]); distData.push(currentTotal / 1000); }
                    document.getElementById('elevation-dock').classList.add('active');
                    const ctx = document.getElementById('elevChart').getContext('2d'); if(chartInstance) chartInstance.destroy();
                    chartInstance = new Chart(ctx, { type:'line', data:{ labels: distData.map(d => isImp ? (d * 0.621371).toFixed(1) : d.toFixed(1)), datasets:[{ data: elevs.map(e => isImp ? e * 3.28084 : e), borderColor:'#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.15)', fill:true, pointRadius:0, borderWidth: 2, tension:0.4, cubicInterpolationMode: 'monotone' }] }, options:{ maintainAspectRatio:false, plugins:{ legend:{display:false} }, scales:{ x:{ title:{display:true, text: isImp ? 'mi' : 'km'} }, y:{ title:{display:true, text: isImp ? 'ft' : 'm'}, position:'right' } } } });
                }
                if(item) updateWalkStats(); 
            } catch(e) { if (e.name !== 'AbortError') console.error(e); }
        }

        closeElevBtn.onclick = (e) => { L.DomEvent.stopPropagation(e); graphOpen = false; closeElevation(); if(activeSelectionId) updateWalkStats(); };
        function closeElevation() { document.getElementById('elevation-dock').classList.remove('active'); if(document.body.classList.contains('mobile-mode')) { document.getElementById('sidebar').classList.remove('hidden-sheet'); } if(chartInstance) { chartInstance.destroy(); chartInstance = null; } if (elevationAbortController) { elevationAbortController.abort(); elevationAbortController = null; } const btn = document.getElementById('toggleGraphBtn') || document.querySelector('.hud-btn.elev-toggle') || document.getElementById('drawGraphBtn'); if(btn) btn.innerHTML = 'üìà Show Height Graph'; }
        
        function saveData() { 
            localStorage.setItem('geojournal_v11', JSON.stringify({ theme: storage.theme, mapStyle: storage.mapStyle, isMobile: storage.isMobile, units: storage.units, speeds: storage.speeds })); 
        }
        
        async function deleteAction() { 
            if(!activeSelectionId) return;
            const item = storage.pins.find(p=>p.id===activeSelectionId) || storage.walks.find(w=>w.id===activeSelectionId);
            if (item && item.userId !== currentUser.uid) { alert("You can only delete your own items."); return; }
            if(confirm("Delete this entry forever?")){ 
                try {
                    const isWalk = storage.walks.some(w => w.id === activeSelectionId);
                    const collection = isWalk ? "walks" : "pins";
                    await db.collection(collection).doc(activeSelectionId.toString()).delete();
                    storage.pins = storage.pins.filter(p => p.id !== activeSelectionId); 
                    storage.walks = storage.walks.filter(w => w.id !== activeSelectionId); 
                    waypointMarkers.forEach(m => map.removeLayer(m)); waypointMarkers = [];
                    refreshMapItems(); 
                    goBack(); 
                } catch (e) { alert("Delete failed: " + e.message); }
            } 
        }
        
        async function makeAllPrivate() {
            if(!currentUser) return;
            if(!confirm("WARNING: This will make ALL your pins and activities private. They will no longer be visible to other users. This action cannot be easily undone. Continue?")) return;
            
            const myPins = storage.pins.filter(p => p.userId === currentUser.uid);
            for(let p of myPins) {
                p.isPublic = false;
                await saveToCloud('pins', p);
            }
            
            const myWalks = storage.walks.filter(w => w.userId === currentUser.uid);
            for(let w of myWalks) {
                w.isPublic = false;
                await saveToCloud('walks', w);
            }
            
            saveData();
            updateHighlights();
            updateMyLogList();
            alert("All items set to private.");
        }

        function deleteAccount() {
            if(!currentUser) return;
            if(confirm("DANGER: Are you sure you want to delete your account? This will permanently delete your login credentials. Your data may remain unless you delete it first. This action cannot be undone.")) {
                currentUser.delete().then(() => {
                    alert("Account deleted.");
                    location.reload();
                }).catch((error) => {
                    alert("Error deleting account: " + error.message);
                });
            }
        }

        themeToggle.onchange = (e) => { const newTheme = e.target.checked ? 'dark' : 'light'; storage.theme = newTheme; document.body.classList.remove('light-theme', 'dark-theme'); document.body.classList.add(newTheme + '-theme'); saveData(); };
        
        mainSearch.addEventListener('input', (e) => { activeFilters.search = e.target.value; updateHighlights(); });
        mainSearch.addEventListener('keypress', (e) => { if(e.key==='Enter') fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${e.target.value}`).then(r=>r.json()).then(d=>d.length && map.flyTo([d[0].lat, d[0].lon], 15)); });
        
        // AUTH LOGIC
        document.getElementById('btnLogin').onclick = () => {
            const email = document.getElementById('authEmail').value;
            const pass = document.getElementById('authPass').value;
            auth.signInWithEmailAndPassword(email, pass).catch(e => document.getElementById('authMessage').innerText = e.message);
        };

        document.getElementById('btnSignup').onclick = () => {
            const email = document.getElementById('authEmail').value;
            const pass = document.getElementById('authPass').value;
            auth.createUserWithEmailAndPassword(email, pass)
                .then(cred => {
                    cred.user.sendEmailVerification();
                    document.getElementById('authMessage').innerText = "Verification email sent! Please verify and log in.";
                    auth.signOut();
                })
                .catch(e => document.getElementById('authMessage').innerText = e.message);
        };

        document.getElementById('btnGoogle').onclick = () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(e => document.getElementById('authMessage').innerText = e.message);
        };

        document.getElementById('btnForgot').onclick = () => {
            const email = document.getElementById('authEmail').value;
            if(!email) {
                document.getElementById('authMessage').innerText = "Please enter your email address first.";
                return;
            }
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    document.getElementById('authMessage').style.color = 'var(--accent)';
                    document.getElementById('authMessage').innerText = "Reset link sent to email!";
                })
                .catch(e => {
                    document.getElementById('authMessage').style.color = 'var(--danger)';
                    document.getElementById('authMessage').innerText = e.message;
                });
        };

        function signOut() { auth.signOut(); }

        auth.onAuthStateChanged(user => {
            if (user) {
                if (user.emailVerified) {
                    currentUser = user;
                    document.getElementById('userEmailDisplay').innerText = user.email;
                    if (user.displayName) {
                        document.getElementById('settingsDisplayName').value = user.displayName;
                    }
                    document.getElementById('profileRow').style.display = 'flex';
                    document.getElementById('auth-overlay').style.display = 'none';
                    document.body.classList.remove('auth-active');
                    checkUserProfile(user);
                    loadPermanentData();
                } else {
                    document.getElementById('authMessage').innerText = "Please verify your email address to continue.";
                    auth.signOut();
                }
            } else {
                currentUser = null;
                document.getElementById('auth-overlay').style.display = 'flex';
                document.body.classList.add('auth-active');
                loadPermanentData();
            }
        });

        async function checkUserProfile(user) {
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists && userDoc.data().displayName) {
                    currentUser.displayName = userDoc.data().displayName;
                    document.getElementById('settingsDisplayName').value = currentUser.displayName;
                        if(userDoc.data().visitedData) currentUser.visitedData = userDoc.data().visitedData;
                        if(userDoc.data().visitedItems) currentUser.visitedItems = userDoc.data().visitedItems;
                        if(userDoc.data().color) currentUser.color = userDoc.data().color;
                        if(userDoc.data().avatarText) currentUser.avatarText = userDoc.data().avatarText;
                        updateProfileSettingsUI();
                    applyVisitedStatus();
                    updateHighlights();
                    updateMyLogList();
                } else {
                    document.getElementById('dn-overlay').style.display = 'flex';
                }
            } catch(e) { console.error("Profile check failed", e); }
        }

        function updateProfileSettingsUI() {
            const preview = document.getElementById('settingsAvatarPreview');
            const picker = document.getElementById('profileColorPicker');
            const emojiPicker = document.getElementById('profileEmojiPicker');
            const textInput = document.getElementById('avatarTextInput');
            if(!preview || !picker) return;

            const initials = (currentUser.displayName || 'User').substring(0, 2).toUpperCase();
            preview.innerText = currentUser.avatarText || initials;
            preview.style.background = currentUser.color || 'linear-gradient(135deg, var(--primary), var(--accent))';

            if(textInput) {
                textInput.value = currentUser.avatarText || '';
                textInput.oninput = (e) => { preview.innerText = e.target.value || initials; };
                textInput.onchange = (e) => { saveAvatarText(e.target.value); };
            }

            if(emojiPicker) {
                emojiPicker.innerHTML = '';
                BASIC_EMOJIS.forEach(e => {
                    const span = document.createElement('span');
                    span.className = 'emoji-option';
                    span.innerText = e;
                    span.onclick = () => {
                        if(textInput) textInput.value = e;
                        preview.innerText = e;
                        saveAvatarText(e);
                    };
                    emojiPicker.appendChild(span);
                });
                
                // Add "More" button
                const moreBtn = document.createElement('span');
                moreBtn.className = 'emoji-option';
                moreBtn.innerText = '‚ûï';
                moreBtn.style.background = 'var(--primary)';
                moreBtn.style.color = 'white';
                moreBtn.onclick = openEmojiModal;
                emojiPicker.appendChild(moreBtn);
            }

            picker.innerHTML = '';
            AVATAR_COLORS.forEach(c => {
                const dot = document.createElement('div');
                dot.className = 'color-dot';
                dot.style.background = c;
                if(currentUser.color === c) dot.classList.add('active');
                dot.onclick = () => saveProfileColor(c);
                picker.appendChild(dot);
            });
        }

        function openEmojiModal() {
            const grid = document.getElementById('fullEmojiGrid');
            grid.innerHTML = '';
            ALL_EMOJIS.forEach(e => {
                const span = document.createElement('span');
                span.className = 'emoji-option';
                span.style.width = '100%';
                span.style.height = '40px';
                span.style.fontSize = '20px';
                span.innerText = e;
                span.onclick = () => {
                    const textInput = document.getElementById('avatarTextInput');
                    const preview = document.getElementById('settingsAvatarPreview');
                    if(textInput) textInput.value = e;
                    if(preview) preview.innerText = e;
                    saveAvatarText(e);
                    document.getElementById('emoji-modal-overlay').style.display = 'none';
                };
                grid.appendChild(span);
            });
            document.getElementById('emoji-modal-overlay').style.display = 'flex';
        }

        async function saveAvatarText(text) {
            if(!currentUser) return;
            currentUser.avatarText = text;
            await db.collection('users').doc(currentUser.uid).set({ avatarText: text }, { merge: true });
            if(activeSelectionId) {
                const item = storage.pins.find(p=>p.id===activeSelectionId) || storage.walks.find(w=>w.id===activeSelectionId);
                if(item) renderComments(item);
            }
        }

        async function saveDisplayName(isInitial) {
            const inputId = isInitial ? 'newDisplayName' : 'settingsDisplayName';
            const errId = isInitial ? 'dnError' : null;
            const name = document.getElementById(inputId).value.trim();
            
            if(name.length < 3) {
                if(errId) document.getElementById(errId).innerText = "Name must be at least 3 characters.";
                else alert("Name must be at least 3 characters.");
                return;
            }

            const snapshot = await db.collection('users').where('displayName', '==', name).get();
            if(!snapshot.empty) {
                const existing = snapshot.docs[0];
                if(existing.id !== currentUser.uid) {
                    if(errId) document.getElementById(errId).innerText = "This name is already taken.";
                    else alert("This name is already taken.");
                    return;
                }
            }

            await db.collection('users').doc(currentUser.uid).set({
                displayName: name,
                email: currentUser.email,
                lowerName: name.toLowerCase()
            }, { merge: true });

            try { await currentUser.updateProfile({ displayName: name }); } catch(e) {}

            currentUser.displayName = name;
            updateHighlights();
            updateMyLogList();
            if(activeSelectionId) {
                const item = storage.pins.find(p=>p.id===activeSelectionId) || storage.walks.find(w=>w.id===activeSelectionId);
                if(item) { 
                    renderComments(item); 
                    if(item.userId === currentUser.uid) document.getElementById('detCreator').innerText = `Uploaded by ${name}`; 
                }
            }

            if(isInitial) {
                document.getElementById('dn-overlay').style.display = 'none';
                document.getElementById('settingsDisplayName').value = name;
            } else {
                alert("Display Name Updated!");
            }
        }

        async function saveProfileColor(color) {
            if(!currentUser) return;
            currentUser.color = color;
            updateProfileSettingsUI();
            
            await db.collection('users').doc(currentUser.uid).set({ color: color }, { merge: true });
            
            // Refresh comments if any are visible
            if(activeSelectionId) {
                const item = storage.pins.find(p=>p.id===activeSelectionId) || storage.walks.find(w=>w.id===activeSelectionId);
                if(item) renderComments(item);
            }
        }

        document.getElementById('saveDNBtn').onclick = () => saveDisplayName(true);
        document.getElementById('updateDNBtn').onclick = () => saveDisplayName(false);

        function updateMyLogList() {
            const savedList = document.getElementById('my-saved-list');
            const loggedList = document.getElementById('my-logged-list');
            if (!savedList || !loggedList) return;
            if (!currentUser) { savedList.innerHTML = '<p style="font-size:12px;opacity:0.5;text-align:center;margin-top:20px;">Please log in to view your log.</p>'; loggedList.innerHTML = '<p style="font-size:12px;opacity:0.5;text-align:center;margin-top:20px;">Please log in to view your log.</p>'; return; }
            
            // 1. Created Items (My Log)
            let createdItems = [
                ...storage.pins.filter(p => p.userId === currentUser.uid).map(p => ({...p, type:'PIN'})), 
                ...storage.walks.filter(w => w.userId === currentUser.uid).map(w => ({...w, type:'WALK', lat:w.path[0][0], lng:w.path[0][1]}))
            ];
            
            createdItems = createdItems.filter(i => {
                if (myLogFilters.privacy !== 'all') {
                    if (myLogFilters.privacy === 'public' && !i.isPublic) return false;
                    if (myLogFilters.privacy === 'private' && i.isPublic) return false;
                }

                if (i.type === 'PIN') {
                    if (!myLogFilters.showPins) return false;
                    const cat = PIN_TYPES.find(t => t.color === i.color);
                    return cat && myLogFilters.categories.includes(cat.name);
                }
                if (i.type === 'WALK') {
                    if (!myLogFilters.showWalks) return false;
                    return myLogFilters.activities.includes(i.activity || 'walk');
                }
                return true;
            });

            if (userPos) createdItems.forEach(i => i.d = L.latLng(i.lat, i.lng).distanceTo(userPos) / 1000);
            
            if (myLogFilters.sort === 'rating') {
                createdItems.sort((a,b) => {
                    const r = (b.rating || 0) - (a.rating || 0);
                    return r !== 0 ? r : (b.id - a.id);
                });
            }
            else if (myLogFilters.sort === 'dist') {
                createdItems.sort((a,b) => {
                    const dist = (a.d || 0) - (b.d || 0);
                    return dist !== 0 ? dist : (b.id - a.id);
                });
            }
            else if (myLogFilters.sort === 'date') createdItems.sort((a,b) => b.id - a.id);
            
            // Update Map if on You Tab
            if (currentTab === 'add') {
                mapItems.clearLayers();
                createdItems.forEach(i => {
                    if (i.type === 'PIN') addPin(i);
                    else if (i.type === 'WALK') addWalk(i);
                });
            }

            // 2. Visited Items (Logged) - Can include items not created by me
            let loggedItems = [
                ...storage.pins.filter(p => p.visited).map(p => ({...p, type:'PIN'})),
                ...storage.walks.filter(w => w.visited).map(w => ({...w, type:'WALK', lat:w.path[0][0], lng:w.path[0][1]}))
            ];
            loggedItems.sort((a,b) => (b.visitedDate || 0) - (a.visitedDate || 0));

            renderLogList(createdItems, savedList, "No created items.", false, false);
            renderLogList(loggedItems, loggedList, "No logged items.", true, true);
        }

        function renderLogList(all, list, emptyMsg, hideVisibility = false, showVisitedDate = true) {
            list.innerHTML = all.length ? '' : `<p style="font-size:12px;opacity:0.5;text-align:center;margin-top:10px;margin-bottom:10px;">${emptyMsg}</p>`;
            all.forEach(i => {
                const div = document.createElement('div'); div.className = 'highlight-item'; div.style.borderLeft = `4px solid ${i.color || '#2563eb'}`;
                let labelText = '', labelColor = i.color || '#2563eb', iconChar = 'üìç';
                if (i.type === 'WALK') {
                    iconChar = i.activity === 'cycle' ? 'üö≤' : (i.activity === 'run' ? '‚ö°' : (i.activity === 'hike' ? 'ü•æ' : 'üö∂'));
                    labelText = i.activity ? i.activity.toUpperCase() : 'WALK';
                    labelColor = ACTIVITY_COLORS[i.activity] || '#2563eb';
                } else {
                    const category = PIN_TYPES.find(t => t.color === i.color);
                    labelText = category ? category.name.toUpperCase() : 'PIN';
                    iconChar = category ? category.icon : 'üìç';
                }
                
                let visibilityLabel = '';
                if (!hideVisibility) {
                    visibilityLabel = i.isPublic ? `<span class="type-label" style="background:#10b981;">PUBLIC</span>` : `<span class="type-label" style="background:#ef4444;">PRIVATE</span>`;
                }
                
                const thumb = (i.photos && i.photos.length > 0) ? i.photos[0] : (i.photo || 'https://placehold.co/100x100?text=No+Photo');
                
                let thumbHtml = `<img class="highlight-thumb" src="${thumb}">`;
                if (i.type === 'WALK' && i.path) {
                    thumbHtml = getRouteThumbnail(i.path, i.color || '#2563eb');
                }

                const dateStr = formatDate(i.id);
                const visitedDateStr = i.visitedDate ? formatDate(i.visitedDate) : '';

                let ratingHtml = '';
                if (i.rating > 0) {
                    ratingHtml = `<span style="display:inline-block; background:rgba(251, 191, 36, 0.15); color:#fbbf24; font-weight:800; padding:2px 6px; border-radius:4px; font-size:10px;">‚òÖ ${i.rating.toFixed(1)}</span>`;
                }

                const visitedLabel = i.visited ? `<div class="visited-check-corner">‚úì</div>` : '';
                const dateDisplay = (showVisitedDate && i.visited && i.visitedDate) ? `<span style="color:var(--accent); font-weight:700;">Visited on: ${visitedDateStr}</span>` : `<span style="opacity:0.7;">${dateStr}</span>`;

                div.innerHTML = `${thumbHtml}<div style="flex:1; min-width:0;"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;"><span class="type-label" style="background:${labelColor}">${iconChar} ${labelText}</span>${visibilityLabel}</div><p style="font-weight:bold; font-size:13px; margin:0 0 6px 0; line-height:1.2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${i.name}</p><div style="display:flex; align-items:center; gap:8px; font-size:11px; color:var(--text); opacity:0.8;">${ratingHtml}${dateDisplay}${i.d ? ` ‚Ä¢ ${formatDist(i.d)}` : ''}</div></div>${visitedLabel}`;
                div.onclick = () => { 
                    const obj = i.type === 'PIN' ? storage.pins.find(p=>p.id===i.id) : storage.walks.find(w=>w.id===i.id); 
                    if(i.type === 'WALK' && obj.path) {
                        const poly = L.polyline(obj.path);
                        const sidePadding = document.body.classList.contains('mobile-mode') ? 20 : (parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidebar')) + 40);
                        const bottomPadding = document.body.classList.contains('mobile-mode') ? (window.innerHeight / 2) : 40;
                        map.flyToBounds(poly.getBounds(), { paddingBottomRight: [sidePadding, bottomPadding], paddingTopLeft: [20, 20], duration: 1.5 });
                        showDetails(obj, true, null); 
                    } else { map.flyTo([i.lat, i.lng], 15); showDetails(obj, false, null); }
                };
                list.appendChild(div);
            });
        }

        switchTab('explore');

        function encodePolyline(path) {
            let str = '';
            let lastLat = 0;
            let lastLng = 0;
            const step = Math.max(1, Math.floor(path.length / 60));
            const addPoint = (lat, lng) => {
                const numLat = Math.round(lat * 1e5); const numLng = Math.round(lng * 1e5);
                const dLat = numLat - lastLat; const dLng = numLng - lastLng;
                lastLat = numLat; lastLng = numLng;
                str += encodeValue(dLat) + encodeValue(dLng);
            };
            for (let i = 0; i < path.length; i += step) addPoint(parseFloat(path[i][0]), parseFloat(path[i][1]));
            if ((path.length - 1) % step !== 0) addPoint(parseFloat(path[path.length - 1][0]), parseFloat(path[path.length - 1][1]));
            return str;
        }

        function encodeValue(val) {
            let num = val < 0 ? ~(val << 1) : (val << 1);
            let str = '';
            while (num >= 0x20) { str += String.fromCharCode((0x20 | (num & 0x1f)) + 63); num >>= 5; }
            str += String.fromCharCode(num + 63);
            return str;
        }
    </script>
</body>
</html>
